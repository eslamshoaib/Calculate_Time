<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>محلل الرقم القومي المصري</title>
<script src="https://unpkg.com/tesseract.js@4.1.1/dist/tesseract.min.js"></script>
<style>
body { font-family: Arial; background:#f0f0f0; text-align:center; padding:20px; }
.container { background:#fff; padding:20px; border-radius:10px; max-width:500px; margin:auto; }
input,button { padding:10px; margin:5px; width:90%; font-size:16px; }
img { max-width:100%; margin-top:10px; border:1px solid #ccc; }
.result { text-align:right; margin-top:15px; background:#fafafa; padding:10px; border-radius:5px; }
</style>
</head>
<body>
<div class="container">
<h2>📋 محلل الرقم القومي المصري</h2>

<input type="file" id="fileInput" accept="image/*">
<button onclick="processImage()">📷 قراءة من صورة</button>
<br>
<input type="text" id="nationalID" placeholder="أدخل الرقم القومي (14 رقم)">
<button onclick="analyzeID()">تحليل الرقم القومي</button>

<img id="preview" style="display:none;">
<div id="status"></div>
<div class="result" id="result"></div>
</div>

<script>
// تحويل الأرقام العربية الشرقية إلى إنجليزية
function convertArabicNums(str) {
    const map = {'٠':'0','١':'1','٢':'2','٣':'3','٤':'4','٥':'5','٦':'6','٧':'7','٨':'8','٩':'9'};
    return str.replace(/[٠-٩]/g, d => map[d]);
}

// تحليل الرقم القومي
function analyzeID() {
    let id = convertArabicNums(document.getElementById('nationalID').value.trim());
    if (!/^[23]\d{13}$/.test(id)) {
        document.getElementById('result').innerHTML = "❌ رقم قومي غير صالح";
        return;
    }
    const century = id[0] === '2' ? '19' : '20';
    const year = parseInt(id.substr(1,2));
    const month = parseInt(id.substr(3,2));
    const day = parseInt(id.substr(5,2));
    const birthDate = new Date(`${century}${year}-${month}-${day}`);
    const today = new Date();
    let ageY = today.getFullYear()-birthDate.getFullYear();
    let ageM = today.getMonth()-birthDate.getMonth();
    let ageD = today.getDate()-birthDate.getDate();
    if(ageD<0){ageM--;ageD+=new Date(today.getFullYear(),today.getMonth(),0).getDate();}
    if(ageM<0){ageY--;ageM+=12;}
    const gender = parseInt(id[12])%2===0 ? 'أنثى' : 'ذكر';
    const govs = {"01":"القاهرة","02":"الإسكندرية","03":"بورسعيد","04":"السويس","11":"دمياط","12":"الدقهلية","13":"الشرقية","14":"القليوبية","15":"كفر الشيخ","16":"الغربية","17":"المنوفية","18":"البحيرة","19":"الإسماعيلية","21":"الجيزة","22":"بني سويف","23":"الفيوم","24":"الأقصر","25":"سوهاج","26":"قنا","27":"أسوان","28":"أسيوط","29":"مطروح","31":"شمال سيناء","32":"جنوب سيناء","33":"البحر الأحمر","88":"خارج الجمهورية"};
    const gov = govs[id.substr(7,2)] || "غير معروف";
    document.getElementById('result').innerHTML =
        `<b>📅 تاريخ الميلاد:</b> ${birthDate.toLocaleDateString('ar-EG')}<br>
         <b>🎂 العمر:</b> ${ageY} سنة و ${ageM} شهر و ${ageD} يوم<br>
         <b>🚻 الجنس:</b> ${gender}<br>
         <b>📍 المحافظة:</b> ${gov}`;
}

// قراءة الرقم القومي من صورة
function processImage() {
    const file = document.getElementById('fileInput').files[0];
    if (!file) return alert("اختر صورة أولاً");
    const reader = new FileReader();
    reader.onload = function(e) {
        document.getElementById('preview').src = e.target.result;
        document.getElementById('preview').style.display = 'block';
        document.getElementById('status').innerText = "⏳ جاري التعرف على النص...";
        Tesseract.recognize(e.target.result, 'ara+eng', {
            logger: m => { if(m.status==="recognizing text"){document.getElementById('status').innerText = `⏳ ${Math.round(m.progress*100)}%`;}}
        }).then(({data:{text}})=>{
            const clean = convertArabicNums(text).replace(/\D/g,'');
            const match = clean.match(/[23]\d{13}/);
            if(match){
                document.getElementById('nationalID').value = match[0];
                document.getElementById('status').innerText = "✅ تم الاستخراج";
                analyzeID();
            } else {
                document.getElementById('status').innerText = "❌ لم يتم العثور على رقم قومي";
            }
        });
    };
    reader.readAsDataURL(file);
}
</script>
</body>
</html>
