<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>ğŸ“‹ </title>
<script src="https://docs.opencv.org/4.8.0/opencv.js"></script>
<script src="https://unpkg.com/tesseract.js@4.1.1/dist/tesseract.min.js"></script>
<style>
body { font-family: Arial; background:#f0f0f0; text-align:center; padding:20px; }
.container { background:#fff; padding:20px; border-radius:10px; max-width:600px; margin:auto; }
input,button { padding:10px; margin:5px; width:90%; font-size:16px; }
canvas,img { max-width:100%; margin-top:10px; border:1px solid #ccc; }
.result { text-align:right; margin-top:15px; background:#fafafa; padding:10px; border-radius:5px; }
</style>
</head>
<body>
<div class="container">
<h2>ğŸ“‹ </h2>

<input type="file" id="fileInput" accept="image/*">
<canvas id="canvas"></canvas>
<br>
<button onclick="cropSelection()">ğŸ“</button>

<div id="status"></div>
<div class="result" id="result"></div>
</div>

<script>
let img = new Image();
let canvas = document.getElementById('canvas');
let ctx = canvas.getContext('2d');
let startX, startY, endX, endY, isSelecting = false;

document.getElementById('fileInput').addEventListener('change', e=>{
    let file = e.target.files[0];
    if(!file) return;
    let reader = new FileReader();
    reader.onload = ev => {
        img.onload = () => {
            canvas.width = img.width;
            canvas.height = img.height;
            ctx.drawImage(img,0,0);
        };
        img.src = ev.target.result;
    };
    reader.readAsDataURL(file);
});

// Ø±Ø³Ù… Ù…Ø±Ø¨Ø¹ Ø§Ù„ØªØ­Ø¯ÙŠØ¯
canvas.addEventListener('mousedown', e=>{
    let rect = canvas.getBoundingClientRect();
    startX = e.clientX - rect.left;
    startY = e.clientY - rect.top;
    isSelecting = true;
});
canvas.addEventListener('mousemove', e=>{
    if(!isSelecting) return;
    let rect = canvas.getBoundingClientRect();
    endX = e.clientX - rect.left;
    endY = e.clientY - rect.top;
    ctx.drawImage(img,0,0);
    ctx.strokeStyle="red"; ctx.lineWidth=2;
    ctx.strokeRect(startX,startY,endX-startX,endY-startY);
});
canvas.addEventListener('mouseup', ()=> isSelecting = false);

// ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ø´Ø±Ù‚ÙŠØ©
function convertArabicNums(str) {
    const map = {'Ù ':'0','Ù¡':'1','Ù¢':'2','Ù£':'3','Ù¤':'4','Ù¥':'5','Ù¦':'6','Ù§':'7','Ù¨':'8','Ù©':'9'};
    return str.replace(/[Ù -Ù©]/g, d => map[d]);
}

// Ù‚Øµ ÙˆÙ…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
function cropSelection(){
    if(startX===undefined || startY===undefined || endX===undefined || endY===undefined){
        alert("Ø­Ø¯Ø¯ Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ Ø£ÙˆÙ„Ø§Ù‹"); return;
    }
    let w = endX-startX, h = endY-startY;
    let cropCanvas = document.createElement('canvas');
    cropCanvas.width = w; cropCanvas.height = h;
    let cropCtx = cropCanvas.getContext('2d');
    cropCtx.drawImage(canvas, startX, startY, w, h, 0, 0, w, h);

    // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¨Ø§Ù„ØµÙˆØ±Ø© Ø¨Ù€ OpenCV
    let src = cv.imread(cropCanvas);
    cv.cvtColor(src, src, cv.COLOR_RGBA2GRAY, 0);
    cv.threshold(src, src, 120, 255, cv.THRESH_BINARY);
    cv.GaussianBlur(src, src, new cv.Size(1,1), 0, 0, cv.BORDER_DEFAULT);
    cv.imshow(cropCanvas, src);
    src.delete();

    document.getElementById('status').innerText = "â³ Ø¬Ø§Ø±ÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø±Ù‚Ù…...";
    Tesseract.recognize(cropCanvas.toDataURL(), 'ara+eng', {
        logger: m => { if(m.status==="recognizing text"){document.getElementById('status').innerText = `â³ ${Math.round(m.progress*100)}%`;}}
    }).then(({data:{text}})=>{
        const clean = convertArabicNums(text).replace(/\D/g,'');
        const match = clean.match(/[23]\d{13}/);
        if(match){
            document.getElementById('status').innerText = "âœ… ØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø±Ù‚Ù…";
            analyzeID(match[0]);
        } else {
            document.getElementById('status').innerText = "âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø±Ù‚Ù… Ù‚ÙˆÙ…ÙŠ";
        }
    });
}

// ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ
function analyzeID(id){
    const century = id[0] === '2' ? '19' : '20';
    const year = parseInt(id.substr(1,2));
    const month = parseInt(id.substr(3,2));
    const day = parseInt(id.substr(5,2));
    const birthDate = new Date(`${century}${year}-${month}-${day}`);
    const today = new Date();
    let ageY = today.getFullYear()-birthDate.getFullYear();
    let ageM = today.getMonth()-birthDate.getMonth();
    let ageD = today.getDate()-birthDate.getDate();
    if(ageD<0){ageM--;ageD+=new Date(today.getFullYear(),today.getMonth(),0).getDate();}
    if(ageM<0){ageY--;ageM+=12;}
    const gender = parseInt(id[12])%2===0 ? 'Ø£Ù†Ø«Ù‰' : 'Ø°ÙƒØ±';
    const govs = {"01":"Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©","02":"Ø§Ù„Ø¥Ø³ÙƒÙ†Ø¯Ø±ÙŠØ©","03":"Ø¨ÙˆØ±Ø³Ø¹ÙŠØ¯","04":"Ø§Ù„Ø³ÙˆÙŠØ³","11":"Ø¯Ù…ÙŠØ§Ø·","12":"Ø§Ù„Ø¯Ù‚Ù‡Ù„ÙŠØ©","13":"Ø§Ù„Ø´Ø±Ù‚ÙŠØ©","14":"Ø§Ù„Ù‚Ù„ÙŠÙˆØ¨ÙŠØ©","15":"ÙƒÙØ± Ø§Ù„Ø´ÙŠØ®","16":"Ø§Ù„ØºØ±Ø¨ÙŠØ©","17":"Ø§Ù„Ù…Ù†ÙˆÙÙŠØ©","18":"Ø§Ù„Ø¨Ø­ÙŠØ±Ø©","19":"Ø§Ù„Ø¥Ø³Ù…Ø§Ø¹ÙŠÙ„ÙŠØ©","21":"Ø§Ù„Ø¬ÙŠØ²Ø©","22":"Ø¨Ù†ÙŠ Ø³ÙˆÙŠÙ","23":"Ø§Ù„ÙÙŠÙˆÙ…","24":"Ø§Ù„Ø£Ù‚ØµØ±","25":"Ø³ÙˆÙ‡Ø§Ø¬","26":"Ù‚Ù†Ø§","27":"Ø£Ø³ÙˆØ§Ù†","28":"Ø£Ø³ÙŠÙˆØ·","29":"Ù…Ø·Ø±ÙˆØ­","31":"Ø´Ù…Ø§Ù„ Ø³ÙŠÙ†Ø§Ø¡","32":"Ø¬Ù†ÙˆØ¨ Ø³ÙŠÙ†Ø§Ø¡","33":"Ø§Ù„Ø¨Ø­Ø± Ø§Ù„Ø£Ø­Ù…Ø±","88":"Ø®Ø§Ø±Ø¬ Ø§Ù„Ø¬Ù…Ù‡ÙˆØ±ÙŠØ©"};
    const gov = govs[id.substr(7,2)] || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
    document.getElementById('result').innerHTML =
        `<b>ğŸ“„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ:</b> ${id}<br>
         <b>ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯:</b> ${birthDate.toLocaleDateString('ar-EG')}<br>
         <b>ğŸ‚ Ø§Ù„Ø¹Ù…Ø±:</b> ${ageY} Ø³Ù†Ø© Ùˆ ${ageM} Ø´Ù‡Ø± Ùˆ ${ageD} ÙŠÙˆÙ…<br>
         <b>ğŸš» Ø§Ù„Ø¬Ù†Ø³:</b> ${gender}<br>
         <b>ğŸ“ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©:</b> ${gov}`;
}
</script>
</body>
</html>
