<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üåç </title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src='https://unpkg.com/tesseract.js@4.1.1/dist/tesseract.min.js'></script>
    <style>
        :root {
            --primary-color: #4a6fa5;
            --secondary-color: #ff7e5f;
            --accent-color: #6b48ff;
            --text-dark: #2c3e50;
            --text-light: #f8f9fa;
            --gradient-bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--gradient-bg);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            direction: rtl;
            color: var(--text-dark);
            background-attachment: fixed;
            background-size: cover;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 600px;
            text-align: center;
            margin: 20px 0;
        }
        
        h1 {
            color: var(--primary-color);
            margin-bottom: 20px;
            font-size: 24px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--secondary-color);
        }
        
        .input-group {
            margin: 15px 0;
            position: relative;
        }
        
        .input-group i {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            left: 15px;
            color: var(--primary-color);
        }
        
        select, input, button {
            width: 100%;
            padding: 12px 15px 12px 40px;
            margin: 8px 0;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        select:focus, input:focus, button:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(74, 111, 165, 0.2);
        }
        
        button {
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            padding: 12px;
            margin-top: 10px;
        }
        
        button:hover, button:focus {
            background: linear-gradient(135deg, var(--accent-color), var(--primary-color));
        }
        
        .error {
            color: #ff6b6b;
            font-size: 14px;
            margin-top: 5px;
            text-align: right;
        }
        
        .date-picker {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }
        
        .date-picker label {
            display: block;
            margin-bottom: 8px;
            color: var(--primary-color);
            font-weight: 600;
        }
        
        .popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .popup-title {
            color: var(--primary-color);
            font-size: 20px;
        }
        
        .popup table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        
        .popup th, .popup td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: center;
        }
        
        .popup th {
            background-color: var(--primary-color);
            color: white;
        }
        
        .close-btn {
            background: transparent;
            color: #ff6b6b;
            border: none;
            font-size: 20px;
            cursor: pointer;
        }
        
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }
        
        .section {
            margin-bottom: 25px;
        }
        
        [tabindex]:focus {
            outline: 2px solid var(--accent-color);
            outline-offset: 2px;
        }
        
        /* ŸÖŸäÿ≤ÿßÿ™ ÿ¨ÿØŸäÿØÿ© ŸÑÿ±ŸÅÿπ ÿßŸÑÿµŸàÿ± */
        .image-upload {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border: 2px dashed #ccc;
            transition: all 0.3s;
        }
        
        .image-upload:hover {
            border-color: var(--primary-color);
        }
        
        .image-upload.dragover {
            background-color: rgba(74, 111, 165, 0.1);
            border-color: var(--primary-color);
        }
        
        .upload-area {
            padding: 20px;
            text-align: center;
            cursor: pointer;
        }
        
        .upload-area i {
            font-size: 40px;
            color: var(--primary-color);
            margin-bottom: 10px;
        }
        
        .upload-area p {
            margin: 5px 0;
            color: var(--text-dark);
        }
        
        #imagePreview {
            max-width: 100%;
            max-height: 200px;
            margin: 10px auto;
            display: none;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .progress-container {
            width: 100%;
            background-color: #e0e0e0;
            border-radius: 5px;
            margin: 10px 0;
            display: none;
        }
        
        .progress-bar {
            height: 10px;
            background-color: var(--primary-color);
            border-radius: 5px;
            width: 0%;
            transition: width 0.3s;
        }
        
        .status-message {
            margin-top: 10px;
            font-size: 14px;
            color: var(--primary-color);
            display: none;
        }
        
        .extracted-id {
            background-color: rgba(74, 111, 165, 0.1);
            border: 1px solid var(--primary-color);
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            color: var(--primary-color);
            display: none;
        }
        
        /* ÿ™ÿ≠ÿ≥ŸäŸÜÿßÿ™ ŸÑŸÑÿπÿ±ÿ∂ ÿπŸÑŸâ ÿßŸÑÿ¥ÿßÿ¥ÿßÿ™ ÿßŸÑÿµÿ∫Ÿäÿ±ÿ© */
        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            
            .container {
                padding: 15px;
            }
            
            h1 {
                font-size: 20px;
            }
            
            select, input, button {
                padding: 10px 10px 10px 35px;
                font-size: 14px;
            }
        }
        
        /* ÿ•ÿ∂ÿßŸÅÿ© ÿÆŸäÿßÿ±ÿßÿ™ ÿßŸÑŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑŸÖÿ≥ÿ®ŸÇÿ© */
        .preprocessing-options {
            margin: 15px 0;
            text-align: right;
            background: rgba(74, 111, 165, 0.05);
            padding: 10px;
            border-radius: 8px;
        }
        
        .preprocessing-options label {
            display: flex;
            align-items: center;
            margin: 8px 0;
            cursor: pointer;
        }
        
        .preprocessing-options input[type="checkbox"] {
            width: auto;
            margin-left: 10px;
        }
        
        /* ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÜÿ∑ŸÇÿ© ÿ™ÿ≠ÿØŸäÿØ ŸäÿØŸàŸä */
        .manual-selection {
            margin: 15px 0;
            display: none;
        }
        
        .selection-canvas {
            border: 2px solid var(--primary-color);
            border-radius: 8px;
            max-width: 100%;
            cursor: crosshair;
        }
        
        .selection-controls {
            margin-top: 10px;
            display: flex;
            justify-content: space-between;
        }
        
        .selection-controls button {
            width: 48%;
        }
    </style>
</head>
<body>
<div class="container" tabindex="0">
    <h1><i class="fas fa-id-card"></i> üåç ŸÖÿ≠ŸÑŸÑ ÿßŸÑÿ±ŸÇŸÖ ÿßŸÑŸÇŸàŸÖŸä ÿßŸÑŸÖÿµÿ±Ÿä</h1>
    
    <div class="section">
        <div class="input-group">
            <i class="fas fa-language"></i>
            <select id="language" onchange="changeLanguage()" tabindex="1">
                <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ© üá™üá¨</option>
                <option value="en">English üá¨üáß</option>
            </select>
        </div>
    </div>
    
    <div class="section">
        <div class="image-upload" id="imageUpload">
            <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                <i class="fas fa-cloud-upload-alt"></i>
                <p id="uploadText">ÿßŸÜŸÇÿ± ŸÑÿ±ŸÅÿπ ÿµŸàÿ±ÿ© ÿßŸÑÿ®ÿ∑ÿßŸÇÿ© ÿßŸÑÿ¥ÿÆÿµŸäÿ© ÿ£Ÿà ÿßÿ≥ÿ≠ÿ® ÿßŸÑÿµŸàÿ±ÿ© ŸáŸÜÿß</p>
                <p style="font-size: 12px; color: #777;">(PNG, JPG, JPEG)</p>
            </div>
            <input type="file" id="fileInput" accept="image/*" style="display: none;" onchange="handleFileSelect(event)">
            <img id="imagePreview" alt="ŸÖÿπÿßŸäŸÜÿ© ÿßŸÑÿµŸàÿ±ÿ©">
            
            <div class="preprocessing-options">
                <label>
                    <input type="checkbox" id="grayscale" checked>
                    <span id="grayscaleLabel">ÿ™ÿ≠ŸàŸäŸÑ ÿ•ŸÑŸâ ÿ™ÿØÿ±ÿ¨ ÿßŸÑÿ±ŸÖÿßÿØŸä</span>
                </label>
                <label>
                    <input type="checkbox" id="contrast" checked>
                    <span id="contrastLabel">ÿ≤ŸäÿßÿØÿ© ÿßŸÑÿ™ÿ®ÿßŸäŸÜ</span>
                </label>
                <label>
                    <input type="checkbox" id="binarize">
                    <span id="binarizeLabel">ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿπÿ™ÿ®ÿ© ÿßŸÑÿ´ŸÜÿßÿ¶Ÿäÿ©</span>
                </label>
                <label>
                    <input type="checkbox" id="manualSelect">
                    <span id="manualSelectLabel">ÿ™ÿ≠ÿØŸäÿØ ŸÖŸÜÿ∑ŸÇÿ© ÿßŸÑÿ±ŸÇŸÖ ŸäÿØŸàŸäŸãÿß</span>
                </label>
            </div>
            
            <div class="manual-selection" id="manualSelection">
                <canvas id="selectionCanvas" class="selection-canvas"></canvas>
                <div class="selection-controls">
                    <button onclick="resetSelection()" id="resetSelectionBtn">ÿ•ÿπÿßÿØÿ© ÿßŸÑÿ™ÿ≠ÿØŸäÿØ</button>
                    <button onclick="processSelectedArea()" id="processSelectedBtn">ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© ÿßŸÑŸÖÿ≠ÿØÿØÿ©</button>
                </div>
            </div>
            
            <div class="progress-container" id="progressContainer">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            <div class="status-message" id="statusMessage"></div>
            <div class="extracted-id" id="extractedId"></div>
            <button id="analyzeFromImageBtn" onclick="analyzeFromExtractedID()" style="display: none;">
                <i class="fas fa-search"></i> <span id="analyzeImageBtnText">ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ±ŸÇŸÖ ÿßŸÑŸÇŸàŸÖŸä ÿßŸÑŸÖÿ≥ÿ™ÿÆÿ±ÿ¨</span>
            </button>
        </div>
    </div>
    
    <div class="section">
        <div class="input-group">
            <i class="fas fa-fingerprint"></i>
            <input type="text" id="nationalID" placeholder="ÿ£ÿØÿÆŸÑ ÿßŸÑÿ±ŸÇŸÖ ÿßŸÑŸÇŸàŸÖŸä ŸáŸÜÿß (14 ÿ±ŸÇŸÖŸãÿß)..." 
                   maxlength="14" oninput="validateNationalID(this)" tabindex="2">
        </div>
        <div id="idError" class="error"></div>
        <button onclick="analyzeNationalID()" tabindex="3">
            <i class="fas fa-search"></i> <span id="analyzeBtnText">ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ±ŸÇŸÖ ÿßŸÑŸÇŸàŸÖŸä</span>
        </button>
    </div>
    
    <div class="section">
        <div class="date-picker">
            <label for="dob"><i class="fas fa-birthday-cake"></i> <span id="dobLabel">ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸÖŸäŸÑÿßÿØ:</span></label>
            <div class="input-group">
                <i class="fas fa-calendar-alt"></i>
                <input type="text" id="dob" placeholder="ŸäŸàŸÖ-ÿ¥Ÿáÿ±-ÿ≥ŸÜÿ© (ŸÖÿ´ÿßŸÑ: 15-08-1990)" 
                       oninput="validateDateInput(this)" tabindex="4">
            </div>
            <div id="dobError" class="error"></div>
            <button onclick="calculateAge()" tabindex="5">
                <i class="fas fa-calculator"></i> <span id="ageBtnText">ÿßÿ≠ÿ≥ÿ® ÿßŸÑÿπŸÖÿ±</span>
            </button>
        </div>
    </div>
    
    <div class="section">
        <div class="date-picker">
            <label><i class="fas fa-calendar-check"></i> <span id="dateDiffLabel">ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÅÿ±ŸÇ ÿ®ŸäŸÜ ÿ™ÿßÿ±ŸäÿÆŸäŸÜ:</span></label>
            
            <label for="date1"><span id="date1Label">ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ£ŸàŸÑ:</span></label>
            <div class="input-group">
                <i class="fas fa-calendar-alt"></i>
                <input type="text" id="date1" placeholder="ŸäŸàŸÖ-ÿ¥Ÿáÿ±-ÿ≥ŸÜÿ©" 
                       oninput="validateDateInput(this)" tabindex="6">
            </div>
            
            <label for="date2"><span id="date2Label">ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ´ÿßŸÜŸä:</span></label>
            <div class="input-group">
                <i class="fas fa-calendar-alt"></i>
                <input type="text" id="date2" placeholder="ŸäŸàŸÖ-ÿ¥Ÿáÿ±-ÿ≥ŸÜÿ©" 
                       oninput="validateDateInput(this)" tabindex="7">
            </div>
            
            <div id="dateError" class="error"></div>
            <button onclick="calculateDateDifference()" tabindex="8">
                <i class="fas fa-clock"></i> <span id="dateDiffBtnText">ÿßÿ≠ÿ≥ÿ® ÿßŸÑŸÅÿ±ŸÇ</span>
            </button>
        </div>
    </div>
</div>
<!-- ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑŸÜÿ™ÿßÿ¶ÿ¨ -->
<div class="popup" id="resultsPopup" tabindex="0">
    <div class="popup-header">
        <h2 class="popup-title"><i class="fas fa-chart-pie"></i> <span id="popupTitle">ŸÜÿ™ÿßÿ¶ÿ¨ ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑ</span></h2>
        <button class="close-btn" onclick="closePopup()" tabindex="9">&times;</button>
    </div>
    
    <div id="popupResultsBody">
        <!-- ÿ≥Ÿäÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÜÿ™ÿßÿ¶ÿ¨ ŸáŸÜÿß -->
    </div>
    
    <button onclick="closePopup()" style="margin-top: 15px;" tabindex="10">
        <i class="fas fa-check"></i> <span id="closeBtnText">ŸÖŸàÿßŸÅŸÇ</span>
    </button>
</div>
<!-- ÿ∑ÿ®ŸÇÿ© ÿßŸÑÿ™ÿπÿ™ŸäŸÖ -->
<div class="overlay" id="overlay"></div>
<script>
    const languageTexts = {
        ar: {
            analyzeBtn: "<i class='fas fa-search'></i> ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ±ŸÇŸÖ ÿßŸÑŸÇŸàŸÖŸä",
            analyzeImageBtn: "<i class='fas fa-search'></i> ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ±ŸÇŸÖ ÿßŸÑŸÇŸàŸÖŸä ÿßŸÑŸÖÿ≥ÿ™ÿÆÿ±ÿ¨",
            ageBtn: "<i class='fas fa-calculator'></i> ÿßÿ≠ÿ≥ÿ® ÿßŸÑÿπŸÖÿ±",
            dateDiffBtn: "<i class='fas fa-clock'></i> ÿßÿ≠ÿ≥ÿ® ÿßŸÑŸÅÿ±ŸÇ ÿ®ŸäŸÜ ÿßŸÑÿ™ÿßÿ±ŸäÿÆŸäŸÜ",
            dobPlaceholder: "ŸäŸàŸÖ-ÿ¥Ÿáÿ±-ÿ≥ŸÜÿ© (ŸÖÿ´ÿßŸÑ: 15-08-1990)",
            nationalIDPlaceholder: "ÿ£ÿØÿÆŸÑ ÿßŸÑÿ±ŸÇŸÖ ÿßŸÑŸÇŸàŸÖŸä ŸáŸÜÿß (14 ÿ±ŸÇŸÖŸãÿß)...",
            date1Placeholder: "ÿ£ÿØÿÆŸÑ ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ£ŸàŸÑ (ŸäŸàŸÖ-ÿ¥Ÿáÿ±-ÿ≥ŸÜÿ©)",
            date2Placeholder: "ÿ£ÿØÿÆŸÑ ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ´ÿßŸÜŸä (ŸäŸàŸÖ-ÿ¥Ÿáÿ±-ÿ≥ŸÜÿ©)",
            popupTitle: "ŸÜÿ™ÿßÿ¶ÿ¨ ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑ",
            closeBtn: "ŸÖŸàÿßŸÅŸÇ",
            idError: "ÿßŸÑÿ±ŸÇŸÖ ÿßŸÑŸÇŸàŸÖŸä Ÿäÿ¨ÿ® ÿ£ŸÜ Ÿäÿ™ŸÉŸàŸÜ ŸÖŸÜ 14 ÿ±ŸÇŸÖŸãÿß ŸÅŸÇÿ∑!",
            dateError: "ÿ™ÿßÿ±ŸäÿÆ ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠! Ÿäÿ±ÿ¨Ÿâ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿµŸäÿ∫ÿ© (ŸäŸàŸÖ-ÿ¥Ÿáÿ±-ÿ≥ŸÜÿ©)",
            uploadText: "ÿßŸÜŸÇÿ± ŸÑÿ±ŸÅÿπ ÿµŸàÿ±ÿ© ÿßŸÑÿ®ÿ∑ÿßŸÇÿ© ÿßŸÑÿ¥ÿÆÿµŸäÿ© ÿ£Ÿà ÿßÿ≥ÿ≠ÿ® ÿßŸÑÿµŸàÿ±ÿ© ŸáŸÜÿß",
            processingText: "ÿ¨ÿßÿ±Ÿä ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿµŸàÿ±ÿ©...",
            extractingText: "ÿ¨ÿßÿ±Ÿä ÿßÿ≥ÿ™ÿÆÿ±ÿßÿ¨ ÿßŸÑÿ±ŸÇŸÖ ÿßŸÑŸÇŸàŸÖŸä...",
            analyzingText: "ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ±ŸÇŸÖ ÿßŸÑŸÇŸàŸÖŸä...",
            noIDFound: "ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿ±ŸÇŸÖ ŸÇŸàŸÖŸä ÿµÿßŸÑÿ≠ ŸÅŸä ÿßŸÑÿµŸàÿ±ÿ©!",
            extractedID: "ÿßŸÑÿ±ŸÇŸÖ ÿßŸÑŸÇŸàŸÖŸä ÿßŸÑŸÖÿ≥ÿ™ÿÆÿ±ÿ¨:",
            grayscaleLabel: "ÿ™ÿ≠ŸàŸäŸÑ ÿ•ŸÑŸâ ÿ™ÿØÿ±ÿ¨ ÿßŸÑÿ±ŸÖÿßÿØŸä",
            contrastLabel: "ÿ≤ŸäÿßÿØÿ© ÿßŸÑÿ™ÿ®ÿßŸäŸÜ",
            binarizeLabel: "ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿπÿ™ÿ®ÿ© ÿßŸÑÿ´ŸÜÿßÿ¶Ÿäÿ©",
            manualSelectLabel: "ÿ™ÿ≠ÿØŸäÿØ ŸÖŸÜÿ∑ŸÇÿ© ÿßŸÑÿ±ŸÇŸÖ ŸäÿØŸàŸäŸãÿß",
            resetSelectionBtn: "ÿ•ÿπÿßÿØÿ© ÿßŸÑÿ™ÿ≠ÿØŸäÿØ",
            processSelectedBtn: "ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© ÿßŸÑŸÖÿ≠ÿØÿØÿ©",
            governorates: {
                "01": "ÿßŸÑŸÇÿßŸáÿ±ÿ©", "02": "ÿßŸÑÿ•ÿ≥ŸÉŸÜÿØÿ±Ÿäÿ©", "03": "ÿ®Ÿàÿ±ÿ≥ÿπŸäÿØ", "04": "ÿßŸÑÿ≥ŸàŸäÿ≥", 
                "11": "ÿØŸÖŸäÿßÿ∑", "12": "ÿßŸÑÿØŸÇŸáŸÑŸäÿ©", "13": "ÿßŸÑÿ¥ÿ±ŸÇŸäÿ©", "14": "ÿßŸÑŸÇŸÑŸäŸàÿ®Ÿäÿ©", 
                "15": "ŸÉŸÅÿ± ÿßŸÑÿ¥ŸäÿÆ", "16": "ÿßŸÑÿ∫ÿ±ÿ®Ÿäÿ©", "17": "ÿßŸÑŸÖŸÜŸàŸÅŸäÿ©", "18": "ÿßŸÑÿ®ÿ≠Ÿäÿ±ÿ©", 
                "19": "ÿßŸÑÿ•ÿ≥ŸÖÿßÿπŸäŸÑŸäÿ©", "21": "ÿßŸÑÿ¨Ÿäÿ≤ÿ©", "22": "ÿ®ŸÜŸä ÿ≥ŸàŸäŸÅ", "23": "ÿßŸÑŸÅŸäŸàŸÖ", 
                "24": "ÿßŸÑÿ£ŸÇÿµÿ±", "25": "ÿ≥ŸàŸáÿßÿ¨", "26": "ŸÇŸÜÿß", "27": "ÿ£ÿ≥ŸàÿßŸÜ",
                "28": "ÿ£ÿ≥Ÿàÿ∑", "29": "ŸÖÿ∑ÿ±Ÿàÿ≠", "31": "ÿ¥ŸÖÿßŸÑ ÿ≥ŸäŸÜÿßÿ°", "32": "ÿ¨ŸÜŸàÿ® ÿ≥ŸäŸÜÿßÿ°", 
                "33": "ÿßŸÑÿ®ÿ≠ÿ± ÿßŸÑÿ£ÿ≠ŸÖÿ±", "88": "ÿÆÿßÿ±ÿ¨ ÿßŸÑÿ¨ŸÖŸáŸàÿ±Ÿäÿ©"
            },
            resultTitles: {
                birthDate: "ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸÖŸäŸÑÿßÿØ",
                age: "ÿßŸÑÿπŸÖÿ±",
                gender: "ÿßŸÑÿ¨ŸÜÿ≥",
                governorate: "ÿßŸÑŸÖÿ≠ÿßŸÅÿ∏ÿ©",
                daysUntilBirthday: "ÿßŸÑÿ£ŸäÿßŸÖ ÿßŸÑŸÖÿ™ÿ®ŸÇŸäÿ© ŸÑÿπŸäÿØ ÿßŸÑŸÖŸäŸÑÿßÿØ",
                dateDifference: "ÿßŸÑŸÅÿ±ŸÇ ÿ®ŸäŸÜ ÿßŸÑÿ™ÿßÿ±ŸäÿÆŸäŸÜ"
            },
            gender: {
                male: "ÿ∞ŸÉÿ±",
                female: "ÿ£ŸÜÿ´Ÿâ"
            },
            labels: {
                dobLabel: "ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸÖŸäŸÑÿßÿØ:",
                dateDiffLabel: "ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÅÿ±ŸÇ ÿ®ŸäŸÜ ÿ™ÿßÿ±ŸäÿÆŸäŸÜ:",
                date1Label: "ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ£ŸàŸÑ:",
                date2Label: "ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ´ÿßŸÜŸä:"
            }
        },
        en: {
            analyzeBtn: "<i class='fas fa-search'></i> Analyze National ID",
            analyzeImageBtn: "<i class='fas fa-search'></i> Analyze Extracted ID",
            ageBtn: "<i class='fas fa-calculator'></i> Calculate Age",
            dateDiffBtn: "<i class='fas fa-clock'></i> Calculate Date Difference",
            dobPlaceholder: "DD-MM-YYYY (e.g. 15-08-1990)",
            nationalIDPlaceholder: "Enter national ID here (14 digits)...",
            date1Placeholder: "Enter first date (DD-MM-YYYY)",
            date2Placeholder: "Enter second date (DD-MM-YYYY)",
            popupTitle: "Analysis Results",
            closeBtn: "OK",
            idError: "National ID must be exactly 14 digits!",
            dateError: "Invalid date! Please use format (DD-MM-YYYY)",
            uploadText: "Click to upload ID card image or drag image here",
            processingText: "Processing image...",
            extractingText: "Extracting national ID...",
            analyzingText: "Analyzing national ID...",
            noIDFound: "No valid national ID found in the image!",
            extractedID: "Extracted National ID:",
            grayscaleLabel: "Convert to grayscale",
            contrastLabel: "Increase contrast",
            binarizeLabel: "Apply binary threshold",
            manualSelectLabel: "Manually select ID area",
            resetSelectionBtn: "Reset Selection",
            processSelectedBtn: "Process Selected Area",
            governorates: {
                "01": "Cairo", "02": "Alexandria", "03": "Port Said", "04": "Suez", 
                "11": "Damietta", "12": "Dakahlia", "13": "Sharqia", "14": "Qalyubia", 
                "15": "Kafr El Sheikh", "16": "Gharbia", "17": "Monufia", "18": "Beheira", 
                "19": "Ismailia", "21": "Giza", "22": "Beni Suef", "23": "Faiyum", 
                "24": "Luxor", "25": "Minya", "26": "Qena", "27": "Aswan",
                "28": "Asyut", "29": "Matruh", "31": "North Sinai", "32": "South Sinai", 
                "33": "Red Sea", "88": "Outside Egypt"
            },
            resultTitles: {
                birthDate: "Birth Date",
                age: "Age",
                gender: "Gender",
                governorate: "Governorate",
                daysUntilBirthday: "Days Until Birthday",
                dateDifference: "Date Difference"
            },
            gender: {
                male: "Male",
                female: "Female"
            },
            labels: {
                dobLabel: "Date of Birth:",
                dateDiffLabel: "Calculate Date Difference:",
                date1Label: "First Date:",
                date2Label: "Second Date:"
            }
        }
    };
    
    let currentLanguage = "ar";
    let extractedNationalID = "";
    let originalImageSrc = "";
    let selectionCanvas, selectionCtx;
    let isSelecting = false;
    let startX, startY, endX, endY;
    
    function changeLanguage() {
        currentLanguage = document.getElementById("language").value;
        updateUI();
    }
    
    function updateUI() {
        const lang = languageTexts[currentLanguage];
        
        document.getElementById("analyzeBtnText").innerHTML = lang.analyzeBtn;
        document.getElementById("analyzeImageBtnText").innerHTML = lang.analyzeImageBtn;
        document.getElementById("ageBtnText").innerHTML = lang.ageBtn;
        document.getElementById("dateDiffBtnText").innerHTML = lang.dateDiffBtn;
        document.getElementById("dob").placeholder = lang.dobPlaceholder;
        document.getElementById("nationalID").placeholder = lang.nationalIDPlaceholder;
        document.getElementById("date1").placeholder = lang.date1Placeholder;
        document.getElementById("date2").placeholder = lang.date2Placeholder;
        document.getElementById("popupTitle").innerHTML = `<i class="fas fa-chart-pie"></i> ${lang.popupTitle}`;
        document.getElementById("closeBtnText").innerHTML = `<i class="fas fa-check"></i> ${lang.closeBtn}`;
        document.getElementById("uploadText").textContent = lang.uploadText;
        document.getElementById("dobLabel").textContent = lang.labels.dobLabel;
        document.getElementById("dateDiffLabel").textContent = lang.labels.dateDiffLabel;
        document.getElementById("date1Label").textContent = lang.labels.date1Label;
        document.getElementById("date2Label").textContent = lang.labels.date2Label;
        document.getElementById("grayscaleLabel").textContent = lang.grayscaleLabel;
        document.getElementById("contrastLabel").textContent = lang.contrastLabel;
        document.getElementById("binarizeLabel").textContent = lang.binarizeLabel;
        document.getElementById("manualSelectLabel").textContent = lang.manualSelectLabel;
        document.getElementById("resetSelectionBtn").textContent = lang.resetSelectionBtn;
        document.getElementById("processSelectedBtn").textContent = lang.processSelectedBtn;
    }
    
    function validateNationalID(input) {
        const errorDiv = document.getElementById("idError");
        const lang = languageTexts[currentLanguage];
        
        input.value = input.value.replace(/\D/g, '');
        
        if (input.value.length > 14) {
            input.value = input.value.substring(0, 14);
            errorDiv.textContent = lang.idError;
        } else {
            errorDiv.textContent = "";
        }
    }
    
    function analyzeNationalID() {
        const id = document.getElementById("nationalID").value;
        const errorDiv = document.getElementById("idError");
        const lang = languageTexts[currentLanguage];
        
        if (id.length !== 14 || isNaN(id)) {
            errorDiv.textContent = lang.idError;
            return;
        }
        
        errorDiv.textContent = "";
        analyzeID(id);
    }
    
    function analyzeFromExtractedID() {
        if (extractedNationalID.length === 14) {
            analyzeID(extractedNationalID);
        }
    }
    
    function analyzeID(id) {
        const lang = languageTexts[currentLanguage];
        document.getElementById("statusMessage").textContent = lang.analyzingText;
        document.getElementById("statusMessage").style.display = "block";
        
        const century = id.charAt(0);
        const year = parseInt(id.substring(1, 3));
        const month = parseInt(id.substring(3, 5));
        const day = parseInt(id.substring(5, 7));
        const genderCode = parseInt(id.charAt(12));
        const governorateCode = id.substring(7, 9);
        
        const birthDate = new Date((century === "2" ? "19" : "20") + year, month - 1, day);
        const gender = genderCode >= 1 && genderCode <= 4 ? lang.gender.male : lang.gender.female;
        const governorate = lang.governorates[governorateCode] || lang.resultTitles.governorate + " ÿ∫Ÿäÿ± ŸÖÿπÿ±ŸàŸÅ";
        
        const today = new Date();
        let ageYears = today.getFullYear() - birthDate.getFullYear();
        let ageMonths = today.getMonth() - birthDate.getMonth();
        let ageDays = today.getDate() - birthDate.getDate();
        
        if (ageDays < 0) {
            ageMonths--;
            ageDays += getDaysInMonth(today.getFullYear(), today.getMonth());
        }
        if (ageMonths < 0) {
            ageYears--;
            ageMonths += 12;
        }
        
        const daysUntilBirthday = calculateDaysUntilBirthday(birthDate);
        
        const results = [
            { key: lang.resultTitles.birthDate, value: formatDate(birthDate), icon: "fas fa-birthday-cake" },
            { key: lang.resultTitles.age, value: `${ageYears} ${currentLanguage === "ar" ? "ÿ≥ŸÜÿ©" : "years"}, ${ageMonths} ${currentLanguage === "ar" ? "ÿ¥Ÿáÿ±" : "months"}, ${ageDays} ${currentLanguage === "ar" ? "ŸäŸàŸÖ" : "days"}`, icon: "fas fa-user-clock" },
            { key: lang.resultTitles.gender, value: gender, icon: gender === lang.gender.male ? "fas fa-mars" : "fas fa-venus" },
            { key: lang.resultTitles.governorate, value: governorate, icon: "fas fa-map-marker-alt" },
            { key: lang.resultTitles.daysUntilBirthday, value: `${daysUntilBirthday} ${currentLanguage === "ar" ? "ŸäŸàŸÖ" : "days"}`, icon: "fas fa-gift" }
        ];
        
        document.getElementById("statusMessage").style.display = "none";
        showPopup(results);
    }
    
    function calculateAge() {
        const dob = document.getElementById("dob").value;
        const errorDiv = document.getElementById("dobError");
        const lang = languageTexts[currentLanguage];
        
        if (!isValidDate(dob)) {
            errorDiv.textContent = lang.dateError;
            return;
        }
        
        errorDiv.textContent = "";
        
        const [day, month, year] = dob.split("-").map(Number);
        const today = new Date();
        const birthDate = new Date(year, month - 1, day);
        
        let ageYears = today.getFullYear() - birthDate.getFullYear();
        let ageMonths = today.getMonth() - birthDate.getMonth();
        let ageDays = today.getDate() - birthDate.getDate();
        
        if (ageDays < 0) {
            ageMonths--;
            ageDays += getDaysInMonth(today.getFullYear(), today.getMonth());
        }
        if (ageMonths < 0) {
            ageYears--;
            ageMonths += 12;
        }
        
        const daysUntilBirthday = calculateDaysUntilBirthday(birthDate);
        
        const results = [
            { key: lang.resultTitles.birthDate, value: formatDate(birthDate), icon: "fas fa-birthday-cake" },
            { key: lang.resultTitles.age, value: `${ageYears} ${currentLanguage === "ar" ? "ÿ≥ŸÜÿ©" : "years"}, ${ageMonths} ${currentLanguage === "ar" ? "ÿ¥Ÿáÿ±" : "months"}, ${ageDays} ${currentLanguage === "ar" ? "ŸäŸàŸÖ" : "days"}`, icon: "fas fa-user-clock" },
            { key: lang.resultTitles.daysUntilBirthday, value: `${daysUntilBirthday} ${currentLanguage === "ar" ? "ŸäŸàŸÖ" : "days"}`, icon: "fas fa-gift" }
        ];
        
        showPopup(results);
    }
    
    function calculateDateDifference() {
        const date1 = document.getElementById("date1").value;
        const date2 = document.getElementById("date2").value;
        const errorDiv = document.getElementById("dateError");
        const lang = languageTexts[currentLanguage];
        
        if (!isValidDate(date1) || !isValidDate(date2)) {
            errorDiv.textContent = lang.dateError;
            return;
        }
        
        errorDiv.textContent = "";
        
        const [d1, m1, y1] = date1.split("-").map(Number);
        const [d2, m2, y2] = date2.split("-").map(Number);
        
        const firstDate = new Date(y1, m1 - 1, d1);
        const secondDate = new Date(y2, m2 - 1, d2);
        
        let startDate, endDate;
        if (firstDate < secondDate) {
            startDate = firstDate;
            endDate = secondDate;
        } else {
            startDate = secondDate;
            endDate = firstDate;
        }
        
        const diffTime = Math.abs(endDate - startDate);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        const diffYears = Math.floor(diffDays / 365);
        const remainingDays = diffDays % 365;
        const diffMonths = Math.floor(remainingDays / 30);
        const finalDays = remainingDays % 30;
        
        let dateDiffText;
        if (currentLanguage === "ar") {
            dateDiffText = `${diffYears} ÿ≥ŸÜÿ© Ÿà ${diffMonths} ÿ¥Ÿáÿ± Ÿà ${finalDays} ŸäŸàŸÖ`;
        } else {
            dateDiffText = `${diffYears} years, ${diffMonths} months, and ${finalDays} days`;
        }
        
        const results = [
            { key: lang.resultTitles.birthDate + " 1", value: formatDate(firstDate), icon: "fas fa-calendar-day" },
            { key: lang.resultTitles.birthDate + " 2", value: formatDate(secondDate), icon: "fas fa-calendar-day" },
            { key: lang.resultTitles.dateDifference, value: dateDiffText, icon: "fas fa-hourglass-half" }
        ];
        
        showPopup(results);
    }
    
    function isValidDate(dateStr) {
        const regex = /^(\d{2})-(\d{2})-(\d{4})$/;
        if (!regex.test(dateStr)) return false;
        
        const [_, day, month, year] = dateStr.match(regex).map(Number);
        const date = new Date(year, month - 1, day);
        
        return date.getDate() === day && 
               date.getMonth() + 1 === month && 
               date.getFullYear() === year;
    }
    
    function calculateDaysUntilBirthday(birthDate) {
        const today = new Date();
        const thisYearBirthday = new Date(today.getFullYear(), birthDate.getMonth(), birthDate.getDate());
        
        if (thisYearBirthday < today) {
            thisYearBirthday.setFullYear(today.getFullYear() + 1);
        }
        
        return Math.ceil((thisYearBirthday - today) / (1000 * 60 * 60 * 24));
    }
    
    function getDaysInMonth(year, month) {
        return new Date(year, month + 1, 0).getDate();
    }
    
    function showPopup(results) {
        const popup = document.getElementById("resultsPopup");
        const overlay = document.getElementById("overlay");
        const tbody = document.getElementById("popupResultsBody");
        
        tbody.innerHTML = "";
        
        results.forEach(result => {
            const row = document.createElement("tr");
            
            const keyCell = document.createElement("td");
            keyCell.innerHTML = `<i class="${result.icon}"></i> ${result.key}`;
            keyCell.style.fontWeight = "600";
            keyCell.style.color = "var(--primary-color)";
            
            const valueCell = document.createElement("td");
            valueCell.textContent = result.value;
            
            row.appendChild(keyCell);
            row.appendChild(valueCell);
            tbody.appendChild(row);
        });
        
        popup.style.display = "block";
        overlay.style.display = "block";
        
        // ÿßŸÑÿ™ÿ±ŸÉŸäÿ≤ ÿπŸÑŸâ ÿßŸÑÿ®Ÿàÿ® ÿ£ÿ® ŸÑÿ™ŸÖŸÉŸäŸÜ ÿßŸÑÿ™ŸÜŸÇŸÑ ÿ®ÿßŸÑŸÉŸäÿ®Ÿàÿ±ÿØ
        popup.focus();
    }
    
    function closePopup() {
        const popup = document.getElementById("resultsPopup");
        const overlay = document.getElementById("overlay");
        
        popup.style.display = "none";
        overlay.style.display = "none";
    }
    
    function validateDateInput(input) {
        const errorDivId = input.id === "dob" ? "dobError" : "dateError";
        const errorDiv = document.getElementById(errorDivId);
        const lang = languageTexts[currentLanguage];
        
        const regex = /^(\d{0,2})-?(\d{0,2})-?(\d{0,4})$/;
        if (!regex.test(input.value)) {
            input.style.borderColor = "red";
            errorDiv.textContent = lang.dateError;
            return;
        }
        
        let value = input.value.replace(/\D/g, '');
        if (value.length > 2 && value.length <= 4) {
            value = value.substring(0, 2) + '-' + value.substring(2);
        } else if (value.length > 4) {
            value = value.substring(0, 2) + '-' + value.substring(2, 4) + '-' + value.substring(4, 8);
        }
        
        input.value = value;
        
        if (value.length === 10) {
            if (isValidDate(value)) {
                input.style.borderColor = "#4CAF50";
                errorDiv.textContent = "";
            } else {
                input.style.borderColor = "red";
                errorDiv.textContent = lang.dateError;
            }
        } else {
            input.style.borderColor = "#e0e0e0";
            errorDiv.textContent = "";
        }
    }
    
    function formatDate(date) {
        const options = { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric',
            timeZone: 'UTC'
        };
        
        if (currentLanguage === "ar") {
            return date.toLocaleDateString('ar-EG', options);
        } else {
            return date.toLocaleDateString('en-US', options);
        }
    }
    
    // Ÿàÿ∏ÿßÿ¶ŸÅ ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿµŸàÿ± ŸàÿßŸÑÿ™ÿπÿ±ŸÅ ÿπŸÑŸâ ÿßŸÑŸÜÿµŸàÿµ
    function handleFileSelect(event) {
        const file = event.target.files[0];
        if (file) {
            processImage(file);
        }
    }
    
    function processImage(file) {
        const lang = languageTexts[currentLanguage];
        const reader = new FileReader();
        
        reader.onload = function(e) {
            originalImageSrc = e.target.result;
            const imagePreview = document.getElementById("imagePreview");
            imagePreview.src = e.target.result;
            imagePreview.style.display = "block";
            
            // ÿ•ÿπÿØÿßÿØ ŸÑŸàÿ≠ÿ© ÿßŸÑÿ™ÿ≠ÿØŸäÿØ ÿßŸÑŸäÿØŸàŸä
            setupManualSelection();
            
            document.getElementById("progressContainer").style.display = "block";
            document.getElementById("statusMessage").textContent = lang.processingText;
            document.getElementById("statusMessage").style.display = "block";
            
            // ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿµŸàÿ±ÿ© ŸÖÿ≥ÿ®ŸÇŸãÿß
            preprocessImage(e.target.result).then(processedImageSrc => {
                // ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ Tesseract ŸÑŸÑÿ™ÿπÿ±ŸÅ ÿπŸÑŸâ ÿßŸÑŸÜÿµ ŸÅŸä ÿßŸÑÿµŸàÿ±ÿ© ÿßŸÑŸÖÿπÿßŸÑÿ¨ÿ©
                Tesseract.recognize(
                    processedImageSrc,
                    currentLanguage === 'ar' ? 'ara' : 'eng',
                    {
                        logger: m => {
                            if (m.status === "recognizing text") {
                                const progress = Math.round(m.progress * 100);
                                document.getElementById("progressBar").style.width = progress + "%";
                            }
                        }
                    }
                ).then(({ data: { text } }) => {
                    document.getElementById("progressBar").style.width = "100%";
                    document.getElementById("statusMessage").textContent = lang.extractingText;
                    
                    // ÿßÿ≥ÿ™ÿÆÿ±ÿßÿ¨ ÿßŸÑÿ±ŸÇŸÖ ÿßŸÑŸÇŸàŸÖŸä ŸÖŸÜ ÿßŸÑŸÜÿµ
                    const extractedID = extractNationalID(text);
                    
                    if (extractedID) {
                        extractedNationalID = extractedID;
                        document.getElementById("extractedId").textContent = lang.extractedID + " " + extractedID;
                        document.getElementById("extractedId").style.display = "block";
                        document.getElementById("analyzeFromImageBtn").style.display = "block";
                        document.getElementById("statusMessage").style.display = "none";
                    } else {
                        document.getElementById("statusMessage").textContent = lang.noIDFound;
                        document.getElementById("statusMessage").style.color = "#ff6b6b";
                    }
                }).catch(err => {
                    console.error(err);
                    document.getElementById("statusMessage").textContent = "Error processing image: " + err.message;
                    document.getElementById("statusMessage").style.color = "#ff6b6b";
                });
            });
        };
        
        reader.readAsDataURL(file);
    }
    
    function preprocessImage(imageSrc) {
        return new Promise((resolve) => {
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                canvas.width = img.width;
                canvas.height = img.height;
                
                // ÿ±ÿ≥ŸÖ ÿßŸÑÿµŸàÿ±ÿ© ÿßŸÑÿ£ÿµŸÑŸäÿ©
                ctx.drawImage(img, 0, 0);
                
                // ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿµŸàÿ±ÿ©
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;
                
                // ÿ™ÿ∑ÿ®ŸäŸÇ ÿÆŸäÿßÿ±ÿßÿ™ ÿßŸÑŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑŸÖÿ≥ÿ®ŸÇÿ©
                const grayscale = document.getElementById('grayscale').checked;
                const contrast = document.getElementById('contrast').checked;
                const binarize = document.getElementById('binarize').checked;
                
                // ÿ™ÿ≠ŸàŸäŸÑ ÿ•ŸÑŸâ ÿ™ÿØÿ±ÿ¨ ÿßŸÑÿ±ŸÖÿßÿØŸä
                if (grayscale) {
                    for (let i = 0; i < data.length; i += 4) {
                        const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
                        data[i] = avg; // red
                        data[i + 1] = avg; // green
                        data[i + 2] = avg; // blue
                    }
                }
                
                // ÿ≤ŸäÿßÿØÿ© ÿßŸÑÿ™ÿ®ÿßŸäŸÜ
                if (contrast) {
                    const factor = 1.5; // ÿπÿßŸÖŸÑ ÿßŸÑÿ™ÿ®ÿßŸäŸÜ
                    for (let i = 0; i < data.length; i += 4) {
                        data[i] = Math.min(255, Math.max(0, factor * (data[i] - 128) + 128));
                        data[i + 1] = Math.min(255, Math.max(0, factor * (data[i + 1] - 128) + 128));
                        data[i + 2] = Math.min(255, Math.max(0, factor * (data[i + 2] - 128) + 128));
                    }
                }
                
                // ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿπÿ™ÿ®ÿ© ÿßŸÑÿ´ŸÜÿßÿ¶Ÿäÿ©
                if (binarize) {
                    const threshold = 128; // ŸÇŸäŸÖÿ© ÿßŸÑÿπÿ™ÿ®ÿ©
                    for (let i = 0; i < data.length; i += 4) {
                        const value = (data[i] + data[i + 1] + data[i + 2]) / 3 > threshold ? 255 : 0;
                        data[i] = value; // red
                        data[i + 1] = value; // green
                        data[i + 2] = value; // blue
                    }
                }
                
                // Ÿàÿ∂ÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿπÿßŸÑÿ¨ÿ© ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ
                ctx.putImageData(imageData, 0, 0);
                
                // ÿ™ÿ≠ŸàŸäŸÑ canvas ÿ•ŸÑŸâ data URL
                resolve(canvas.toDataURL());
            };
            img.src = imageSrc;
        });
    }
    
    function extractNationalID(text) {
        // ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑŸÖÿ≥ÿßŸÅÿßÿ™ ŸàÿßŸÑÿ£ÿ≥ÿ∑ÿ± ÿßŸÑÿ¨ÿØŸäÿØÿ© ŸàÿßŸÑÿ£ÿ≠ÿ±ŸÅ ÿ∫Ÿäÿ± ÿßŸÑÿ±ŸÇŸÖŸäÿ©
        const cleanedText = text.replace(/\s/g, '').replace(/\D/g, '');
        
        // ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿ£Ÿä ÿ≥ŸÑÿ≥ŸÑÿ© ŸÖŸÜ 14 ÿ±ŸÇŸÖ ŸÖÿ™ÿ™ÿßŸÑŸä
        const idMatch = cleanedText.match(/\d{14}/);
        
        if (idMatch) {
            const potentialID = idMatch[0];
            // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ£ŸÜ ÿßŸÑÿ±ŸÇŸÖ Ÿäÿ®ÿØÿ£ ÿ®ŸÄ 2 ÿ£Ÿà 3
            if (potentialID[0] === '2' || potentialID[0] === '3') {
                return potentialID;
            }
        }
        
        // ÿ•ÿ∞ÿß ŸÑŸÖ ŸÜÿ¨ÿØ 14 ÿ±ŸÇŸÖ ŸÖÿ™ÿ™ÿßŸÑŸäÿå ŸÜÿ≠ÿßŸàŸÑ ÿ™ÿ¨ŸÖŸäÿπ ÿßŸÑÿ£ÿ±ŸÇÿßŸÖ ÿßŸÑŸÖÿ™ŸÅÿ±ŸÇÿ©
        const allDigits = cleanedText.match(/\d/g);
        
        if (allDigits && allDigits.length >= 14) {
            // ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿ£ŸàŸÑ 14 ÿ±ŸÇŸÖ ŸÖÿ™ÿ™ÿßŸÑŸä
            for (let i = 0; i <= allDigits.length - 14; i++) {
                const potentialID = allDigits.slice(i, i + 14).join('');
                
                // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ£ŸÜ ÿßŸÑÿ±ŸÇŸÖ Ÿäÿ®ÿØÿ£ ÿ®ŸÄ 2 ÿ£Ÿà 3
                if (potentialID[0] === '2' || potentialID[0] === '3') {
                    // ÿ™ÿ≠ŸÇŸÇ ÿ•ÿ∂ÿßŸÅŸä: ÿßŸÑÿ™ÿßÿ±ŸäÿÆ (ÿßŸÑÿ£ÿ±ŸÇÿßŸÖ ŸÖŸÜ 1 ÿ•ŸÑŸâ 6) Ÿäÿ¨ÿ® ÿ£ŸÜ ŸäŸÉŸàŸÜ ÿ™ÿßÿ±ŸäÿÆŸãÿß ÿµÿßŸÑÿ≠Ÿãÿß
                    const day = parseInt(potentialID.substring(1, 3));
                    const month = parseInt(potentialID.substring(3, 5));
                    const year = parseInt(potentialID.substring(5, 7));
                    
                    // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ£ŸÜ ÿßŸÑŸäŸàŸÖ ŸàÿßŸÑÿ¥Ÿáÿ± ŸàÿßŸÑÿ≥ŸÜÿ© ŸÖÿπŸÇŸàŸÑÿ©
                    if (day >= 1 && day <= 31 && month >= 1 && month <= 12) {
                        return potentialID;
                    }
                }
            }
        }
        
        return null;
    }
    
    // ÿ•ÿπÿØÿßÿØ ÿßŸÑÿ≥ÿ≠ÿ® ŸàÿßŸÑÿ•ŸÅŸÑÿßÿ™ ŸÑŸÑÿµŸàÿ±
    function setupDragAndDrop() {
        const imageUpload = document.getElementById("imageUpload");
        
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            imageUpload.addEventListener(eventName, preventDefaults, false);
        });
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        ['dragenter', 'dragover'].forEach(eventName => {
            imageUpload.addEventListener(eventName, highlight, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            imageUpload.addEventListener(eventName, unhighlight, false);
        });
        
        function highlight() {
            imageUpload.classList.add('dragover');
        }
        
        function unhighlight() {
            imageUpload.classList.remove('dragover');
        }
        
        imageUpload.addEventListener('drop', handleDrop, false);
        
        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            
            if (files.length > 0) {
                processImage(files[0]);
            }
        }
    }
    
    // ÿ•ÿπÿØÿßÿØ ÿßŸÑÿ™ÿ≠ÿØŸäÿØ ÿßŸÑŸäÿØŸàŸä ŸÑŸÑŸÖŸÜÿ∑ŸÇÿ©
    function setupManualSelection() {
        const manualSelectCheckbox = document.getElementById('manualSelect');
        const manualSelectionDiv = document.getElementById('manualSelection');
        
        manualSelectCheckbox.addEventListener('change', function() {
            if (this.checked) {
                manualSelectionDiv.style.display = 'block';
                initSelectionCanvas();
            } else {
                manualSelectionDiv.style.display = 'none';
            }
        });
    }
    
    function initSelectionCanvas() {
        selectionCanvas = document.getElementById('selectionCanvas');
        selectionCtx = selectionCanvas.getContext('2d');
        
        const img = new Image();
        img.onload = function() {
            // ÿ∂ÿ®ÿ∑ ÿ£ÿ®ÿπÿßÿØ ÿßŸÑŸÑŸàÿ≠ÿ© ŸÑÿ™ÿ™ŸÜÿßÿ≥ÿ® ŸÖÿπ ÿßŸÑÿµŸàÿ±ÿ© ŸÖÿπ ÿßŸÑÿ≠ŸÅÿßÿ∏ ÿπŸÑŸâ ŸÜÿ≥ÿ®ÿ© ÿßŸÑÿπÿ±ÿ∂ ÿ•ŸÑŸâ ÿßŸÑÿßÿ±ÿ™ŸÅÿßÿπ
            const maxWidth = 500;
            const maxHeight = 300;
            let width = img.width;
            let height = img.height;
            
            if (width > maxWidth) {
                height *= maxWidth / width;
                width = maxWidth;
            }
            
            if (height > maxHeight) {
                width *= maxHeight / height;
                height = maxHeight;
            }
            
            selectionCanvas.width = width;
            selectionCanvas.height = height;
            selectionCtx.drawImage(img, 0, 0, width, height);
            
            // ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ≥ÿ™ŸÖÿπŸä ÿßŸÑÿ£ÿ≠ÿØÿßÿ´ ŸÑŸÑÿ™ÿ≠ÿØŸäÿØ
            selectionCanvas.addEventListener('mousedown', startSelection);
            selectionCanvas.addEventListener('mousemove', updateSelection);
            selectionCanvas.addEventListener('mouseup', endSelection);
        };
        img.src = originalImageSrc;
    }
    
    function startSelection(e) {
        isSelecting = true;
        const rect = selectionCanvas.getBoundingClientRect();
        startX = e.clientX - rect.left;
        startY = e.clientY - rect.top;
    }
    
    function updateSelection(e) {
        if (!isSelecting) return;
        
        const rect = selectionCanvas.getBoundingClientRect();
        endX = e.clientX - rect.left;
        endY = e.clientY - rect.top;
        
        // ÿ•ÿπÿßÿØÿ© ÿ±ÿ≥ŸÖ ÿßŸÑÿµŸàÿ±ÿ©
        const img = new Image();
        img.onload = function() {
            selectionCtx.clearRect(0, 0, selectionCanvas.width, selectionCanvas.height);
            selectionCtx.drawImage(img, 0, 0, selectionCanvas.width, selectionCanvas.height);
            
            // ÿ±ÿ≥ŸÖ ŸÖÿ≥ÿ™ÿ∑ŸäŸÑ ÿßŸÑÿ™ÿ≠ÿØŸäÿØ
            selectionCtx.strokeStyle = '#ff0000';
            selectionCtx.lineWidth = 2;
            selectionCtx.strokeRect(startX, startY, endX - startX, endY - startY);
        };
        img.src = originalImageSrc;
    }
    
    function endSelection() {
        isSelecting = false;
    }
    
    function resetSelection() {
        initSelectionCanvas();
    }
    
    function processSelectedArea() {
        if (!startX || !startY || !endX || !endY) {
            alert('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ™ÿ≠ÿØŸäÿØ ŸÖŸÜÿ∑ŸÇÿ© ÿ£ŸàŸÑÿßŸã');
            return;
        }
        
        // ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿ•ÿ≠ÿØÿßÿ´Ÿäÿßÿ™ ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© ÿßŸÑŸÖÿ≠ÿØÿØÿ©
        const x = Math.min(startX, endX);
        const y = Math.min(startY, endY);
        const width = Math.abs(endX - startX);
        const height = Math.abs(endY - startY);
        
        // ÿ•ŸÜÿ¥ÿßÿ° ŸÑŸàÿ≠ÿ© ÿ¨ÿØŸäÿØÿ© ŸÑŸÑŸÖŸÜÿ∑ŸÇÿ© ÿßŸÑŸÖÿ≠ÿØÿØÿ©
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        
        // ÿ∂ÿ®ÿ∑ ÿ£ÿ®ÿπÿßÿØ ÿßŸÑŸÑŸàÿ≠ÿ© ÿßŸÑÿ£ÿµŸÑŸäÿ©
        const img = new Image();
        img.onload = function() {
            canvas.width = width;
            canvas.height = height;
            
            // ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÜÿ≥ÿ® ÿßŸÑŸÖÿ¶ŸàŸäÿ© ŸÑŸÑÿ•ÿ≠ÿØÿßÿ´Ÿäÿßÿ™
            const scaleX = img.width / selectionCanvas.width;
            const scaleY = img.height / selectionCanvas.height;
            
            // ÿ±ÿ≥ŸÖ ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© ÿßŸÑŸÖÿ≠ÿØÿØÿ© ŸÖŸÜ ÿßŸÑÿµŸàÿ±ÿ© ÿßŸÑÿ£ÿµŸÑŸäÿ©
            ctx.drawImage(
                img, 
                x * scaleX, y * scaleY, width * scaleX, height * scaleY,
                0, 0, width, height
            );
            
            // ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿµŸàÿ±ÿ© ÿßŸÑŸÖÿ≠ÿØÿØÿ©
            const lang = languageTexts[currentLanguage];
            document.getElementById("progressContainer").style.display = "block";
            document.getElementById("statusMessage").textContent = lang.processingText;
            document.getElementById("statusMessage").style.display = "block";
            
            preprocessImage(canvas.toDataURL()).then(processedImageSrc => {
                // ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ Tesseract ŸÑŸÑÿ™ÿπÿ±ŸÅ ÿπŸÑŸâ ÿßŸÑŸÜÿµ ŸÅŸä ÿßŸÑÿµŸàÿ±ÿ© ÿßŸÑŸÖÿπÿßŸÑÿ¨ÿ©
                Tesseract.recognize(
                    processedImageSrc,
                    currentLanguage === 'ar' ? 'ara' : 'eng',
                    {
                        logger: m => {
                            if (m.status === "recognizing text") {
                                const progress = Math.round(m.progress * 100);
                                document.getElementById("progressBar").style.width = progress + "%";
                            }
                        }
                    }
                ).then(({ data: { text } }) => {
                    document.getElementById("progressBar").style.width = "100%";
                    document.getElementById("statusMessage").textContent = lang.extractingText;
                    
                    // ÿßÿ≥ÿ™ÿÆÿ±ÿßÿ¨ ÿßŸÑÿ±ŸÇŸÖ ÿßŸÑŸÇŸàŸÖŸä ŸÖŸÜ ÿßŸÑŸÜÿµ
                    const extractedID = extractNationalID(text);
                    
                    if (extractedID) {
                        extractedNationalID = extractedID;
                        document.getElementById("extractedId").textContent = lang.extractedID + " " + extractedID;
                        document.getElementById("extractedId").style.display = "block";
                        document.getElementById("analyzeFromImageBtn").style.display = "block";
                        document.getElementById("statusMessage").style.display = "none";
                    } else {
                        document.getElementById("statusMessage").textContent = lang.noIDFound;
                        document.getElementById("statusMessage").style.color = "#ff6b6b";
                    }
                }).catch(err => {
                    console.error(err);
                    document.getElementById("statusMessage").textContent = "Error processing image: " + err.message;
                    document.getElementById("statusMessage").style.color = "#ff6b6b";
                });
            });
        };
        img.src = originalImageSrc;
    }
    
    // ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ•ÿØÿÆÿßŸÑ ÿ®ÿßŸÑŸÉŸäÿ®Ÿàÿ±ÿØ
    document.addEventListener('keydown', function(event) {
        const popup = document.getElementById("resultsPopup");
        
        // ÿπŸÜÿØ ÿßŸÑÿ∂ÿ∫ÿ∑ ÿπŸÑŸâ ÿ≤ÿ± Enter ŸÅŸä ÿ≠ŸÇŸÑ ÿßŸÑÿ•ÿØÿÆÿßŸÑ
        if (event.target.tagName === 'INPUT' && event.key === 'Enter') {
            if (event.target.id === 'nationalID') {
                analyzeNationalID();
            } else if (event.target.id === 'dob') {
                calculateAge();
            } else if (event.target.id === 'date1' || event.target.id === 'date2') {
                calculateDateDifference();
            }
        }
        
        // ÿπŸÜÿØ ÿßŸÑÿ∂ÿ∫ÿ∑ ÿπŸÑŸâ Esc ŸÑÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑÿ®Ÿàÿ® ÿ£ÿ®
        if (popup.style.display === 'block' && event.key === 'Escape') {
            closePopup();
        }
    });
    
    window.onload = function() {
        updateUI();
        setupDragAndDrop();
        
        // ÿ•ÿ∂ÿßŸÅÿ© tabindex ŸÑŸÑÿπŸÜÿßÿµÿ± ÿßŸÑŸÇÿßÿ®ŸÑÿ© ŸÑŸÑÿ™ÿ±ŸÉŸäÿ≤
        const focusableElements = document.querySelectorAll('button, input, select, [tabindex]');
        focusableElements.forEach((el, index) => {
            el.setAttribute('tabindex', index + 1);
        });
    };
</script>
</body>
</html>
