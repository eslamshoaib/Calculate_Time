<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>محول الإحداثيات الذكي - خرائط جوجل</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Tajawal', sans-serif;
            background: #f8f9fa;
            padding: 20px;
        }
        .container {
            max-width: 900px;
            margin: auto;
            background: #fff;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            margin-bottom: 30px;
        }
        input[type="file"] {
            display: none;
        }
        label {
            background: #4285F4;
            color: white;
            padding: 12px 25px;
            display: inline-block;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 15px;
        }
        button {
            background: #34A853;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 20px;
            font-size: 16px;
        }
        .result {
            margin-top: 30px;
        }
        .card {
            background: #f1f3f4;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .card a {
            color: #4285F4;
        }
        iframe {
            width: 100%;
            height: 300px;
            border: none;
            margin-top: 10px;
            border-radius: 8px;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>محول الإحداثيات الذكي</h1>
    <label for="excelFile">📄 اختر ملف Excel</label>
    <input type="file" id="excelFile" accept=".xlsx,.xls"/>
    <br>
    <button onclick="processFile()">🔄 تحويل الإحداثيات</button>
    <div id="output" class="result"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
    function readExcel(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = e => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: "array" });
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                const json = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                resolve(json);
            };
            reader.onerror = reject;
            reader.readAsArrayBuffer(file);
        });
    }

    async function processFile() {
        const fileInput = document.getElementById('excelFile');
        const outputDiv = document.getElementById('output');
        outputDiv.innerHTML = '';

        if (fileInput.files.length === 0) {
            alert("الرجاء اختيار ملف Excel");
            return;
        }

        const file = fileInput.files[0];
        const rows = await readExcel(file);

        const header = rows[0];
        const coordsIndex = header.findIndex(h => typeof h === 'string' && h.includes('N') && h.includes('E'));

        if (coordsIndex === -1) {
            outputDiv.innerHTML = '<p style="color:red;">⚠️ لم يتم العثور على عمود الإحداثيات</p>';
            return;
        }

        for (let i = 1; i < rows.length; i++) {
            const row = rows[i];
            const coordStr = (row[coordsIndex] || '').toString().trim();

            const parsed = parseCoordinate(coordStr);
            if (!parsed) continue;

            const { lat, lon, mapUrl, iframeUrl } = parsed;

            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `
                <p><strong>الإحداثيات الأصلية:</strong> ${coordStr}</p>
                <p><strong>الموقع:</strong> ${lat.toFixed(6)}°, ${lon.toFixed(6)}°</p>
                <a href="${mapUrl}" target="_blank">🌍 فتح في خرائط جوجل</a>
                <iframe src="${iframeUrl}" loading="lazy"></iframe>
            `;
            outputDiv.appendChild(card);
        }
    }

    function parseCoordinate(text) {
        if (!text) return null;

        // يحاول استخلاص الشكل: 'N 3121258 E 2713105' أو 'N'||3121258||'E'||2713105
        const match = text.match(/N\s*([0-9]{7})\s*E\s*([0-9]{7})/) ||
                      text.match(/'N'\|\|(\d{7})\|\|'E'\|\|(\d{7})/);

        if (!match) return null;

        const latDMS = match[1];
        const lonDMS = match[2];

        const lat = dmsToDecimal(latDMS, true);
        const lon = dmsToDecimal(lonDMS, false);

        const mapUrl = `https://www.google.com/maps?q=${lat},${lon}&z=16`;
        const iframeUrl = `https://maps.google.com/maps?q=${lat},${lon}&z=16&output=embed`;

        return { lat, lon, mapUrl, iframeUrl };
    }

    function dmsToDecimal(dms, isLat) {
        const dLen = isLat ? 2 : 3;
        const deg = parseInt(dms.slice(0, dLen));
        const min = parseInt(dms.slice(dLen, dLen + 2));
        const sec = parseInt(dms.slice(dLen + 2, dLen + 4));
        return deg + (min / 60) + (sec / 3600);
    }
</script>
</body>
</html>