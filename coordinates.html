<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>محول الإحداثيات الذكي</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: 'Tahoma', sans-serif; background: #f7f7f7; margin: 0; padding: 20px; }
    h1 { text-align: center; color: #333; }
    .container { max-width: 900px; margin: auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
    input[type="file"] { display: none; }
    label[for="upload"] {
      background: #4285f4; color: white; padding: 12px 24px; border-radius: 6px;
      cursor: pointer; display: inline-block; font-weight: bold; margin-bottom: 20px;
    }
    button {
      padding: 10px 20px; background: #34a853; border: none; color: white;
      font-weight: bold; border-radius: 6px; cursor: pointer;
    }
    .result { margin-top: 20px; padding: 15px; background: #eef; border-radius: 10px; }
    iframe { width: 100%; height: 300px; border: none; border-radius: 8px; }
    .coord { font-family: monospace; margin-top: 5px; }
    .maplink { margin-top: 10px; display: inline-block; background: #3367D6; color: white; padding: 8px 16px; border-radius: 6px; text-decoration: none; }
  </style>
</head>
<body>
  <div class="container">
    <h1>📍 محول الإحداثيات الذكي</h1>
    <label for="upload">📤 اختر ملف Excel</label>
    <input type="file" id="upload" accept=".xlsx, .xls" />
    <button onclick="processExcel()">🔍 معالجة الإحداثيات</button>

    <div id="results"></div>
  </div>

  <script>
    let workbookData = [];

    document.getElementById("upload").addEventListener("change", function(e) {
      const file = e.target.files[0];
      const reader = new FileReader();
      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const wb = XLSX.read(data, { type: "array" });
        const sheet = wb.Sheets[wb.SheetNames[0]];
        workbookData = XLSX.utils.sheet_to_json(sheet, { header: 1 });
        alert("📁 تم تحميل الملف بنجاح!");
      };
      reader.readAsArrayBuffer(file);
    });

    function processExcel() {
      const output = document.getElementById("results");
      output.innerHTML = "";

      if (workbookData.length === 0) {
        alert("📄 لم يتم تحميل أي ملف بعد.");
        return;
      }

      for (let i = 1; i < workbookData.length; i++) {
        const row = workbookData[i];

        for (let cell of row) {
          if (typeof cell === "string" && cell.includes("N") && cell.includes("E")) {
            const parsed = parseCoords(cell);
            if (!parsed) continue;

            const { latDecimal, lonDecimal, mapLink } = parsed;

            const div = document.createElement("div");
            div.className = "result";
            div.innerHTML = `
              <h3>🗺️ النتيجة ${i}</h3>
              <div class="coord"><strong>الإحداثيات الأصلية:</strong> ${cell}</div>
              <div class="coord"><strong>Decimal:</strong> ${latDecimal.toFixed(7)}, ${lonDecimal.toFixed(7)}</div>
              <a class="maplink" href="${mapLink}" target="_blank">🌍 فتح في خرائط Google</a>
              <div style="margin-top: 10px;">
                <iframe src="https://maps.google.com/maps?q=${latDecimal},${lonDecimal}&z=16&output=embed"></iframe>
              </div>
            `;
            output.appendChild(div);
            break; // stop at first coordinate per row
          }
        }
      }

      if (!output.innerHTML) {
        output.innerHTML = "<p>❌ لم يتم العثور على إحداثيات في الملف.</p>";
      }
    }

    function parseCoords(cell) {
      const regex = /N\s*(\d+)\s*E\s*(\d+)/i;
      const match = cell.match(regex);
      if (!match) return null;

      const latRaw = match[1]; // مثل 3121258
      const lonRaw = match[2]; // مثل 2713105

      const latDecimal = convertDMS(latRaw);
      const lonDecimal = convertDMS(lonRaw);

      if (latDecimal > 90 || lonDecimal > 180) return null;

      return {
        latDecimal,
        lonDecimal,
        mapLink: `https://www.google.com/maps?q=${latDecimal},${lonDecimal}&z=16`
      };
    }

    function convertDMS(dmsStr) {
      dmsStr = dmsStr.padStart(7, '0');
      const deg = parseInt(dmsStr.substring(0, 2));
      const min = parseInt(dmsStr.substring(2, 4));
      const sec = parseInt(dmsStr.substring(4, 6));
      return deg + (min / 60) + (sec / 3600);
    }
  </script>
</body>
</html>