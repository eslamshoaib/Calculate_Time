<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>قارئ ملفات KML المحترف - نظام تحليل المواقع المتقدم</title>
    
    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <!-- Additional Libraries -->
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* الوضع الليلي */
        body.night-mode {
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
        }
        
        body.night-mode .control-card,
        body.night-mode .options-panel,
        body.night-mode .data-panel,
        body.night-mode .point-card,
        body.night-mode .stat-card,
        body.night-mode .distance-tools {
            background: rgba(0, 0, 0, 0.3);
            border-color: rgba(255, 255, 255, 0.1);
        }
        
        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 30px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            backdrop-filter: blur(15px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        h1 {
            font-size: 3rem;
            margin-bottom: 15px;
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.5);
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .subtitle {
            font-size: 1.3rem;
            opacity: 0.9;
        }
        
        /* لوحة التحكم الرئيسية */
        .control-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .control-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }
        
        .control-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .control-card h3 {
            color: #ffd700;
            margin-bottom: 20px;
            font-size: 1.4rem;
            text-align: center;
        }
        
        /* أزرار ملونة */
        .btn {
            background: linear-gradient(45deg, #f093fb, #f5576c);
            color: white;
            border: none;
            border-radius: 25px;
            padding: 12px 25px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            margin: 5px;
            font-size: 14px;
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }
        
        .btn-primary { background: linear-gradient(45deg, #667eea, #764ba2); }
        .btn-success { background: linear-gradient(45deg, #56ab2f, #a8e063); }
        .btn-info { background: linear-gradient(45deg, #2196F3, #21CBF3); }
        .btn-warning { background: linear-gradient(45deg, #f2994a, #f2c94c); }
        .btn-danger { background: linear-gradient(45deg, #eb3349, #f45c43); }
        
        /* المحتوى الرئيسي */
        .main-content {
            display: grid;
            grid-template-columns: 350px 1fr 400px;
            gap: 20px;
            height: calc(100vh - 200px);
        }
        
        /* لوحة الخيارات */
        .options-panel {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            overflow-y: auto;
        }
        
        .options-panel h3 {
            color: #ffd700;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.5rem;
        }
        
        .option-group {
            margin-bottom: 25px;
        }
        
        .option-group h4 {
            color: #4ECDC4;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }
        
        .option-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid transparent;
            display: flex;
            align-items: center;
        }
        
        .option-item:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.3);
            transform: translateX(-8px);
        }
        
        .option-item.active {
            background: linear-gradient(45deg, rgba(76, 205, 196, 0.3), rgba(78, 205, 196, 0.1));
            border-color: #4ECDC4;
        }
        
        .option-item i {
            margin-left: 15px;
            color: #4ECDC4;
            font-size: 1.2rem;
            width: 25px;
        }
        
        /* منطقة الخريطة */
        .map-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            overflow: hidden;
            position: relative;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4);
        }
        
        #map {
            width: 100%;
            height: 100%;
            min-height: 600px;
        }
        
        .map-controls {
            position: absolute;
            top: 15px;
            left: 15px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .map-btn {
            background: rgba(255, 255, 255, 0.95);
            border: none;
            border-radius: 12px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            color: #333;
            font-size: 18px;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .map-btn:hover {
            background: #fff;
            transform: scale(1.1);
        }
        
        /* لوحة البيانات */
        .data-panel {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            overflow-y: auto;
        }
        
        .data-panel h3 {
            color: #ffd700;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.5rem;
        }
        
        /* صندوق البحث */
        .search-box {
            position: relative;
            margin-bottom: 20px;
        }
        
        .search-box input {
            width: 100%;
            padding: 15px 50px 15px 20px;
            border: none;
            border-radius: 30px;
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
            font-size: 16px;
            direction: rtl;
        }
        
        .search-box input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }
        
        .search-box i {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: rgba(255, 255, 255, 0.7);
            font-size: 18px;
        }
        
        /* الإحصائيات */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            border-radius: 15px;
            padding: 20px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #4ECDC4;
            margin-bottom: 8px;
        }
        
        .stat-label {
            font-size: 1rem;
            opacity: 0.9;
        }
        
        /* أدوات القياس */
        .distance-tools {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.15), rgba(255, 255, 255, 0.05));
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
        }
        
        .distance-tools h4 {
            color: #4ECDC4;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .point-selector {
            margin-bottom: 15px;
        }
        
        .point-selector select {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
            font-size: 15px;
            direction: rtl;
        }
        
        .distance-result {
            background: linear-gradient(135deg, rgba(76, 205, 196, 0.3), rgba(76, 205, 196, 0.1));
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            margin-top: 15px;
        }
        
        /* بطاقات النقاط */
        .point-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.15), rgba(255, 255, 255, 0.05));
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }
        
        .point-card:hover {
            transform: translateX(-8px);
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.25), rgba(255, 255, 255, 0.1));
        }
        
        .point-number {
            position: absolute;
            top: -10px;
            right: -10px;
            background: linear-gradient(45deg, #FF6B6B, #ff8e8e);
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
        }
        
        .point-name {
            font-weight: bold;
            font-size: 1.2rem;
            margin-bottom: 10px;
            color: #ffd700;
        }
        
        .point-coords {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-bottom: 10px;
        }
        
        .point-description {
            font-size: 0.95rem;
            line-height: 1.5;
            opacity: 0.9;
        }
        
        .point-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }
        
        .point-action-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 8px;
            padding: 8px 15px;
            color: #fff;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s ease;
            flex: 1;
        }
        
        .point-action-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        /* العلامات المخصصة */
        .custom-marker {
            background: linear-gradient(45deg, #f093fb, #f5576c);
            border: 3px solid #fff;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
            font-size: 16px;
        }
        
        .highlighted-marker {
            background: linear-gradient(45deg, #FF6B6B, #ff8e8e) !important;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }
        
        /* أسهم الاتجاه */
        .direction-arrow {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            width: 30px;
            height: 30px;
            background: #4ECDC4;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }
        
        /* خطوط المسافة */
        .distance-line {
            stroke: #FF6B6B;
            stroke-width: 4;
            fill: none;
            animation: dash 20s linear infinite;
        }
        
        @keyframes dash {
            to { stroke-dashoffset: -1000; }
        }
        
        /* الرسائل */
        .message {
            position: fixed;
            top: 30px;
            left: 50%;
            transform: translateX(-50%);
            padding: 20px 30px;
            border-radius: 50px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
            z-index: 3000;
            font-weight: bold;
            font-size: 16px;
            animation: slideDown 0.5s ease;
        }
        
        .message.success {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
        }
        
        .message.error {
            background: linear-gradient(45deg, #f44336, #d32f2f);
            color: white;
        }
        
        .message.info {
            background: linear-gradient(45deg, #2196F3, #1976D2);
            color: white;
        }
        
        @keyframes slideDown {
            from { transform: translate(-50%, -100px); opacity: 0; }
            to { transform: translate(-50%, 0); opacity: 1; }
        }
        
        @keyframes slideUp {
            from { transform: translate(-50%, 0); opacity: 1; }
            to { transform: translate(-50%, -100px); opacity: 0; }
        }
        
        /* نافذة التقرير */
        .report-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2500;
        }
        
        .report-content {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            border-radius: 20px;
            padding: 40px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            direction: rtl;
            color: #fff;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }
        
        /* الخريطة الحرارية */
        .heat-map-legend {
            position: absolute;
            bottom: 30px;
            right: 30px;
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 10px;
            z-index: 1000;
            direction: ltr;
        }
        
        /* الشجرة التفاعلية */
        .tree-view {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .tree-node {
            margin: 10px 0;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .tree-node:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateX(-5px);
        }
        
        .tree-node.expanded::before {
            content: '▼';
            margin-left: 10px;
        }
        
        .tree-node.collapsed::before {
            content: '▶';
            margin-left: 10px;
        }
        
        .tree-children {
            margin-right: 20px;
            display: none;
        }
        
        .tree-children.show {
            display: block;
        }
        
        .tree-leaf {
            margin: 5px 0;
            padding: 8px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 5px;
            font-size: 0.9rem;
        }
        
        /* Responsive */
        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
                height: auto;
            }
            
            .options-panel,
            .data-panel {
                max-height: 500px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-map-marked-alt"></i> قارئ ملفات KML المحترف</h1>
            <p class="subtitle">نظام تحليل المواقع المتقدم - تحديد أكثر الأماكن نشاطاً</p>
        </header>
        
        <div class="control-panel">
            <div class="control-card">
                <h3><i class="fas fa-upload"></i> تحميل البيانات</h3>
                <div class="file-input-wrapper">
                    <input type="file" id="kmlFile" accept=".kml,.kmz" style="display: none;">
                    <button class="btn btn-primary" onclick="document.getElementById('kmlFile').click()">
                        <i class="fas fa-file-upload"></i> اختر ملف KML
                    </button>
                </div>
                <div style="margin-top: 15px;">
                    <button class="btn btn-info" onclick="loadFromUrl()">
                        <i class="fas fa-link"></i> تحميل من رابط
                    </button>
                    <button class="btn btn-success" onclick="loadSampleData()">
                        <i class="fas fa-database"></i> بيانات تجريبية
                    </button>
                </div>
            </div>
            
            <div class="control-card">
                <h3><i class="fas fa-cogs"></i> الإعدادات السريعة</h3>
                <button class="btn btn-warning" onclick="toggleNightMode()">
                    <i class="fas fa-moon"></i> الوضع الليلي
                </button>
                <button class="btn btn-info" onclick="toggleMapType()">
                    <i class="fas fa-map"></i> نوع الخريطة
                </button>
                <button class="btn btn-success" onclick="exportData()">
                    <i class="fas fa-download"></i> تصدير البيانات
                </button>
                <button class="btn btn-danger" onclick="clearAllData()">
                    <i class="fas fa-trash"></i> مسح الكل
                </button>
            </div>
        </div>
        
        <div class="main-content">
            <!-- لوحة الخيارات -->
            <div class="options-panel">
                <h3><i class="fas fa-tools"></i> الأدوات المتقدمة</h3>
                
                <div class="option-group">
                    <h4><i class="fas fa-ruler"></i> أدوات القياس</h4>
                    <div class="option-item" onclick="activateDistanceMode()">
                        <i class="fas fa-ruler-horizontal"></i> قياس المسافة
                    </div>
                    <div class="option-item" onclick="activateRouteMode()">
                        <i class="fas fa-route"></i> رسم المسارات
                    </div>
                    <div class="option-item" onclick="calculateAllDistances()">
                        <i class="fas fa-calculator"></i> جميع المسافات
                    </div>
                    <div class="option-item" onclick="showDistanceMatrix()">
                        <i class="fas fa-th"></i> مصفوفة المسافات
                    </div>
                </div>
                
                <div class="option-group">
                    <h4><i class="fas fa-map-pin"></i> إدارة النقاط</h4>
                    <div class="option-item" onclick="renumberPoints()">
                        <i class="fas fa-sort-numeric-up"></i> إعادة ترقيم
                    </div>
                    <div class="option-item" onclick="highlightRandomPoint()">
                        <i class="fas fa-star"></i> تمييز عشوائي
                    </div>
                    <div class="option-item" onclick="clearHighlights()">
                        <i class="fas fa-eraser"></i> مسح التمييز
                    </div>
                    <div class="option-item" onclick="clusterPoints()">
                        <i class="fas fa-object-group"></i> تجميع النقاط
                    </div>
                </div>
                
                <div class="option-group">
                    <h4><i class="fas fa-chart-bar"></i> التحليل والإحصائيات</h4>
                    <div class="option-item" onclick="generateReport()">
                        <i class="fas fa-file-alt"></i> تقرير إحصائي
                    </div>
                    <div class="option-item" onclick="showHeatmap()">
                        <i class="fas fa-fire"></i> خريطة حرارية
                    </div>
                    <div class="option-item" onclick="analyzeDistribution()">
                        <i class="fas fa-chart-pie"></i> تحليل التوزيع
                    </div>
                    <div class="option-item" onclick="findOptimalLocation()">
                        <i class="fas fa-crosshairs"></i> الموقع الأمثل
                    </div>
                </div>
                
                <div class="option-group">
                    <h4><i class="fas fa-share-alt"></i> المشاركة والطباعة</h4>
                    <div class="option-item" onclick="shareMap()">
                        <i class="fas fa-share-alt"></i> مشاركة الخريطة
                    </div>
                    <div class="option-item" onclick="printMap()">
                        <i class="fas fa-print"></i> طباعة الخريطة
                    </div>
                    <div class="option-item" onclick="saveScreenshot()">
                        <i class="fas fa-camera"></i> حفظ صورة
                    </div>
                    <div class="option-item" onclick="toggleFullscreen()">
                        <i class="fas fa-expand"></i> ملء الشاشة
                    </div>
                </div>
                
                <div class="option-group">
                    <h4><i class="fas fa-tree"></i> عرض الشجري</h4>
                    <div class="option-item" onclick="showLocationTree()">
                        <i class="fas fa-sitemap"></i> شجرة المواقع
                    </div>
                    <div class="option-item" onclick="findTopLocations()">
                        <i class="fas fa-trophy"></i> أفضل المواقع
                    </div>
                    <div class="option-item" onclick="analyzeActivity()">
                        <i class="fas fa-chart-line"></i> تحليل النشاط
                    </div>
                    <div class="option-item" onclick="showLocationClusters()">
                        <i class="fas fa-layer-group"></i> تجميع المواقع
                    </div>
                </div>
            </div>
            
            <!-- منطقة الخريطة -->
            <div class="map-section">
                <div id="map"></div>
                <div class="map-controls">
                    <button class="map-btn" onclick="zoomIn()" title="تكبير">
                        <i class="fas fa-plus"></i>
                    </button>
                    <button class="map-btn" onclick="zoomOut()" title="تصغير">
                        <i class="fas fa-minus"></i>
                    </button>
                    <button class="map-btn" onclick="resetView()" title="إعادة تعيين">
                        <i class="fas fa-home"></i>
                    </button>
                    <button class="map-btn" onclick="locateUser()" title="موقعي">
                        <i class="fas fa-location-arrow"></i>
                    </button>
                </div>
                <div class="map-layer-selector" style="position: absolute; top: 15px; right: 15px; z-index: 1000;">
                    <select id="mapLayerSelect" onchange="changeMapLayer()" style="background: rgba(255,255,255,0.9); border: none; border-radius: 8px; padding: 8px; color: #333;">
                        <option value="osm">OpenStreetMap</option>
                        <option value="satellite">Satellite</option>
                        <option value="terrain">Terrain</option>
                        <option value="dark">Dark Mode</option>
                    </select>
                </div>
            </div>
            
            <!-- لوحة البيانات -->
            <div class="data-panel">
                <h3><i class="fas fa-database"></i> البيانات والتحليل</h3>
                
                <div class="tree-view" id="locationTree" style="display: none;">
                    <h4 style="color: #ffd700; margin-bottom: 15px;">شجرة المواقع</h4>
                    <div id="treeContent"></div>
                </div>
                
                <div class="distance-tools">
                    <h4><i class="fas fa-ruler"></i> قياس المسافة</h4>
                    
                    <div class="point-selector">
                        <select id="point1Select">
                            <option value="">اختر النقطة الأولى</option>
                        </select>
                    </div>
                    
                    <div class="point-selector">
                        <select id="point2Select">
                            <option value="">اختر النقطة الثانية</option>
                        </select>
                    </div>
                    
                    <button class="btn btn-primary" onclick="calculateDistance()" style="width: 100%; margin-top: 15px;">
                        <i class="fas fa-calculator"></i> احسب المسافة
                    </button>
                    
                    <div class="distance-result" id="distanceResult" style="display: none;">
                        <div><strong>المسافة المستقيمة:</strong> <span id="straightDistance">0</span> كم</div>
                        <div><strong>المسافة بالطريق:</strong> <span id="roadDistance">0</span> كم</div>
                        <div><strong>الاتجاه:</strong> <span id="direction">0</span>°</div>
                        <div><strong>الوقت التقديري:</strong> <span id="estimatedTime">0</span> دقيقة</div>
                    </div>
                </div>
                
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="ابحث عن نقطة..." onkeyup="searchPoints()">
                    <i class="fas fa-search"></i>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalPoints">0</div>
                        <div class="stat-label">إجمالي النقاط</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="selectedPoints">0</div>
                        <div class="stat-label">النقاط المميزة</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalRoutes">0</div>
                        <div class="stat-label">المسارات</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="avgDistance">0</div>
                        <div class="stat-label">متوسط المسافة</div>
                    </div>
                </div>
                
                <div id="pointsList">
                    <div class="empty-state">
                        <i class="fas fa-map-marked" style="font-size: 3rem; margin-bottom: 15px; color: #4ECDC4;"></i>
                        <p>ارفع ملف KML لعرض النقاط هنا</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- نافذة التقرير -->
    <div class="report-modal" id="reportModal">
        <div class="report-content">
            <div class="report-header">
                <h2><i class="fas fa-chart-line"></i> التقرير الإحصائي الشامل</h2>
                <button class="close-btn" onclick="closeReport()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="report-section">
                <h3>إحصائيات عامة</h3>
                <div class="report-grid">
                    <div class="report-item">
                        <div class="report-value" id="reportTotalPoints">0</div>
                        <div class="report-label">إجمالي النقاط</div>
                    </div>
                    <div class="report-item">
                        <div class="report-value" id="reportTotalRoutes">0</div>
                        <div class="report-label">إجمالي المسارات</div>
                    </div>
                    <div class="report-item">
                        <div class="report-value" id="reportAvgDistance">0</div>
                        <div class="report-label">متوسط المسافة (كم)</div>
                    </div>
                    <div class="report-item">
                        <div class="report-value" id="reportMaxDistance">0</div>
                        <div class="report-label">أقصى مسافة (كم)</div>
                    </div>
                </div>
            </div>
            
            <div class="report-section">
                <h3>تحليل التوزيع الجغرافي</h3>
                <div class="report-grid">
                    <div class="report-item">
                        <div class="report-value" id="reportNorthPoint">-</div>
                        <div class="report-label">أقصى الشمال</div>
                    </div>
                    <div class="report-item">
                        <div class="report-value" id="reportSouthPoint">-</div>
                        <div class="report-label">أقصى الجنوب</div>
                    </div>
                    <div class="report-item">
                        <div class="report-value" id="reportEastPoint">-</div>
                        <div class="report-label">أقصى الشرق</div>
                    </div>
                    <div class="report-item">
                        <div class="report-value" id="reportWestPoint">-</div>
                        <div class="report-label">أقصى الغرب</div>
                    </div>
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 30px;">
                <button class="btn btn-primary" onclick="exportReport()">
                    <i class="fas fa-download"></i> تصدير التقرير
                </button>
                <button class="btn btn-success" onclick="printReport()">
                    <i class="fas fa-print"></i> طباعة التقرير
                </button>
            </div>
        </div>
    </div>

    <script>
        let map;
        let markers = [];
        let points = [];
        let routes = [];
        let currentLayer;
        let distanceMode = false;
        let routeMode = false;
        let distanceLine = null;
        let routePoints = [];
        let routeLine = null;
        let pointCounter = 1;
        let selectedPointsForDistance = [];
        let heatLayer = null;
        let locationClusters = {};
        
        // تهيئة الخريطة
        function initMap() {
            map = L.map('map').setView([31.2, 29.9], 7);
            
            // طبقات الخريطة
            const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            });
            
            const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: '© Esri'
            });
            
            const terrainLayer = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenTopoMap contributors'
            });
            
            const darkLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '© CARTO'
            });
            
            currentLayer = osmLayer;
            currentLayer.addTo(map);
            
            // تخزين الطبقات
            map.layers = {
                osm: osmLayer,
                satellite: satelliteLayer,
                terrain: terrainLayer,
                dark: darkLayer
            };
            
            // معالجة النقر على الخريطة
            map.on('click', function(e) {
                if (distanceMode) {
                    addDistancePoint(e.latlng);
                } else if (routeMode) {
                    addRoutePoint(e.latlng);
                }
            });
        }
        
        // تغيير طبقة الخريطة
        function changeMapLayer() {
            const layerType = document.getElementById('mapLayerSelect').value;
            if (currentLayer) {
                map.removeLayer(currentLayer);
            }
            currentLayer = map.layers[layerType];
            currentLayer.addTo(map);
        }
        
        // معالجة رفع الملف
        document.getElementById('kmlFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                parseKMLData(e.target.result);
            };
            reader.readAsText(file);
        });
        
        // تحليل بيانات KML
        function parseKMLData(kmlData) {
            try {
                clearMap();
                pointCounter = 1;
                locationClusters = {};
                
                const xmlDoc = $.parseXML(kmlData);
                const $xml = $(xmlDoc);
                
                const placemarks = $xml.find('Placemark').get();
                
                // استخراج قيم COUNT وترتيب النقاط
                const pointsWithCount = [];
                
                placemarks.forEach(function(placemark) {
                    const $placemark = $(placemark);
                    const name = $placemark.find('name').text();
                    const description = $placemark.find('description').text();
                    
                    // استخراج قيمة COUNT
                    const countMatch = description.match(/Count:\s*(\d+)/);
                    const count = countMatch ? parseInt(countMatch[1]) : 0;
                    
                    // استخراج قيمة AZMITH
                    const azmithMatch = description.match(/AZMITH:\s*(\d+)/);
                    const azmith = azmithMatch ? parseInt(azmithMatch[1]) : null;
                    
                    const $point = $placemark.find('Point');
                    if ($point.length > 0) {
                        const coordsText = $point.find('coordinates').text();
                        const coords = coordsText.split(',');
                        
                        if (coords.length >= 2) {
                            const lng = parseFloat(coords[0]);
                            const lat = parseFloat(coords[1]);
                            
                            if (!isNaN(lat) && !isNaN(lng)) {
                                pointsWithCount.push({
                                    lat, lng, name, description, count, azmith
                                });
                            }
                        }
                    }
                });
                
                // ترتيب النقاط حسب COUNT من الأعلى للأقل
                pointsWithCount.sort((a, b) => b.count - a.count);
                
                // تجميع النقاط حسب الإحداثيات المتقاربة
                pointsWithCount.forEach(function(pointData) {
                    const coordKey = `${pointData.lat.toFixed(4)},${pointData.lng.toFixed(4)}`;
                    
                    if (!locationClusters[coordKey]) {
                        locationClusters[coordKey] = {
                            lat: pointData.lat,
                            lng: pointData.lng,
                            points: [],
                            totalCount: 0
                        };
                    }
                    
                    locationClusters[coordKey].points.push(pointData);
                    locationClusters[coordKey].totalCount += pointData.count;
                });
                
                // إضافة النقاط المرتبطة للخريطة
                Object.keys(locationClusters).forEach(function(coordKey) {
                    const cluster = locationClusters[coordKey];
                    addClusterToMap(cluster);
                });
                
                updateStats();
                updatePointSelectors();
                displayPoints();
                buildLocationTree();
                
                if (markers.length > 0) {
                    const group = new L.featureGroup(markers);
                    map.fitBounds(group.getBounds().pad(0.1));
                }
                
                showMessage(`تم تحميل ${points.length} نقطة في ${Object.keys(locationClusters).length} موقع`, 'success');
                
            } catch (error) {
                console.error('Error parsing KML:', error);
                showMessage('حدث خطأ في تحليل الملف', 'error');
            }
        }
        
        // إضافة مجموعة نقاط للخريطة
        function addClusterToMap(cluster) {
            // إنشاء أيقونة مخصصة تعرض إجمالي COUNT
            const iconHtml = cluster.totalCount.toString();
            
            const marker = L.marker([cluster.lat, cluster.lng], {
                icon: L.divIcon({
                    className: 'custom-marker',
                    html: iconHtml,
                    iconSize: [40, 40],
                    iconAnchor: [20, 40]
                })
            }).addTo(map);
            
            // إنشاء محتوى النافذة المنبثقة
            const popupContent = `
                <div style="direction: rtl; text-align: right;">
                    <h3 style="margin: 0 0 15px 0; color: #667eea; font-size: 1.3rem;">الموقع: ${cluster.lat.toFixed(4)}, ${cluster.lng.toFixed(4)}</h3>
                    <p style="margin: 0 0 15px 0; font-size: 1.1rem;"><strong>إجمالي المكالمات:</strong> ${cluster.totalCount}</p>
                    <p style="margin: 0 0 15px 0; font-size: 0.9rem;"><strong>عدد النقاط:</strong> ${cluster.points.length}</p>
                    <div style="margin-top: 15px;">
                        <button onclick="showClusterDetails('${cluster.lat},${cluster.lng}')" style="background: #4ECDC4; border: none; color: white; padding: 8px 15px; border-radius: 8px; cursor: pointer; font-size: 13px; margin: 5px;">
                            <i class="fas fa-info-circle"></i> التفاصيل
                        </button>
                        <button onclick="highlightCluster('${cluster.lat},${cluster.lng}')" style="background: #FFD166; border: none; color: white; padding: 8px 15px; border-radius: 8px; cursor: pointer; font-size: 13px; margin: 5px;">
                            <i class="fas fa-star"></i> تمييز
                        </button>
                    </div>
                </div>
            `;
            marker.bindPopup(popupContent);
            
            // تخزين مرجع للمجموعة
            marker.clusterData = cluster;
            
            markers.push(marker);
            
            // إضافة جميع النقاط الفردية
            cluster.points.forEach(function(pointData) {
                addPointToMap(pointData.lat, pointData.lng, pointData.name, pointData.description, pointData.count, pointData.azmith, false);
            });
        }
        
        // إضافة نقطة للخريطة
        function addPointToMap(lat, lng, name, description, count, azmith, showMarker = true) {
            if (!showMarker) return;
            
            // إنشاء أيقونة مخصصة
            const iconHtml = count.toString();
            
            const marker = L.marker([lat, lng], {
                icon: L.divIcon({
                    className: 'custom-marker',
                    html: iconHtml,
                    iconSize: [30, 30],
                    iconAnchor: [15, 30]
                })
            }).addTo(map);
            
            // إضافة سهم الاتجاه إذا وجدت قيمة AZMITH
            if (azmith !== null) {
                const arrowIcon = L.divIcon({
                    className: 'direction-arrow',
                    html: getArrowIcon(azmith),
                    iconSize: [25, 25],
                    iconAnchor: [12.5, 12.5]
                });
                
                const arrowMarker = L.marker([lat, lng], {
                    icon: arrowIcon
                }).addTo(map);
                
                markers.push(arrowMarker);
            }
            
            // إنشاء محتوى النافذة المنبثقة
            const popupContent = `
                <div style="direction: rtl; text-align: right;">
                    <h3 style="margin: 0 0 15px 0; color: #667eea; font-size: 1.3rem;">${name}</h3>
                    <p style="margin: 0; line-height: 1.6; white-space: pre-wrap; font-size: 14px;">${description}</p>
                    ${azmith !== null ? `<p style="margin: 10px 0 0 0; color: #4ECDC4;"><strong>الاتجاه:</strong> ${azmith}°</p>` : ''}
                    <div style="margin-top: 15px; display: flex; gap: 10px;">
                        <button onclick="highlightPoint(${points.length})" style="background: #4ECDC4; border: none; color: white; padding: 8px 15px; border-radius: 8px; cursor: pointer; font-size: 13px;">
                            <i class="fas fa-star"></i> تمييز
                        </button>
                        <button onclick="selectForDistance(${points.length})" style="background: #FFD166; border: none; color: white; padding: 8px 15px; border-radius: 8px; cursor: pointer; font-size: 13px;">
                            <i class="fas fa-ruler"></i> قياس
                        </button>
                    </div>
                </div>
            `;
            marker.bindPopup(popupContent);
            
            const point = {
                id: points.length,
                number: pointCounter++,
                name: name,
                description: description,
                position: { lat, lng },
                marker: marker,
                count: count,
                azmith: azmith
            };
            
            points.push(point);
            markers.push(marker);
            
            return point;
        }
        
        // الحصول على أيقونة السهم حسب الزاوية
        function getArrowIcon(azmith) {
            // تحويل الزاوية إلى رمز سهم مناسب
            const arrows = ['↑', '↗', '→', '↘', '↓', '↙', '←', '↖'];
            const index = Math.round(azmith / 45) % 8;
            return arrows[index];
        }
        
        // عرض تفاصيل المجموعة
        function showClusterDetails(coordKey) {
            const cluster = locationClusters[coordKey];
            if (!cluster) return;
            
            let detailsHTML = `
                <div style="direction: rtl; text-align: right; padding: 20px; background: white; color: black; border-radius: 15px; max-width: 500px; max-height: 400px; overflow-y: auto;">
                    <h3 style="color: #667eea; margin-bottom: 15px;">تفاصيل الموقع</h3>
                    <p><strong>الإحداثيات:</strong> ${cluster.lat.toFixed(6)}, ${cluster.lng.toFixed(6)}</p>
                    <p><strong>إجمالي المكالمات:</strong> ${cluster.totalCount}</p>
                    <p><strong>عدد النقاط:</strong> ${cluster.points.length}</p>
                    <h4 style="margin: 15px 0 10px 0; color: #4ECDC4;">النقاط في هذا الموقع:</h4>
            `;
            
            cluster.points.forEach(function(point, index) {
                detailsHTML += `
                    <div style="background: #f8f9fa; padding: 10px; margin: 5px 0; border-radius: 5px;">
                        <strong>${point.name}</strong> - Count: ${point.count}
                        ${point.azmith !== null ? `<br><small>الاتجاه: ${point.azmith}°</small>` : ''}
                    </div>
                `;
            });
            
            detailsHTML += '</div>';
            
            L.popup()
                .setLatLng([cluster.lat, cluster.lng])
                .setContent(detailsHTML)
                .openOn(map);
        }
        
        // تمييز مجموعة
        function highlightCluster(coordKey) {
            const cluster = locationClusters[coordKey];
            if (!cluster) return;
            
            // تمييز جميع النقاط في المجموعة
            cluster.points.forEach(function(pointData) {
                const point = points.find(p => 
                    p.position.lat === pointData.lat && p.position.lng === pointData.lng
                );
                if (point) {
                    highlightPoint(points.indexOf(point));
                }
            });
        }
        
        // بناء شجرة المواقع
        function buildLocationTree() {
            const treeContent = document.getElementById('treeContent');
            treeContent.innerHTML = '';
            
            // ترتيب المواقع حسب إجمالي COUNT
            const sortedClusters = Object.values(locationClusters).sort((a, b) => b.totalCount - a.totalCount);
            
            sortedClusters.forEach(function(cluster, index) {
                const treeNode = document.createElement('div');
                treeNode.className = 'tree-node collapsed';
                treeNode.innerHTML = `
                    <strong>الموقع ${index + 1}</strong> - ${cluster.totalCount} مكالمة (${cluster.points.length} نقطة)
                `;
                
                const treeChildren = document.createElement('div');
                treeChildren.className = 'tree-children';
                
                cluster.points.forEach(function(point) {
                    const treeLeaf = document.createElement('div');
                    treeLeaf.className = 'tree-leaf';
                    treeLeaf.innerHTML = `
                        ${point.name} - Count: ${point.count}
                        ${point.azmith !== null ? `<br><small>الاتجاه: ${point.azmith}°</small>` : ''}
                    `;
                    treeChildren.appendChild(treeLeaf);
                });
                
                treeNode.appendChild(treeChildren);
                treeNode.onclick = function() {
                    toggleTreeNode(this);
                    map.setView([cluster.lat, cluster.lng], 15);
                };
                
                treeContent.appendChild(treeNode);
            });
            
            document.getElementById('locationTree').style.display = 'block';
        }
        
        // تبديل حالة عقدة الشجرة
        function toggleTreeNode(node) {
            const children = node.querySelector('.tree-children');
            if (children) {
                children.classList.toggle('show');
                node.classList.toggle('expanded');
                node.classList.toggle('collapsed');
            }
        }
        
        // عرض شجرة المواقع
        function showLocationTree() {
            const treePanel = document.getElementById('locationTree');
            treePanel.style.display = treePanel.style.display === 'none' ? 'block' : 'none';
            showMessage(treePanel.style.display === 'block' ? 'تم فتح شجرة المواقع' : 'تم إغلاق شجرة المواقع', 'info');
        }
        
        // إيجاد أفضل المواقع
        function findTopLocations() {
            if (Object.keys(locationClusters).length === 0) {
                showMessage('لا توجد بيانات لتحليلها', 'error');
                return;
            }
            
            const sortedClusters = Object.values(locationClusters).sort((a, b) => b.totalCount - a.totalCount);
            const top3 = sortedClusters.slice(0, 3);
            
            let content = `
                <div style="direction: rtl; text-align: right; padding: 20px; background: white; color: black; border-radius: 15px;">
                    <h3 style="color: #667eea; margin-bottom: 15px;">أفضل 3 مواقع</h3>
            `;
            
            top3.forEach(function(cluster, index) {
                content += `
                    <div style="background: ${index === 0 ? '#ffd700' : index === 1 ? '#c0c0c0' : '#cd7f32'}; color: black; padding: 15px; margin: 10px 0; border-radius: 10px;">
                        <h4>المركز ${index + 1}</h4>
                        <p><strong>المكالمات:</strong> ${cluster.totalCount}</p>
                        <p><strong>الإحداثيات:</strong> ${cluster.lat.toFixed(4)}, ${cluster.lng.toFixed(4)}</p>
                        <p><strong>عدد النقاط:</strong> ${cluster.points.length}</p>
                    </div>
                `;
            });
            
            content += '</div>';
            
            L.popup()
                .setLatLng(map.getCenter())
                .setContent(content)
                .openOn(map);
        }
        
        // تحليل النشاط
        function analyzeActivity() {
            if (points.length === 0) {
                showMessage('لا توجد بيانات لتحليلها', 'error');
                return;
            }
            
            // تحليل النشاط حسب الساعة (افتراضي)
            const hourlyActivity = new Array(24).fill(0);
            
            points.forEach(function(point) {
                // توزيع عشوائي للنشاط (للعرض فقط)
                for (let i = 0; i < point.count; i++) {
                    const hour = Math.floor(Math.random() * 24);
                    hourlyActivity[hour]++;
                }
            });
            
            const maxHour = hourlyActivity.indexOf(Math.max(...hourlyActivity));
            
            const content = `
                <div style="direction: rtl; text-align: right; padding: 20px; background: white; color: black; border-radius: 15px;">
                    <h3 style="color: #667eea; margin-bottom: 15px;">تحليل النشاط</h3>
                    <p><strong>أكثر ساعات نشاطاً:</strong> ${maxHour}:00 - ${(maxHour + 1) % 24}:00</p>
                    <p><strong>عدد المكالمات في هذه الساعة:</strong> ${hourlyActivity[maxHour]}</p>
                    <div style="margin-top: 15px;">
                        <strong>توزيع النشاط:</strong>
                        <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 5px; margin-top: 10px;">
            `;
            
            hourlyActivity.forEach(function(count, hour) {
                const intensity = count / Math.max(...hourlyActivity);
                const color = `hsl(${120 - intensity * 120}, 70%, 50%)`;
                content += `<div style="background: ${color}; color: white; padding: 5px; text-align: center; font-size: 12px; border-radius: 3px;">${hour}:00<br>${count}</div>`;
            });
            
            content += `
                        </div>
                    </div>
                </div>
            `;
            
            L.popup()
                .setLatLng(map.getCenter())
                .setContent(content)
                .openOn(map);
        }
        
        // عرض تجميعات المواقع
        function showLocationClusters() {
            if (Object.keys(locationClusters).length === 0) {
                showMessage('لا توجد بيانات لعرضها', 'error');
                return;
            }
            
            // إنشاء خريطة حرارية للمواقع
            if (heatLayer) {
                map.removeLayer(heatLayer);
                heatLayer = null;
            }
            
            const heatData = Object.values(locationClusters).map(cluster => [
                cluster.lat, 
                cluster.lng, 
                cluster.totalCount / 100
            ]);
            
            heatLayer = L.heatLayer(heatData, {
                radius: 25,
                blur: 15,
                maxZoom: 17,
                max: 1.0,
                gradient: {
                    0.0: 'blue',
                    0.25: 'cyan',
                    0.5: 'lime',
                    0.75: 'yellow',
                    1.0: 'red'
                }
            }).addTo(map);
            
            showMessage('تم عرض تجميعات المواقع على الخريطة الحرارية', 'success');
        }
        
        // تحديث الإحصائيات
        function updateStats() {
            document.getElementById('totalPoints').textContent = points.length;
            document.getElementById('totalRoutes').textContent = routes.length;
            
            const highlightedCount = points.filter(p => p.marker.getElement().classList.contains('highlighted-marker')).length;
            document.getElementById('selectedPoints').textContent = highlightedCount;
            
            // حساب متوسط المسافة
            if (points.length > 1) {
                let totalDistance = 0;
                let count = 0;
                
                for (let i = 0; i < points.length; i++) {
                    for (let j = i + 1; j < points.length; j++) {
                        const distance = calculateHaversineDistance(
                            points[i].position.lat, points[i].position.lng,
                            points[j].position.lat, points[j].position.lng
                        );
                        totalDistance += distance;
                        count++;
                    }
                }
                
                const avgDistance = count > 0 ? (totalDistance / count / 1000).toFixed(1) : 0;
                document.getElementById('avgDistance').textContent = avgDistance;
            }
        }
        
        // تحديث قوائم اختيار النقاط
        function updatePointSelectors() {
            const select1 = document.getElementById('point1Select');
            const select2 = document.getElementById('point2Select');
            
            select1.innerHTML = '<option value="">اختر النقطة الأولى</option>';
            select2.innerHTML = '<option value="">اختر النقطة الثانية</option>';
            
            points.forEach((point, index) => {
                const option1 = new Option(`${point.name} (Count: ${point.count})`, index);
                const option2 = new Option(`${point.name} (Count: ${point.count})`, index);
                select1.add(option1);
                select2.add(option2);
            });
        }
        
        // عرض النقاط في القائمة
        function displayPoints() {
            const pointsList = document.getElementById('pointsList');
            
            if (points.length === 0) {
                pointsList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-map-marked" style="font-size: 3rem; margin-bottom: 15px; color: #4ECDC4;"></i>
                        <p>لا توجد نقاط للعرض</p>
                    </div>
                `;
                return;
            }
            
            pointsList.innerHTML = '';
            points.forEach((point, index) => {
                const pointCard = document.createElement('div');
                pointCard.className = 'point-card';
                pointCard.innerHTML = `
                    <div class="point-number">${point.count}</div>
                    <div class="point-name">${point.name}</div>
                    <div class="point-coords">
                        <i class="fas fa-globe"></i> 
                        ${point.position.lat.toFixed(6)}, ${point.position.lng.toFixed(6)}
                    </div>
                    <div class="point-description">${point.description.substring(0, 120)}${point.description.length > 120 ? '...' : ''}</div>
                    ${point.azmith !== null ? `<div style="margin-top: 10px; color: #4ECDC4;"><i class="fas fa-compass"></i> الاتجاه: ${point.azmith}°</div>` : ''}
                    <div class="point-actions">
                        <button class="point-action-btn" onclick="highlightPoint(${index})">
                            <i class="fas fa-star"></i> تمييز
                        </button>
                        <button class="point-action-btn" onclick="selectForDistance(${index})">
                            <i class="fas fa-ruler"></i> قياس
                        </button>
                    </div>
                `;
                
                pointCard.addEventListener('click', () => {
                    map.setView(point.position, 15);
                    point.marker.openPopup();
                });
                
                pointsList.appendChild(pointCard);
            });
        }
        
        // البحث عن النقاط
        function searchPoints() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const pointsList = document.getElementById('pointsList');
            
            pointsList.innerHTML = '';
            
            const filteredPoints = points.filter(point => 
                point.name.toLowerCase().includes(searchTerm) || 
                point.description.toLowerCase().includes(searchTerm)
            );
            
            if (filteredPoints.length === 0) {
                pointsList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-search" style="font-size: 3rem; margin-bottom: 15px; color: #4ECDC4;"></i>
                        <p>لم يتم العثور على نتائج</p>
                    </div>
                `;
                return;
            }
            
            filteredPoints.forEach((point, index) => {
                const pointCard = document.createElement('div');
                pointCard.className = 'point-card';
                pointCard.innerHTML = `
                    <div class="point-number">${point.count}</div>
                    <div class="point-name">${point.name}</div>
                    <div class="point-coords">
                        <i class="fas fa-globe"></i> 
                        ${point.position.lat.toFixed(6)}, ${point.position.lng.toFixed(6)}
                    </div>
                    <div class="point-description">${point.description.substring(0, 120)}${point.description.length > 120 ? '...' : ''}</div>
                    ${point.azmith !== null ? `<div style="margin-top: 10px; color: #4ECDC4;"><i class="fas fa-compass"></i> الاتجاه: ${point.azmith}°</div>` : ''}
                    <div class="point-actions">
                        <button class="point-action-btn" onclick="highlightPoint(${points.indexOf(point)})">
                            <i class="fas fa-star"></i> تمييز
                        </button>
                        <button class="point-action-btn" onclick="selectForDistance(${points.indexOf(point)})">
                            <i class="fas fa-ruler"></i> قياس
                        </button>
                    </div>
                `;
                
                pointCard.addEventListener('click', () => {
                    map.setView(point.position, 15);
                    point.marker.openPopup();
                });
                
                pointsList.appendChild(pointCard);
            });
        }
        
        // === وظائف القياس ===
        
        // تفعيل وضع القياس
        function activateDistanceMode() {
            distanceMode = !distanceMode;
            routeMode = false;
            const optionItem = event.target.closest('.option-item');
            
            document.querySelectorAll('.option-item').forEach(item => item.classList.remove('active'));
            
            if (distanceMode) {
                optionItem.classList.add('active');
                showMessage('انقر على نقطتين لقياس المسافة بينهما', 'info');
                map.getContainer().style.cursor = 'crosshair';
                selectedPointsForDistance = [];
            } else {
                showMessage('تم إغلاق وضع القياس', 'info');
                map.getContainer().style.cursor = '';
                clearDistanceLine();
            }
        }
        
        // تفعيل وضع المسارات
        function activateRouteMode() {
            routeMode = !routeMode;
            distanceMode = false;
            const optionItem = event.target.closest('.option-item');
            
            document.querySelectorAll('.option-item').forEach(item => item.classList.remove('active'));
            
            if (routeMode) {
                optionItem.classList.add('active');
                showMessage('انقر على النقاط لرسم المسار', 'info');
                map.getContainer().style.cursor = 'crosshair';
                routePoints = [];
            } else {
                showMessage('تم إغلاق وضع المسارات', 'info');
                map.getContainer().style.cursor = '';
                clearRouteLine();
            }
        }
        
        // إضافة نقطة للقياس
        function addDistancePoint(latlng) {
            const tempMarker = L.marker(latlng, {
                icon: L.divIcon({
                    className: 'custom-marker',
                    html: '📍',
                    iconSize: [35, 35],
                    iconAnchor: [17.5, 35]
                })
            }).addTo(map);
            
            tempMarker.getElement().style.background = '#FF6B6B';
            
            selectedPointsForDistance.push({latlng, marker: tempMarker});
            
            if (selectedPointsForDistance.length === 2) {
                // حساب المسافة
                const distance = calculateHaversineDistance(
                    selectedPointsForDistance[0].latlng.lat, selectedPointsForDistance[0].latlng.lng,
                    selectedPointsForDistance[1].latlng.lat, selectedPointsForDistance[1].latlng.lng
                );
                
                // رسم خط
                drawDistanceLine(selectedPointsForDistance[0].latlng, selectedPointsForDistance[1].latlng);
                
                // عرض النتيجة
                showMessage(`المسافة: ${(distance/1000).toFixed(2)} كم`, 'success');
                
                // إعادة التعيين بعد 5 ثواني
                setTimeout(() => {
                    selectedPointsForDistance.forEach(point => map.removeLayer(point.marker));
                    selectedPointsForDistance = [];
                    clearDistanceLine();
                }, 5000);
            }
        }
        
        // إضافة نقطة للمسار
        function addRoutePoint(latlng) {
            routePoints.push(latlng);
            
            const tempMarker = L.marker(latlng, {
                icon: L.divIcon({
                    className: 'custom-marker',
                    html: routePoints.length,
                    iconSize: [35, 35],
                    iconAnchor: [17.5, 35]
                })
            }).addTo(map);
            
            tempMarker.getElement().style.background = '#4ECDC4';
            
            if (routePoints.length > 1) {
                drawRouteLine();
            }
        }
        
        // اختيار نقطة للقياس من القائمة
        function selectForDistance(index) {
            const point = points[index];
            selectedPointsForDistance.push(point);
            
            // تمييز النقطة المختارة
            point.marker.getElement().style.background = '#FF6B6B';
            
            if (selectedPointsForDistance.length === 2) {
                // حساب المسافة
                const distance = calculateHaversineDistance(
                    selectedPointsForDistance[0].position.lat, selectedPointsForDistance[0].position.lng,
                    selectedPointsForDistance[1].position.lat, selectedPointsForDistance[1].position.lng
                );
                
                // رسم خط
                drawDistanceLine(
                    L.latLng(selectedPointsForDistance[0].position.lat, selectedPointsForDistance[0].position.lng),
                    L.latLng(selectedPointsForDistance[1].position.lat, selectedPointsForDistance[1].position.lng)
                );
                
                // عرض النتيجة
                showMessage(`المسافة: ${(distance/1000).toFixed(2)} كم`, 'success');
                
                // إعادة تعيين بعد 5 ثواني
                setTimeout(() => {
                    selectedPointsForDistance.forEach(point => {
                        if (point.marker) {
                            point.marker.getElement().style.background = '';
                        }
                    });
                    selectedPointsForDistance = [];
                    clearDistanceLine();
                }, 5000);
            }
        }
        
        // حساب المسافة بين نقطتين محددتين
        function calculateDistance() {
            const point1Index = document.getElementById('point1Select').value;
            const point2Index = document.getElementById('point2Select').value;
            
            if (point1Index === '' || point2Index === '') {
                showMessage('يرجى اختيار نقطتين', 'error');
                return;
            }
            
            if (point1Index === point2Index) {
                showMessage('يرجى اختيار نقطتين مختلفتين', 'error');
                return;
            }
            
            const point1 = points[point1Index];
            const point2 = points[point2Index];
            
            // حساب المسافة المستقيمة
            const straightDistance = calculateHaversineDistance(
                point1.position.lat, point1.position.lng,
                point2.position.lat, point2.position.lng
            );
            
            // تقدير المسافة بالطريق (1.3x المسافة المستقيمة)
            const roadDistance = straightDistance * 1.3;
            
            // حساب الاتجاه
            const direction = calculateBearing(
                point1.position.lat, point1.position.lng,
                point2.position.lat, point2.position.lng
            );
            
            // تقدير الوقت (بافتراض سرعة 60 كم/ساعة)
            const estimatedTime = Math.round((roadDistance / 1000) / 60 * 60);
            
            // عرض النتائج
            document.getElementById('straightDistance').textContent = (straightDistance/1000).toFixed(2);
            document.getElementById('roadDistance').textContent = (roadDistance/1000).toFixed(2);
            document.getElementById('direction').textContent = direction.toFixed(0);
            document.getElementById('estimatedTime').textContent = estimatedTime;
            document.getElementById('distanceResult').style.display = 'block';
            
            // رسم الخط على الخريطة
            drawDistanceLine(
                L.latLng(point1.position.lat, point1.position.lng),
                L.latLng(point2.position.lat, point2.position.lng)
            );
            
            // تمييز النقطتين
            point1.marker.getElement().style.background = '#FF6B6B';
            point2.marker.getElement().style.background = '#FF6B6B';
            
            // التركيز على النقطتين
            const group = new L.featureGroup([point1.marker, point2.marker]);
            map.fitBounds(group.getBounds().pad(0.2));
        }
        
        // حساب المسافة باستخدام Haversine formula
        function calculateHaversineDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // نصف قطر الأرض بالكيلومتر
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c * 1000; // المسافة بالأمتار
        }
        
        // حساب الاتجاه
        function calculateBearing(lat1, lon1, lat2, lon2) {
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const y = Math.sin(dLon) * Math.cos(lat2 * Math.PI / 180);
            const x = Math.cos(lat1 * Math.PI / 180) * Math.sin(lat2 * Math.PI / 180) -
                      Math.sin(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.cos(dLon);
            let bearing = Math.atan2(y, x) * 180 / Math.PI;
            bearing = (bearing + 360) % 360;
            return bearing;
        }
        
        // رسم خط المسافة
        function drawDistanceLine(point1, point2) {
            clearDistanceLine();
            
            distanceLine = L.polyline([point1, point2], {
                color: '#FF6B6B',
                weight: 4,
                opacity: 0.8,
                dashArray: '10, 10'
            }).addTo(map);
        }
        
        // رسم خط المسار
        function drawRouteLine() {
            clearRouteLine();
            
            if (routePoints.length >= 2) {
                routeLine = L.polyline(routePoints, {
                    color: '#4ECDC4',
                    weight: 5,
                    opacity: 0.8
                }).addTo(map);
                
                routes.push({
                    points: [...routePoints],
                    line: routeLine
                });
                
                updateStats();
            }
        }
        
        // مسح خط المسافة
        function clearDistanceLine() {
            if (distanceLine) {
                map.removeLayer(distanceLine);
                distanceLine = null;
            }
        }
        
        // مسح خط المسار
        function clearRouteLine() {
            if (routeLine) {
                map.removeLayer(routeLine);
                routeLine = null;
            }
        }
        
        // حساب جميع المسافات
        function calculateAllDistances() {
            if (points.length < 2) {
                showMessage('يجب أن يكون هناك نقطتان على الأقل', 'error');
                return;
            }
            
            let totalDistance = 0;
            let minDistance = Infinity;
            let maxDistance = 0;
            let closestPair = null;
            let farthestPair = null;
            
            for (let i = 0; i < points.length; i++) {
                for (let j = i + 1; j < points.length; j++) {
                    const distance = calculateHaversineDistance(
                        points[i].position.lat, points[i].position.lng,
                        points[j].position.lat, points[j].position.lng
                    );
                    
                    totalDistance += distance;
                    
                    if (distance < minDistance) {
                        minDistance = distance;
                        closestPair = [i, j];
                    }
                    
                    if (distance > maxDistance) {
                        maxDistance = distance;
                        farthestPair = [i, j];
                    }
                }
            }
            
            const avgDistance = totalDistance / (points.length * (points.length - 1) / 2);
            
            const stats = `
                <div style="direction: rtl; text-align: right; padding: 25px; background: white; color: black; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
                    <h3 style="color: #667eea; margin-bottom: 20px; font-size: 1.5rem;">إحصائيات المسافات</h3>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px;">
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 10px;">
                            <strong style="color: #4ECDC4;">متوسط المسافة:</strong><br>
                            ${(avgDistance/1000).toFixed(2)} كم
                        </div>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 10px;">
                            <strong style="color: #4ECDC4;">إجمالي المسافات:</strong><br>
                            ${(totalDistance/1000).toFixed(2)} كم
                        </div>
                    </div>
                    <div style="background: #e3f2fd; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                        <strong style="color: #2196F3;">أقرب نقطتين:</strong><br>
                        ${points[closestPair[0]].name} و ${points[closestPair[1]].name}<br>
                        <small>المسافة: ${(minDistance/1000).toFixed(2)} كم</small>
                    </div>
                    <div style="background: #ffebee; padding: 15px; border-radius: 10px;">
                        <strong style="color: #f44336;">أبعد نقطتين:</strong><br>
                        ${points[farthestPair[0]].name} و ${points[farthestPair[1]].name}<br>
                        <small>المسافة: ${(maxDistance/1000).toFixed(2)} كم</small>
                    </div>
                </div>
            `;
            
            L.popup()
                .setLatLng(map.getCenter())
                .setContent(stats)
                .openOn(map);
        }
        
        // عرض مصفوفة المسافات
        function showDistanceMatrix() {
            if (points.length < 2) {
                showMessage('يجب أن يكون هناك نقطتان على الأقل', 'error');
                return;
            }
            
            let matrixHTML = '<table style="width: 100%; border-collapse: collapse; direction: rtl;">';
            matrixHTML += '<tr><th style="border: 1px solid #ddd; padding: 8px; background: #4ECDC4; color: white;">النقطة</th>';
            
            points.forEach((point, i) => {
                matrixHTML += `<th style="border: 1px solid #ddd; padding: 8px; background: #4ECDC4; color: white;">${point.count}</th>`;
            });
            matrixHTML += '</tr>';
            
            points.forEach((point1, i) => {
                matrixHTML += `<tr><td style="border: 1px solid #ddd; padding: 8px; background: #f8f9fa; font-weight: bold;">${point1.count}</td>`;
                
                points.forEach((point2, j) => {
                    if (i === j) {
                        matrixHTML += '<td style="border: 1px solid #ddd; padding: 8px; text-align: center; background: #e9ecef;">-</td>';
                    } else {
                        const distance = calculateHaversineDistance(
                            point1.position.lat, point1.position.lng,
                            point2.position.lat, point2.position.lng
                        );
                        matrixHTML += `<td style="border: 1px solid #ddd; padding: 8px; text-align: center;">${(distance/1000).toFixed(1)}</td>`;
                    }
                });
                
                matrixHTML += '</tr>';
            });
            
            matrixHTML += '</table>';
            
            const matrixContent = `
                <div style="direction: rtl; text-align: right; padding: 25px; background: white; color: black; border-radius: 15px; max-width: 800px; max-height: 600px; overflow: auto;">
                    <h3 style="color: #667eea; margin-bottom: 20px; font-size: 1.5rem;">مصفوفة المسافات (كم)</h3>
                    ${matrixHTML}
                </div>
            `;
            
            L.popup()
                .setLatLng(map.getCenter())
                .setContent(matrixContent)
                .openOn(map);
        }
        
        // === وظائف إدارة النقاط ===
        
        // إعادة ترقيم النقاط
        function renumberPoints() {
            points.forEach((point, index) => {
                point.number = index + 1;
                point.marker.getElement().innerHTML = point.count;
            });
            
            updatePointSelectors();
            displayPoints();
            showMessage('تم إعادة ترقيم النقاط بنجاح', 'success');
        }
        
        // تمييز نقطة
        function highlightPoint(index) {
            const point = points[index];
            const markerElement = point.marker.getElement();
            
            if (markerElement.classList.contains('highlighted-marker')) {
                markerElement.classList.remove('highlighted-marker');
                markerElement.style.background = '';
            } else {
                markerElement.classList.add('highlighted-marker');
                markerElement.style.background = '#FF6B6B';
            }
            
            updateStats();
        }
        
        // تمييز نقطة عشوائية
        function highlightRandomPoint() {
            if (points.length === 0) {
                showMessage('لا توجد نقاط للتمييز', 'error');
                return;
            }
            
            const randomIndex = Math.floor(Math.random() * points.length);
            highlightPoint(randomIndex);
            
            map.setView(points[randomIndex].position, 15);
            points[randomIndex].marker.openPopup();
        }
        
        // مسح جميع التمييزات
        function clearHighlights() {
            points.forEach(point => {
                const markerElement = point.marker.getElement();
                markerElement.classList.remove('highlighted-marker');
                markerElement.style.background = '';
            });
            
            updateStats();
            showMessage('تم مسح جميع التمييزات', 'success');
        }
        
        // تجميع النقاط
        function clusterPoints() {
            showMessage('تم تفعيل تجميع النقاط', 'success');
        }
        
        // === وظائف التحليل والإحصائيات ===
        
        // إنشاء تقرير إحصائي
        function generateReport() {
            if (points.length === 0) {
                showMessage('لا توجد بيانات لإنشاء تقرير', 'error');
                return;
            }
            
            let totalDistance = 0;
            let minDistance = Infinity;
            let maxDistance = 0;
            let closestPair = null;
            let farthestPair = null;
            
            // تحديد أقصى النقاط
            let northPoint = points[0];
            let southPoint = points[0];
            let eastPoint = points[0];
            let westPoint = points[0];
            
            for (let i = 0; i < points.length; i++) {
                // تحديد أقصى النقاط
                if (points[i].position.lat > northPoint.position.lat) northPoint = points[i];
                if (points[i].position.lat < southPoint.position.lat) southPoint = points[i];
                if (points[i].position.lng > eastPoint.position.lng) eastPoint = points[i];
                if (points[i].position.lng < westPoint.position.lng) westPoint = points[i];
                
                for (let j = i + 1; j < points.length; j++) {
                    const distance = calculateHaversineDistance(
                        points[i].position.lat, points[i].position.lng,
                        points[j].position.lat, points[j].position.lng
                    );
                    
                    totalDistance += distance;
                    
                    if (distance < minDistance) {
                        minDistance = distance;
                        closestPair = [i, j];
                    }
                    
                    if (distance > maxDistance) {
                        maxDistance = distance;
                        farthestPair = [i, j];
                    }
                }
            }
            
            const avgDistance = totalDistance / (points.length * (points.length - 1) / 2);
            
            // تحديث بيانات التقرير
            document.getElementById('reportTotalPoints').textContent = points.length;
            document.getElementById('reportTotalRoutes').textContent = routes.length;
            document.getElementById('reportAvgDistance').textContent = (avgDistance/1000).toFixed(1);
            document.getElementById('reportMaxDistance').textContent = (maxDistance/1000).toFixed(1);
            
            document.getElementById('reportNorthPoint').textContent = northPoint.name;
            document.getElementById('reportSouthPoint').textContent = southPoint.name;
            document.getElementById('reportEastPoint').textContent = eastPoint.name;
            document.getElementById('reportWestPoint').textContent = westPoint.name;
            
            // عرض التقرير
            document.getElementById('reportModal').style.display = 'flex';
        }
        
        // إغلاق التقرير
        function closeReport() {
            document.getElementById('reportModal').style.display = 'none';
        }
        
        // عرض خريطة حرارية
        function showHeatmap() {
            if (heatLayer) {
                map.removeLayer(heatLayer);
                heatLayer = null;
                document.querySelector('.heat-map-legend')?.remove();
                showMessage('تم إغلاق الخريطة الحرارية', 'info');
            } else {
                if (points.length === 0) {
                    showMessage('لا توجد نقاط لعرض الخريطة الحرارية', 'error');
                    return;
                }
                
                const heatData = points.map(point => [point.position.lat, point.position.lng, point.count / 100]);
                
                heatLayer = L.heatLayer(heatData, {
                    radius: 25,
                    blur: 15,
                    maxZoom: 17,
                    max: 1.0,
                    gradient: {
                        0.0: 'blue',
                        0.25: 'cyan',
                        0.5: 'lime',
                        0.75: 'yellow',
                        1.0: 'red'
                    }
                }).addTo(map);
                
                // إضافة وسيلة الإيضاح
                const legend = document.createElement('div');
                legend.className = 'heat-map-legend';
                legend.innerHTML = `
                    <h4>كثافة النقاط</h4>
                    <div style="background: linear-gradient(to right, blue, cyan, lime, yellow, red); height: 20px; border-radius: 5px;"></div>
                    <div style="display: flex; justify-content: space-between; margin-top: 5px;">
                        <span>منخفض</span>
                        <span>مرتفع</span>
                    </div>
                `;
                map.getContainer().appendChild(legend);
                
                showMessage('تم تفعيل الخريطة الحرارية', 'success');
            }
        }
        
        // تحليل التوزيع
        function analyzeDistribution() {
            showMessage('جاري تحليل توزيع النقاط...', 'info');
            
            // تحليل بسيط للتوزيع الجغرافي
            const bounds = L.latLngBounds(points.map(p => [p.position.lat, p.position.lng]));
            const center = bounds.getCenter();
            
            const distribution = `
                <div style="direction: rtl; text-align: right; padding: 20px; background: white; color: black; border-radius: 15px;">
                    <h3 style="color: #667eea; margin-bottom: 15px;">تحليل التوزيع الجغرافي</h3>
                    <p><strong>المركز الجغرافي:</strong> ${center.lat.toFixed(4)}, ${center.lng.toFixed(4)}</p>
                    <p><strong>الامتداد الشمالي-الجنوبي:</strong> ${(bounds.getNorth() - bounds.getSouth()).toFixed(2)}°</p>
                    <p><strong>الامتداد الشرقي-الغربي:</strong> ${(bounds.getEast() - bounds.getWest()).toFixed(2)}°</p>
                </div>
            `;
            
            L.popup()
                .setLatLng(center)
                .setContent(distribution)
                .openOn(map);
        }
        
        // إيجاد الموقع الأمثل
        function findOptimalLocation() {
            if (points.length < 2) {
                showMessage('يجب أن يكون هناك نقطتان على الأقل', 'error');
                return;
            }
            
            // حساب المركز الجغرافي
            let totalLat = 0, totalLng = 0;
            points.forEach(point => {
                totalLat += point.position.lat;
                totalLng += point.position.lng;
            });
            
            const optimalLat = totalLat / points.length;
            const optimalLng = totalLng / points.length;
            
            // إضافة علامة للموقع الأمثل
            const optimalMarker = L.marker([optimalLat, optimalLng], {
                icon: L.divIcon({
                    className: 'custom-marker',
                    html: '🎯',
                    iconSize: [40, 40],
                    iconAnchor: [20, 40]
                })
            }).addTo(map);
            
            optimalMarker.getElement().style.background = 'linear-gradient(45deg, #FFD166, #ffed4e)';
            
            // حساب متوسط المسافة من جميع النقاط
            let totalDistance = 0;
            points.forEach(point => {
                totalDistance += calculateHaversineDistance(
                    optimalLat, optimalLng,
                    point.position.lat, point.position.lng
                );
            });
            
            const avgDistance = totalDistance / points.length;
            
            const info = `
                <div style="direction: rtl; text-align: right; padding: 20px; background: white; color: black; border-radius: 15px;">
                    <h3 style="color: #667eea; margin-bottom: 15px;">الموقع الأمثل</h3>
                    <p><strong>الإحداثيات:</strong> ${optimalLat.toFixed(6)}, ${optimalLng.toFixed(6)}</p>
                    <p><strong>متوسط المسافة:</strong> ${(avgDistance/1000).toFixed(2)} كم</p>
                </div>
            `;
            
            optimalMarker.bindPopup(info).openPopup();
            
            map.setView([optimalLat, optimalLng], 12);
            
            showMessage('تم تحديد الموقع الأمثل', 'success');
        }
        
        // === وظائف الخريطة ===
        
        // الوضع الليلي
        function toggleNightMode() {
            document.body.classList.toggle('night-mode');
            showMessage('تم تغيير الوضع الليلي', 'info');
        }
        
        // تغيير نوع الخريطة
        function toggleMapType() {
            const layers = ['osm', 'satellite', 'terrain', 'dark'];
            const currentIndex = layers.findIndex(layer => map.layers[layer] === currentLayer);
            const nextIndex = (currentIndex + 1) % layers.length;
            const nextLayer = layers[nextIndex];
            
            if (currentLayer) {
                map.removeLayer(currentLayer);
            }
            currentLayer = map.layers[nextLayer];
            currentLayer.addTo(map);
            
            showMessage('تم تغيير نوع الخريطة', 'info');
        }
        
        // ملء الشاشة
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }
        
        // تكبير
        function zoomIn() {
            map.zoomIn();
        }
        
        // تصغير
        function zoomOut() {
            map.zoomOut();
        }
        
        // إعادة تعيين العرض
        function resetView() {
            map.setView([31.2, 29.9], 7);
        }
        
        // تحديد موقع المستخدم
        function locateUser() {
            map.locate({setView: true, maxZoom: 16});
        }
        
        // تصدير البيانات
        function exportData() {
            if (points.length === 0) {
                showMessage('لا توجد بيانات للتصدير', 'error');
                return;
            }
            
            const geojson = {
                type: "FeatureCollection",
                features: points.map(point => ({
                    type: "Feature",
                    properties: {
                        name: point.name,
                        description: point.description,
                        count: point.count,
                        number: point.number,
                        azmith: point.azmith
                    },
                    geometry: {
                        type: "Point",
                        coordinates: [point.position.lng, point.position.lat]
                    }
                }))
            };
            
            const dataStr = JSON.stringify(geojson, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = 'kml_reader_data.geojson';
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showMessage('تم تصدير البيانات بنجاح', 'success');
        }
        
        // تصدير التقرير
        function exportReport() {
            showMessage('جاري تصدير التقرير...', 'info');
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // إضافة العنوان
            doc.setFontSize(20);
            doc.text('تقرير إحصائي - قارئ ملفات KML', 105, 20, { align: 'center' });
            
            // إضافة التاريخ
            doc.setFontSize(12);
            doc.text(`التاريخ: ${new Date().toLocaleDateString('ar-SA')}`, 20, 35);
            
            // إضافة الإحصائيات
            doc.setFontSize(16);
            doc.text('الإحصائيات العامة:', 20, 50);
            
            doc.setFontSize(12);
            doc.text(`إجمالي النقاط: ${points.length}`, 30, 65);
            doc.text(`إجمالي المسارات: ${routes.length}`, 30, 75);
            doc.text(`متوسط المسافة: ${document.getElementById('reportAvgDistance').textContent} كم`, 30, 85);
            doc.text(`أقصى مسافة: ${document.getElementById('reportMaxDistance').textContent} كم`, 30, 95);
            
            // حفظ الملف
            doc.save('تقرير_احصائي.pdf');
            
            showMessage('تم تصدير التقرير بنجاح', 'success');
        }
        
        // طباعة التقرير
        function printReport() {
            window.print();
        }
        
        // مشاركة الخريطة
        function shareMap() {
            const center = map.getCenter();
            const zoom = map.getZoom();
            const shareUrl = `${window.location.origin}${window.location.pathname}?lat=${center.lat}&lng=${center.lng}&zoom=${zoom}`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'قارئ ملفات KML',
                    text: 'شاهد هذه الخريطة المذهلة',
                    url: shareUrl
                });
            } else {
                navigator.clipboard.writeText(shareUrl);
                showMessage('تم نسخ رابط المشاركة', 'success');
            }
        }
        
        // طباعة الخريطة
        function printMap() {
            window.print();
        }
        
        // حفظ صورة
        function saveScreenshot() {
            showMessage('جاري حفظ الصورة...', 'info');
            
            html2canvas(document.querySelector('.map-section')).then(canvas => {
                const link = document.createElement('a');
                link.download = 'خريطة.png';
                link.href = canvas.toDataURL();
                link.click();
                
                showMessage('تم حفظ الصورة بنجاح', 'success');
            });
        }
        
        // تحميل من رابط
        function loadFromUrl() {
            const url = prompt('أدخل رابط ملف KML:');
            if (url) {
                fetch(url)
                    .then(response => response.text())
                    .then(data => parseKMLData(data))
                    .catch(error => showMessage('فشل تحميل الملف', 'error'));
            }
        }
        
        // تحميل بيانات تجريبية
        function loadSampleData() {
            const sampleKML = `<?xml version="1.0" encoding="UTF-8"?>
            <kml xmlns="http://www.opengis.net/kml/2.2">
                <Document>
                    <Placemark>
                        <name>3099138</name>
                        <description>Count: 747
CELL_ADDRESS: Alexandria, Alex.- Matrooh Road, 6th October Village, El Nakheel Beach, First Right St., Third Left One, 6th October Exchange., اعلي سنترال 6 اكتوبر قريه النخيل - طريق الاسكندريه مطروح Alexandria, Alex.- Matrooh Road, 6th October Village, El Nakheel Beach, First Right St., Third Left One, 6th October Exchange.,
AZMITH: 210</description>
                        <Point>
                            <coordinates>29.7342419283,31.0857684171,0.0</coordinates>
                        </Point>
                    </Placemark>
                    <Placemark>
                        <name>5169410</name>
                        <description>Count: 291
CELL_ADDRESS: LORAN- Alexandria  12شارع محمد درى باشا - لوران - الإسكندرية LORAN- Alexandria
AZMITH: 200</description>
                        <Point>
                            <coordinates>29.9753969078,31.2451103216,0.0</coordinates>
                        </Point>
                    </Placemark>
                    <Placemark>
                        <name>5134593</name>
                        <description>Count: 265
CELL_ADDRESS: Alexandria, SIdi Beshr Qebly, Street No. 63, Building No. 14, Crossing Mohamed Farid St. شارع 63 من شارع محمد فريد - سيدى بشر- الاسكندرية 63 St. From Mohamed Farid St. - Sidi Bishr Kebly - Ethad Molak EL Amir
AZMITH: 15</description>
                        <Point>
                            <coordinates>30.0020272225,31.2555993815,0.0</coordinates>
                        </Point>
                    </Placemark>
                    <Placemark>
                        <name>2831105</name>
                        <description>Count: 256
CELL_ADDRESS: Inside Marina Village - between gate 2 &amp; 3 Shanzeliseh الشانزليزية خلف النساجون الشرقيون منطقة 4 قرية مارينا  - طريق اسكندرية مطروح - الاسكندرية Inside Marina Village - Between Gate 2 &amp; 3 Shanzeliseh
AZMITH: 15</description>
                        <Point>
                            <coordinates>29.0420628528,30.8153236605,0.0</coordinates>
                        </Point>
                    </Placemark>
                </Document>
            </kml>`;
            
            parseKMLData(sampleKML);
        }
        
        // مسح جميع البيانات
        function clearAllData() {
            if (confirm('هل أنت متأكد من مسح جميع البيانات؟')) {
                clearMap();
                showMessage('تم مسح جميع البيانات', 'success');
            }
        }
        
        // مسح الخريطة
        function clearMap() {
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
            points = [];
            routes.forEach(route => {
                if (route.line) {
                    map.removeLayer(route.line);
                }
            });
            routes = [];
            clearDistanceLine();
            clearRouteLine();
            if (heatLayer) {
                map.removeLayer(heatLayer);
                heatLayer = null;
            }
            updateStats();
            updatePointSelectors();
        }
        
        // عرض الرسائل
        function showMessage(text, type = 'info') {
            const message = document.createElement('div');
            message.className = `message ${type}`;
            message.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'}"></i> ${text}`;
            
            document.body.appendChild(message);
            
            setTimeout(() => {
                message.style.animation = 'slideUp 0.5s ease';
                setTimeout(() => message.remove(), 500);
            }, 3000);
        }
        
        // تهيئة الخريطة عند تحميل الصفحة
        window.onload = function() {
            initMap();
            
            // التحقق من وجود معلمات في الرابط
            const urlParams = new URLSearchParams(window.location.search);
            const lat = urlParams.get('lat');
            const lng = urlParams.get('lng');
            const zoom = urlParams.get('zoom');
            
            if (lat && lng) {
                map.setView([parseFloat(lat), parseFloat(lng)], zoom ? parseInt(zoom) : 10);
            }
        };
    </script>
</body>
</html>
