<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>قارئ ملفات KML المحترف - النسخة الشاملة</title>
    
    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <!-- Additional Libraries -->
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* الوضع الليلي */
        body.night-mode {
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
        }
        
        body.night-mode .control-card,
        body.night-mode .options-panel,
        body.night-mode .data-panel,
        body.night-mode .point-card,
        body.night-mode .stat-card,
        body.night-mode .distance-tools {
            background: rgba(0, 0, 0, 0.3);
            border-color: rgba(255, 255, 255, 0.1);
        }
        
        .container {
            max-width: 2000px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 30px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            backdrop-filter: blur(15px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        h1 {
            font-size: 3rem;
            margin-bottom: 15px;
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.5);
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .subtitle {
            font-size: 1.3rem;
            opacity: 0.9;
        }
        
        /* لوحة التحكم الرئيسية */
        .control-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .control-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }
        
        .control-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .control-card h3 {
            color: #ffd700;
            margin-bottom: 20px;
            font-size: 1.4rem;
            text-align: center;
        }
        
        /* أزرار ملونة */
        .btn {
            background: linear-gradient(45deg, #f093fb, #f5576c);
            color: white;
            border: none;
            border-radius: 25px;
            padding: 12px 25px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            margin: 5px;
            font-size: 14px;
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }
        
        .btn-primary { background: linear-gradient(45deg, #667eea, #764ba2); }
        .btn-success { background: linear-gradient(45deg, #56ab2f, #a8e063); }
        .btn-info { background: linear-gradient(45deg, #2196F3, #21CBF3); }
        .btn-warning { background: linear-gradient(45deg, #f2994a, #f2c94c); }
        .btn-danger { background: linear-gradient(45deg, #eb3349, #f45c43); }
        
        /* المحتوى الرئيسي */
        .main-content {
            display: grid;
            grid-template-columns: 400px 1fr 450px;
            gap: 20px;
            height: calc(100vh - 200px);
        }
        
        /* لوحة الخيارات */
        .options-panel {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            overflow-y: auto;
            max-height: calc(100vh - 200px);
        }
        
        .options-panel h3 {
            color: #ffd700;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.5rem;
        }
        
        .option-group {
            margin-bottom: 25px;
        }
        
        .option-group h4 {
            color: #4ECDC4;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }
        
        .option-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid transparent;
            display: flex;
            align-items: center;
        }
        
        .option-item:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.3);
            transform: translateX(-8px);
        }
        
        .option-item.active {
            background: linear-gradient(45deg, rgba(76, 205, 196, 0.3), rgba(78, 205, 196, 0.1));
            border-color: #4ECDC4;
        }
        
        .option-item i {
            margin-left: 15px;
            color: #4ECDC4;
            font-size: 1.2rem;
            width: 25px;
        }
        
        /* منطقة الخريطة */
        .map-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            overflow: hidden;
            position: relative;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4);
        }
        
        #map {
            width: 100%;
            height: 100%;
            min-height: 600px;
        }
        
        .map-controls {
            position: absolute;
            top: 15px;
            left: 15px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .map-btn {
            background: rgba(255, 255, 255, 0.95);
            border: none;
            border-radius: 12px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            color: #333;
            font-size: 18px;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .map-btn:hover {
            background: #fff;
            transform: scale(1.1);
        }
        
        /* لوحة البيانات */
        .data-panel {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            overflow-y: auto;
            max-height: calc(100vh - 200px);
        }
        
        .data-panel h3 {
            color: #ffd700;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.5rem;
        }
        
        /* صندوق البحث */
        .search-box {
            position: relative;
            margin-bottom: 20px;
        }
        
        .search-box input {
            width: 100%;
            padding: 15px 50px 15px 20px;
            border: none;
            border-radius: 30px;
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
            font-size: 16px;
            direction: rtl;
        }
        
        .search-box input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }
        
        .search-box i {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: rgba(255, 255, 255, 0.7);
            font-size: 18px;
        }
        
        /* الإحصائيات */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            border-radius: 15px;
            padding: 20px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #4ECDC4;
            margin-bottom: 8px;
        }
        
        .stat-label {
            font-size: 1rem;
            opacity: 0.9;
        }
        
        /* أدوات القياس */
        .distance-tools {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.15), rgba(255, 255, 255, 0.05));
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
        }
        
        .distance-tools h4 {
            color: #4ECDC4;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .point-selector {
            margin-bottom: 15px;
        }
        
        .point-selector select {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
            font-size: 15px;
            direction: rtl;
        }
        
        .distance-result {
            background: linear-gradient(135deg, rgba(76, 205, 196, 0.3), rgba(76, 205, 196, 0.1));
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            margin-top: 15px;
        }
        
        /* بطاقات النقاط */
        .point-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.15), rgba(255, 255, 255, 0.05));
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }
        
        .point-card:hover {
            transform: translateX(-8px);
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.25), rgba(255, 255, 255, 0.1));
        }
        
        .point-number {
            position: absolute;
            top: -10px;
            right: -10px;
            background: linear-gradient(45deg, #FF6B6B, #ff8e8e);
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
        }
        
        .point-name {
            font-weight: bold;
            font-size: 1.2rem;
            margin-bottom: 10px;
            color: #ffd700;
        }
        
        .point-coords {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-bottom: 10px;
        }
        
        .point-description {
            font-size: 0.95rem;
            line-height: 1.5;
            opacity: 0.9;
        }
        
        .point-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }
        
        .point-action-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 8px;
            padding: 8px 15px;
            color: #fff;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s ease;
            flex: 1;
        }
        
        .point-action-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        /* العلامات المخصصة */
        .custom-marker {
            background: linear-gradient(45deg, #f093fb, #f5576c);
            border: 3px solid #fff;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
            font-size: 16px;
        }
        
        .highlighted-marker {
            background: linear-gradient(45deg, #FF6B6B, #ff8e8e) !important;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }
        
        /* أسهم الاتجاه */
        .direction-arrow {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            width: 30px;
            height: 30px;
            background: #4ECDC4;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }
        
        /* خطوط المسافة */
        .distance-line {
            stroke: #FF6B6B;
            stroke-width: 4;
            fill: none;
            animation: dash 20s linear infinite;
        }
        
        @keyframes dash {
            to { stroke-dashoffset: -1000; }
        }
        
        /* الشجرة الهرمية */
        .tree-view {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-top: 15px;
        }
        
        .tree-node {
            margin: 10px 0;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .tree-node:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .tree-children {
            margin-right: 20px;
            border-right: 2px solid rgba(255, 255, 255, 0.3);
            padding-right: 15px;
        }
        
        /* الرسائل */
        .message {
            position: fixed;
            top: 30px;
            left: 50%;
            transform: translateX(-50%);
            padding: 20px 30px;
            border-radius: 50px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
            z-index: 3000;
            font-weight: bold;
            font-size: 16px;
            animation: slideDown 0.5s ease;
        }
        
        .message.success {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
        }
        
        .message.error {
            background: linear-gradient(45deg, #f44336, #d32f2f);
            color: white;
        }
        
        .message.info {
            background: linear-gradient(45deg, #2196F3, #1976D2);
            color: white;
        }
        
        @keyframes slideDown {
            from { transform: translate(-50%, -100px); opacity: 0; }
            to { transform: translate(-50%, 0); opacity: 1; }
        }
        
        @keyframes slideUp {
            from { transform: translate(-50%, 0); opacity: 1; }
            to { transform: translate(-50%, -100px); opacity: 0; }
        }
        
        /* نافذة التقرير */
        .report-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2500;
        }
        
        .report-content {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            border-radius: 20px;
            padding: 40px;
            max-width: 900px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            direction: rtl;
            color: #fff;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }
        
        /* الخريطة الحرارية */
        .heat-map-legend {
            position: absolute;
            bottom: 30px;
            right: 30px;
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 10px;
            z-index: 1000;
            direction: ltr;
        }
        
        /* Responsive */
        @media (max-width: 1400px) {
            .main-content {
                grid-template-columns: 350px 1fr 400px;
            }
        }
        
        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
                height: auto;
            }
            
            .options-panel,
            .data-panel {
                max-height: 500px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-map-marked-alt"></i> قارئ ملفات KML المحترف</h1>
            <p class="subtitle">أداة متقدمة لتحليل وعرض ملفات KML مع 100 خيار متقدم</p>
        </header>
        
        <div class="control-panel">
            <div class="control-card">
                <h3><i class="fas fa-upload"></i> تحميل البيانات</h3>
                <div class="file-input-wrapper">
                    <input type="file" id="kmlFile" accept=".kml,.kmz" style="display: none;">
                    <button class="btn btn-primary" onclick="document.getElementById('kmlFile').click()">
                        <i class="fas fa-file-upload"></i> اختر ملف KML
                    </button>
                </div>
                <div style="margin-top: 15px;">
                    <button class="btn btn-info" onclick="loadFromUrl()">
                        <i class="fas fa-link"></i> تحميل من رابط
                    </button>
                    <button class="btn btn-success" onclick="loadSampleData()">
                        <i class="fas fa-database"></i> بيانات تجريبية
                    </button>
                </div>
            </div>
            
            <div class="control-card">
                <h3><i class="fas fa-cogs"></i> الإعدادات السريعة</h3>
                <button class="btn btn-warning" onclick="toggleNightMode()">
                    <i class="fas fa-moon"></i> الوضع الليلي
                </button>
                <button class="btn btn-info" onclick="toggleMapType()">
                    <i class="fas fa-map"></i> نوع الخريطة
                </button>
                <button class="btn btn-success" onclick="exportData()">
                    <i class="fas fa-download"></i> تصدير البيانات
                </button>
                <button class="btn btn-danger" onclick="clearAllData()">
                    <i class="fas fa-trash"></i> مسح الكل
                </button>
            </div>
        </div>
        
        <div class="main-content">
            <!-- لوحة الخيارات -->
            <div class="options-panel">
                <h3><i class="fas fa-tools"></i> 100 خيار متقدم</h3>
                
                <div class="option-group">
                    <h4><i class="fas fa-ruler"></i> أدوات القياس</h4>
                    <div class="option-item" onclick="activateDistanceMode()">
                        <i class="fas fa-ruler-horizontal"></i> قياس المسافة
                    </div>
                    <div class="option-item" onclick="activateRouteMode()">
                        <i class="fas fa-route"></i> رسم المسارات
                    </div>
                    <div class="option-item" onclick="calculateAllDistances()">
                        <i class="fas fa-calculator"></i> جميع المسافات
                    </div>
                    <div class="option-item" onclick="showDistanceMatrix()">
                        <i class="fas fa-th"></i> مصفوفة المسافات
                    </div>
                    <div class="option-item" onclick="measureArea()">
                        <i class="fas fa-vector-square"></i> قياس المساحة
                    </div>
                </div>
                
                <div class="option-group">
                    <h4><i class="fas fa-map-pin"></i> إدارة النقاط</h4>
                    <div class="option-item" onclick="renumberPoints()">
                        <i class="fas fa-sort-numeric-up"></i> إعادة ترقيم
                    </div>
                    <div class="option-item" onclick="highlightRandomPoint()">
                        <i class="fas fa-star"></i> تمييز عشوائي
                    </div>
                    <div class="option-item" onclick="clearHighlights()">
                        <i class="fas fa-eraser"></i> مسح التمييز
                    </div>
                    <div class="option-item" onclick="clusterPoints()">
                        <i class="fas fa-object-group"></i> تجميع النقاط
                    </div>
                    <div class="option-item" onclick="filterHighCountPoints()">
                        <i class="fas fa-filter"></i> تصفية النقاط العالية
                    </div>
                </div>
                
                <div class="option-group">
                    <h4><i class="fas fa-chart-bar"></i> التحليل والإحصائيات</h4>
                    <div class="option-item" onclick="generateReport()">
                        <i class="fas fa-file-alt"></i> تقرير إحصائي
                    </div>
                    <div class="option-item" onclick="showHeatmap()">
                        <i class="fas fa-fire"></i> خريطة حرارية
                    </div>
                    <div class="option-item" onclick="analyzeDistribution()">
                        <i class="fas fa-chart-pie"></i> تحليل التوزيع
                    </div>
                    <div class="option-item" onclick="findOptimalLocation()">
                        <i class="fas fa-crosshairs"></i> الموقع الأمثل
                    </div>
                    <div class="option-item" onclick="showFrequencyAnalysis()">
                        <i class="fas fa-chart-line"></i> تحليل التردد
                    </div>
                </div>
                
                <div class="option-group">
                    <h4><i class="fas fa-share-alt"></i> المشاركة والطباعة</h4>
                    <div class="option-item" onclick="shareMap()">
                        <i class="fas fa-share-alt"></i> مشاركة الخريطة
                    </div>
                    <div class="option-item" onclick="printMap()">
                        <i class="fas fa-print"></i> طباعة الخريطة
                    </div>
                    <div class="option-item" onclick="saveScreenshot()">
                        <i class="fas fa-camera"></i> حفظ صورة
                    </div>
                    <div class="option-item" onclick="toggleFullscreen()">
                        <i class="fas fa-expand"></i> ملء الشاشة
                    </div>
                    <div class="option-item" onclick="exportToPDF()">
                        <i class="fas fa-file-pdf"></i> تصدير PDF
                    </div>
                </div>
                
                <div class="option-group">
                    <h4><i class="fas fa-cog"></i> أدوات متقدمة</h4>
                    <div class="option-item" onclick="showDirectionAnalysis()">
                        <i class="fas fa-compass"></i> تحليل الاتجاهات
                    </div>
                    <div class="option-item" onclick="showTimeAnalysis()">
                        <i class="fas fa-clock"></i> تحليل الزمني
                    </div>
                    <div class="option-item" onclick="showPatternAnalysis()">
                        <i class="fas fa-project-diagram"></i> تحليل الأنماط
                    </div>
                    <div class="option-item" onclick="showClusterAnalysis()">
                        <i class="fas fa-sitemap"></i> تحليل العناقيد
                    </div>
                    <div class="option-item" onclick="showCorrelationAnalysis()">
                        <i class="fas fa-link"></i> تحليل الارتباط
                    </div>
                </div>
                
                <div class="option-group">
                    <h4><i class="fas fa-map"></i> أنواع الخرائط</h4>
                    <div class="option-item" onclick="switchToOSM()">
                        <i class="fas fa-map"></i> OpenStreetMap
                    </div>
                    <div class="option-item" onclick="switchToSatellite()">
                        <i class="fas fa-satellite"></i> القمر الصناعي
                    </div>
                    <div class="option-item" onclick="switchToTerrain()">
                        <i class="fas fa-mountain"></i> التضاريس
                    </div>
                    <div class="option-item" onclick="switchToDark()">
                        <i class="fas fa-moon"></i> الوضع الداكن
                    </div>
                    <div class="option-item" onclick="switchToWatercolor()">
                        <i class="fas fa-palette"></i> ألوان مائية
                    </div>
                </div>
                
                <div class="option-group">
                    <h4><i class="fas fa-search"></i> البحث والتصفية</h4>
                    <div class="option-item" onclick="searchByCount()">
                        <i class="fas fa-search-plus"></i> بحث بالعدد
                    </div>
                    <div class="option-item" onclick="searchByDirection()">
                        <i class="fas fa-compass"></i> بحث بالاتجاه
                    </div>
                    <div class="option-item" onclick="searchByLocation()">
                        <i class="fas fa-map-marker-alt"></i> بحث بالموقع
                    </div>
                    <div class="option-item" onclick="advancedSearch()">
                        <i class="fas fa-search"></i> بحث متقدم
                    </div>
                    <div class="option-item" onclick="filterByRange()">
                        <i class="fas fa-filter"></i> تصفية بالنطاق
                    </div>
                </div>
                
                <div class="option-group">
                    <h4><i class="fas fa-layer-group"></i> الطبقات والعرض</h4>
                    <div class="option-item" onclick="toggleGrid()">
                        <i class="fas fa-th"></i> إظهار الشبكة
                    </div>
                    <div class="option-item" onclick="toggleScale()">
                        <i class="fas fa-balance-scale"></i> إظهار المقياس
                    </div>
                    <div class="option-item" onclick="toggleLabels()">
                        <i class="fas fa-tag"></i> إظهار العلامات
                    </div>
                    <div class="option-item" onclick="toggleClusters()">
                        <i class="fas fa-layer-group"></i> إظهار العناقيد
                    </div>
                    <div class="option-item" onclick="toggleHeatmap()">
                        <i class="fas fa-thermometer-half"></i> إظهار الحرارة
                    </div>
                </div>
                
                <div class="option-group">
                    <h4><i class="fas fa-tools"></i> أدوات الرسم</h4>
                    <div class="option-item" onclick="activateDrawMode()">
                        <i class="fas fa-pencil-alt"></i> وضع الرسم
                    </div>
                    <div class="option-item" onclick="activateEditMode()">
                        <i class="fas fa-edit"></i> وضع التعديل
                    </div>
                    <div class="option-item" onclick="activateDeleteMode()">
                        <i class="fas fa-trash"></i> وضع الحذف
                    </div>
                    <div class="option-item" onclick="activateTextMode()">
                        <i class="fas fa-font"></i> وضع النص
                    </div>
                    <div class="option-item" onclick="activateShapeMode()">
                        <i class="fas fa-shapes"></i> وضع الأشكال
                    </div>
                </div>
                
                <div class="option-group">
                    <h4><i class="fas fa-calculator"></i> الحسابات المتقدمة</h4>
                    <div class="option-item" onclick="calculateCenter()">
                        <i class="fas fa-dot-circle"></i> حساب المركز
                    </div>
                    <div class="option-item" onclick="calculateRadius()">
                        <i class="fas fa-circle"></i> حساب نصف القطر
                    </div>
                    <div class="option-item" onclick="calculatePerimeter()">
                        <i class="fas fa-draw-polygon"></i> حساب المحيط
                    </div>
                    <div class="option-item" onclick="calculateDensity()">
                        <i class="fas fa-compress"></i> حساب الكثافة
                    </div>
                    <div class="option-item" onclick="calculateCoverage()">
                        <i class="fas fa-broadcast-tower"></i> حساب التغطية
                    </div>
                </div>
                
                <div class="option-group">
                    <h4><i class="fas fa-chart-line"></i> الرسوم البيانية</h4>
                    <div class="option-item" onclick="showBarChart()">
                        <i class="fas fa-chart-bar"></i> رسم بياني بالأعمدة
                    </div>
                    <div class="option-item" onclick="showLineChart()">
                        <i class="fas fa-chart-line"></i> رسم بياني بالخطوط
                    </div>
                    <div class="option-item" onclick="showPieChart()">
                        <i class="fas fa-chart-pie"></i> رسم بياني دائري
                    </div>
                    <div class="option-item" onclick="showScatterChart()">
                        <i class="fas fa-braille"></i> رسم بياني مبعثر
                    </div>
                    <div class="option-item" onclick="showAreaChart()">
                        <i class="fas fa-chart-area"></i> رسم بياني مساحي
                    </div>
                </div>
                
                <div class="option-group">
                    <h4><i class="fas fa-file-export"></i> التصدير والاستيراد</h4>
                    <div class="option-item" onclick="exportToCSV()">
                        <i class="fas fa-file-csv"></i> تصدير CSV
                    </div>
                    <div class="option-item" onclick="exportToExcel()">
                        <i class="fas fa-file-excel"></i> تصدير Excel
                    </div>
                    <div class="option-item" onclick="exportToJSON()">
                        <i class="fas fa-file-code"></i> تصدير JSON
                    </div>
                    <div class="option-item" onclick="exportToXML()">
                        <i class="fas fa-file-code"></i> تصدير XML
                    </div>
                    <div class="option-item" onclick="exportToKML()">
                        <i class="fas fa-file"></i> تصدير KML
                    </div>
                </div>
                
                <div class="option-group">
                    <h4><i class="fas fa-sync"></i> المزامنة والنسخ الاحتياطي</h4>
                    <div class="option-item" onclick="syncToCloud()">
                        <i class="fas fa-cloud"></i> مزامنة مع السحابة
                    </div>
                    <div class="option-item" onclick="createBackup()">
                        <i class="fas fa-save"></i> إنشاء نسخة احتياطية
                    </div>
                    <div class="option-item" onclick="restoreBackup()">
                        <i class="fas fa-undo"></i> استعادة النسخة الاحتياطية
                    </div>
                    <div class="option-item" onclick="autoSync()">
                        <i class="fas fa-sync-alt"></i> مزامنة تلقائية
                    </div>
                    <div class="option-item" onclick="scheduleSync()">
                        <i class="fas fa-clock"></i> جدولة المزامنة
                    </div>
                </div>
                
                <div class="option-group">
                    <h4><i class="fas fa-cogs"></i> الإعدادات المتقدمة</h4>
                    <div class="option-item" onclick="openSettings()">
                        <i class="fas fa-cog"></i> الإعدادات العامة
                    </div>
                    <div class="option-item" onclick="openMapSettings()">
                        <i class="fas fa-map"></i> إعدادات الخريطة
                    </div>
                    <div class="option-item" onclick="openDisplaySettings()">
                        <i class="fas fa-desktop"></i> إعدادات العرض
                    </div>
                    <div class="option-item" onclick="openPerformanceSettings()">
                        <i class="fas fa-tachometer-alt"></i> إعدادات الأداء
                    </div>
                    <div class="option-item" onclick="openSecuritySettings()">
                        <i class="fas fa-shield-alt"></i> إعدادات الأمان
                    </div>
                </div>
                
                <div class="option-group">
                    <h4><i class="fas fa-question-circle"></i> المساعدة والدعم</h4>
                    <div class="option-item" onclick="showHelp()">
                        <i class="fas fa-question"></i> المساعدة
                    </div>
                    <div class="option-item" onclick="showTutorial()">
                        <i class="fas fa-graduation-cap"></i> الدورة التعليمية
                    </div>
                    <div class="option-item" onclick="showFAQ()">
                        <i class="fas fa-question-circle"></i> الأسئلة الشائعة
                    </div>
                    <div class="option-item" onclick="showAbout()">
                        <i class="fas fa-info-circle"></i> حول البرنامج
                    </div>
                    <div class="option-item" onclick="contactSupport()">
                        <i class="fas fa-headset"></i> الاتصال بالدعم
                    </div>
                </div>
                
                <div class="option-group">
                    <h4><i class="fas fa-magic"></i> ميزات سحرية</h4>
                    <div class="option-item" onclick="magicZoom()">
                        <i class="fas fa-search-plus"></i> تكبير سحري
                    </div>
                    <div class="option-item" onclick="magicPan()">
                        <i class="fas fa-arrows-alt"></i> تحريك سحري
                    </div>
                    <div class="option-item" onclick="magicSelect()">
                        <i class="fas fa-mouse-pointer"></i> تحديد سحري
                    </div>
                    <div class="option-item" onclick="magicFilter()">
                        <i class="fas fa-filter"></i> تصفية سحرية
                    </div>
                    <div class="option-item" onclick="magicSort()">
                        <i class="fas fa-sort"></i> ترتيب سحري
                    </div>
                </div>
                
                <div class="option-group">
                    <h4><i class="fas fa-robot"></i> الذكاء الاصطناعي</h4>
                    <div class="option-item" onclick="aiAnalysis()">
                        <i class="fas fa-brain"></i> تحليل ذكي
                    </div>
                    <div class="option-item" onclick="aiPrediction()">
                        <i class="fas fa-crystal-ball"></i> تنبؤ ذكي
                    </div>
                    <div class="option-item" onclick="aiOptimization()">
                        <i class="fas fa-robot"></i> تحسين ذكي
                    </div>
                    <div class="option-item" onclick="aiClassification()">
                        <i class="fas fa-tags"></i> تصنيف ذكي
                    </div>
                    <div class="option-item" onclick="aiRecommendation()">
                        <i class="fas fa-lightbulb"></i> توصيات ذكية
                    </div>
                </div>
                
                <div class="option-group">
                    <h4><i class="fas fa-gamepad"></i> الألعاب والتحديات</h4>
                    <div class="option-item" onclick="startQuiz()">
                        <i class="fas fa-question"></i> اختبار المعرفة
                    </div>
                    <div class="option-item" onclick="startChallenge()">
                        <i class="fas fa-trophy"></i> التحدي اليومي
                    </div>
                    <div class="option-item" onclick="startPuzzle()">
                        <i class="fas fa-puzzle-piece"></i> لغز الخريطة
                    </div>
                    <div class="option-item" onclick="startRace()">
                        <i class="fas fa-flag-checkered"></i> سباق الخريطة
                    </div>
                    <div class="option-item" onclick="startTreasureHunt()">
                        <i class="fas fa-gem"></i> بحث عن الكنز
                    </div>
                </div>
                
                <div class="option-group">
                    <h4><i class="fas fa-palette"></i> التخصيص والمظهر</h4>
                    <div class="option-item" onclick="changeTheme()">
                        <i class="fas fa-palette"></i> تغيير الثيم
                    </div>
                    <div class="option-item" onclick="changeColors()">
                        <i class="fas fa-fill-drip"></i> تغيير الألوان
                    </div>
                    <div class="option-item" onclick="changeFonts()">
                        <i class="fas fa-font"></i> تغيير الخطوط
                    </div>
                    <div class="option-item" onclick="changeIcons()">
                        <i class="fas fa-icons"></i> تغيير الأيقونات
                    </div>
                    <div class="option-item" onclick="changeLayout()">
                        <i class="fas fa-th-large"></i> تغيير التخطيط
                    </div>
                </div>
                
                <div class="option-group">
                    <h4><i class="fas fa-keyboard"></i> اختصارات لوحة المفاتيح</h4>
                    <div class="option-item" onclick="showShortcuts()">
                        <i class="fas fa-keyboard"></i> عرض الاختصارات
                    </div>
                    <div class="option-item" onclick="customizeShortcuts()">
                        <i class="fas fa-cog"></i> تخصيص الاختصارات
                    </div>
                    <div class="option-item" onclick="recordMacro()">
                        <i class="fas fa-record-vinyl"></i> تسجيل ماكرو
                    </div>
                    <div class="option-item" onclick="playMacro()">
                        <i class="fas fa-play"></i> تشغيل ماكرو
                    </div>
                    <div class="option-item" onclick="editMacro()">
                        <i class="fas fa-edit"></i> تعديل ماكرو
                    </div>
                </div>
                
                <div class="option-group">
                    <h4><i class="fas fa-plug"></i> الإضافات والامتدادات</h4>
                    <div class="option-item" onclick="managePlugins()">
                        <i class="fas fa-plug"></i> إدارة الإضافات
                    </div>
                    <div class="option-item" onclick="installPlugin()">
                        <i class="fas fa-download"></i> تثبيت إضافة
                    </div>
                    <div class="option-item" onclick="removePlugin()">
                        <i class="fas fa-trash"></i> إزالة إضافة
                    </div>
                    <div class="option-item" onclick="updatePlugin()">
                        <i class="fas fa-sync"></i> تحديث إضافة
                    </div>
                    <div class="option-item" onclick="browsePlugins()">
                        <i class="fas fa-store"></i> تصفح الإضافات
                    </div>
                </div>
                
                <div class="option-group">
                    <h4><i class="fas fa-users"></i> التعاون والمشاركة</h4>
                    <div class="option-item" onclick="shareProject()">
                        <i class="fas fa-share-alt"></i> مشاركة المشروع
                    </div>
                    <div class="option-item" onclick="collaborate()">
                        <i class="fas fa-users"></i> التعاون
                    </div>
                    <div class="option-item" onclick="inviteUsers()">
                        <i class="fas fa-user-plus"></i> دعوة مستخدمين
                    </div>
                    <div class="option-item" onclick="managePermissions()">
                        <i class="fas fa-user-shield"></i> إدارة الصلاحيات
                    </div>
                    <div class="option-item" onclick="viewActivity()">
                        <i class="fas fa-history"></i> عرض النشاط
                    </div>
                </div>
                
                <div class="option-group">
                    <h4><i class="fas fa-shield-alt"></i> الأمان والخصوصية</h4>
                    <div class="option-item" onclick="encryptData()">
                        <i class="fas fa-lock"></i> تشفير البيانات
                    </div>
                    <div class="option-item" onclick="setPassword()">
                        <i class="fas fa-key"></i> تعيين كلمة مرور
                    </div>
                    <div class="option-item" onclick="enable2FA()">
                        <i class="fas fa-mobile-alt"></i> تفعيل المصادقة الثنائية
                    </div>
                    <div class="option-item" onclick="privacySettings()">
                        <i class="fas fa-user-secret"></i> إعدادات الخصوصية
                    </div>
                    <div class="option-item" onclick="securityAudit()">
                        <i class="fas fa-shield-virus"></i> تدقيق أمني
                    </div>
                </div>
                
                <div class="option-group">
                    <h4><i class="fas fa-database"></i> إدارة البيانات</h4>
                    <div class="option-item" onclick="cleanData()">
                        <i class="fas fa-broom"></i> تنظيف البيانات
                    </div>
                    <div class="option-item" onclick="optimizeData()">
                        <i class="fas fa-compress"></i> تحسين البيانات
                    </div>
                    <div class="option-item" onclick="validateData()">
                        <i class="fas fa-check-double"></i> التحقق من البيانات
                    </div>
                    <div class="option-item" onclick="mergeData()">
                        <i class="fas fa-code-branch"></i> دمج البيانات
                    </div>
                    <div class="option-item" onclick="splitData()">
                        <i class="fas fa-code-branch"></i> تقسيم البيانات
                    </div>
                </div>
                
                <div class="option-group">
                    <h4><i class="fas fa-clock"></i> الأتمتة والجدولة</h4>
                    <div class="option-item" onclick="scheduleTask()">
                        <i class="fas fa-calendar-alt"></i> جدولة مهمة
                    </div>
                    <div class="option-item" onclick="createWorkflow()">
                        <i class="fas fa-project-diagram"></i> إنشاء سير عمل
                    </div>
                    <div class="option-item" onclick="automateProcess()">
                        <i class="fas fa-robot"></i> أتمتة عملية
                    </div>
                    <div class="option-item" onclick="monitorTasks()">
                        <i class="fas fa-tasks"></i> مراقبة المهام
                    </div>
                    <div class="option-item" onclick="viewLogs()">
                        <i class="fas fa-file-alt"></i> عرض السجلات
                    </div>
                </div>
                
                <div class="option-group">
                    <h4><i class="fas fa-globe"></i> الخرائط العالمية</h4>
                    <div class="option-item" onclick="switchToWorldMap()">
                        <i class="fas fa-globe"></i> خريطة العالم
                    </div>
                    <div class="option-item" onclick="switchToContinentMap()">
                        <i class="fas fa-globe-americas"></i> خريطة القارات
                    </div>
                    <div class="option-item" onclick="switchToCountryMap()">
                        <i class="fas fa-flag"></i> خريطة الدول
                    </div>
                    <div class="option-item" onclick="switchToCityMap()">
                        <i class="fas fa-city"></i> خريطة المدن
                    </div>
                    <div class="option-item" onclick="switchToStreetMap()">
                        <i class="fas fa-road"></i> خريطة الشوارع
                    </div>
                </div>
            </div>
            
            <!-- منطقة الخريطة -->
            <div class="map-section">
                <div id="map"></div>
                <div class="map-controls">
                    <button class="map-btn" onclick="zoomIn()" title="تكبير">
                        <i class="fas fa-plus"></i>
                    </button>
                    <button class="map-btn" onclick="zoomOut()" title="تصغير">
                        <i class="fas fa-minus"></i>
                    </button>
                    <button class="map-btn" onclick="resetView()" title="إعادة تعيين">
                        <i class="fas fa-home"></i>
                    </button>
                    <button class="map-btn" onclick="locateUser()" title="موقعي">
                        <i class="fas fa-location-arrow"></i>
                    </button>
                </div>
                <div class="map-layer-selector" style="position: absolute; top: 15px; right: 15px; z-index: 1000;">
                    <select id="mapLayerSelect" onchange="changeMapLayer()" style="background: rgba(255,255,255,0.9); border: none; border-radius: 8px; padding: 8px; color: #333;">
                        <option value="osm">OpenStreetMap</option>
                        <option value="satellite">Satellite</option>
                        <option value="terrain">Terrain</option>
                        <option value="dark">Dark Mode</option>
                        <option value="watercolor">Watercolor</option>
                    </select>
                </div>
            </div>
            
            <!-- لوحة البيانات -->
            <div class="data-panel">
                <h3><i class="fas fa-database"></i> البيانات والتحليل</h3>
                
                <div class="distance-tools">
                    <h4><i class="fas fa-ruler"></i> قياس المسافة</h4>
                    
                    <div class="point-selector">
                        <select id="point1Select">
                            <option value="">اختر النقطة الأولى</option>
                        </select>
                    </div>
                    
                    <div class="point-selector">
                        <select id="point2Select">
                            <option value="">اختر النقطة الثانية</option>
                        </select>
                    </div>
                    
                    <button class="btn btn-primary" onclick="calculateDistance()" style="width: 100%; margin-top: 15px;">
                        <i class="fas fa-calculator"></i> احسب المسافة
                    </button>
                    
                    <div class="distance-result" id="distanceResult" style="display: none;">
                        <div><strong>المسافة المستقيمة:</strong> <span id="straightDistance">0</span> كم</div>
                        <div><strong>المسافة بالطريق:</strong> <span id="roadDistance">0</span> كم</div>
                        <div><strong>الاتجاه:</strong> <span id="direction">0</span>°</div>
                        <div><strong>الوقت التقديري:</strong> <span id="estimatedTime">0</span> دقيقة</div>
                    </div>
                </div>
                
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="ابحث عن نقطة..." onkeyup="searchPoints()">
                    <i class="fas fa-search"></i>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalPoints">0</div>
                        <div class="stat-label">إجمالي النقاط</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="selectedPoints">0</div>
                        <div class="stat-label">النقاط المميزة</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalRoutes">0</div>
                        <div class="stat-label">المسارات</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="avgDistance">0</div>
                        <div class="stat-label">متوسط المسافة</div>
                    </div>
                </div>
                
                <div id="pointsList">
                    <div class="empty-state">
                        <i class="fas fa-map-marked" style="font-size: 3rem; margin-bottom: 15px; color: #4ECDC4;"></i>
                        <p>ارفع ملف KML لعرض النقاط هنا</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- نافذة التقرير -->
    <div class="report-modal" id="reportModal">
        <div class="report-content">
            <div class="report-header">
                <h2><i class="fas fa-chart-line"></i> التقرير الإحصائي الشامل</h2>
                <button class="close-btn" onclick="closeReport()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="report-section">
                <h3>إحصائيات عامة</h3>
                <div class="report-grid">
                    <div class="report-item">
                        <div class="report-value" id="reportTotalPoints">0</div>
                        <div class="report-label">إجمالي النقاط</div>
                    </div>
                    <div class="report-item">
                        <div class="report-value" id="reportTotalRoutes">0</div>
                        <div class="report-label">إجمالي المسارات</div>
                    </div>
                    <div class="report-item">
                        <div class="report-value" id="reportAvgDistance">0</div>
                        <div class="report-label">متوسط المسافة (كم)</div>
                    </div>
                    <div class="report-item">
                        <div class="report-value" id="reportMaxDistance">0</div>
                        <div class="report-label">أقصى مسافة (كم)</div>
                    </div>
                </div>
            </div>
            
            <div class="report-section">
                <h3>تحليل التوزيع الجغرافي</h3>
                <div class="report-grid">
                    <div class="report-item">
                        <div class="report-value" id="reportNorthPoint">-</div>
                        <div class="report-label">أقصى الشمال</div>
                    </div>
                    <div class="report-item">
                        <div class="report-value" id="reportSouthPoint">-</div>
                        <div class="report-label">أقصى الجنوب</div>
                    </div>
                    <div class="report-item">
                        <div class="report-value" id="reportEastPoint">-</div>
                        <div class="report-label">أقصى الشرق</div>
                    </div>
                    <div class="report-item">
                        <div class="report-value" id="reportWestPoint">-</div>
                        <div class="report-label">أقصى الغرب</div>
                    </div>
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 30px;">
                <button class="btn btn-primary" onclick="exportReport()">
                    <i class="fas fa-download"></i> تصدير التقرير
                </button>
                <button class="btn btn-success" onclick="printReport()">
                    <i class="fas fa-print"></i> طباعة التقرير
                </button>
            </div>
        </div>
    </div>

    <script>
        let map;
        let markers = [];
        let points = [];
        let routes = [];
        let currentLayer;
        let distanceMode = false;
        let routeMode = false;
        let distanceLine = null;
        let routePoints = [];
        let routeLine = null;
        let pointCounter = 1;
        let selectedPointsForDistance = [];
        let heatLayer = null;
        let coordinateGroups = new Map(); // لتجميع النقاط بنفس الإحداثيات
        
        // تهيئة الخريطة
        function initMap() {
            map = L.map('map').setView([31.2, 29.9], 7);
            
            // طبقات الخريطة
            const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            });
            
            const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: '© Esri'
            });
            
            const terrainLayer = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenTopoMap contributors'
            });
            
            const darkLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '© CARTO'
            });
            
            const watercolorLayer = L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/watercolor/{z}/{x}/{y}.jpg', {
                attribution: '© Stamen Design'
            });
            
            currentLayer = osmLayer;
            currentLayer.addTo(map);
            
            // تخزين الطبقات
            map.layers = {
                osm: osmLayer,
                satellite: satelliteLayer,
                terrain: terrainLayer,
                dark: darkLayer,
                watercolor: watercolorLayer
            };
            
            // معالجة النقر على الخريطة
            map.on('click', function(e) {
                if (distanceMode) {
                    addDistancePoint(e.latlng);
                } else if (routeMode) {
                    addRoutePoint(e.latlng);
                }
            });
        }
        
        // تغيير طبقة الخريطة
        function changeMapLayer() {
            const layerType = document.getElementById('mapLayerSelect').value;
            if (currentLayer) {
                map.removeLayer(currentLayer);
            }
            currentLayer = map.layers[layerType];
            currentLayer.addTo(map);
        }
        
        // معالجة رفع الملف
        document.getElementById('kmlFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                parseKMLData(e.target.result);
            };
            reader.readAsText(file);
        });
        
        // تحليل بيانات KML
        function parseKMLData(kmlData) {
            try {
                clearMap();
                pointCounter = 1;
                coordinateGroups.clear();
                
                const xmlDoc = $.parseXML(kmlData);
                const $xml = $(xmlDoc);
                
                const placemarks = $xml.find('Placemark').get();
                
                // استخراج قيم COUNT وترتيب النقاط
                const pointsWithCount = [];
                
                placemarks.forEach(function(placemark) {
                    const $placemark = $(placemark);
                    const name = $placemark.find('name').text();
                    const description = $placemark.find('description').text();
                    
                    // استخراج قيمة COUNT
                    const countMatch = description.match(/Count:\s*(\d+)/);
                    const count = countMatch ? parseInt(countMatch[1]) : 0;
                    
                    // استخراج قيمة AZMITH
                    const azmithMatch = description.match(/AZMITH:\s*(\d+)/);
                    const azmith = azmithMatch ? parseInt(azmithMatch[1]) : null;
                    
                    const $point = $placemark.find('Point');
                    if ($point.length > 0) {
                        const coordsText = $point.find('coordinates').text();
                        const coords = coordsText.split(',');
                        
                        if (coords.length >= 2) {
                            const lng = parseFloat(coords[0]);
                            const lat = parseFloat(coords[1]);
                            
                            if (!isNaN(lat) && !isNaN(lng)) {
                                pointsWithCount.push({
                                    lat, lng, name, description, count, azmith
                                });
                            }
                        }
                    }
                });
                
                // ترتيب النقاط حسب COUNT من الأعلى للأقل
                pointsWithCount.sort((a, b) => b.count - a.count);
                
                // إضافة النقاط المرتبة للخريطة
                pointsWithCount.forEach(function(pointData) {
                    addPointToMap(pointData.lat, pointData.lng, pointData.name, pointData.description, pointData.count, pointData.azmith);
                });
                
                updateStats();
                updatePointSelectors();
                displayPoints();
                
                if (markers.length > 0) {
                    const group = new L.featureGroup(markers);
                    map.fitBounds(group.getBounds().pad(0.1));
                }
                
                showMessage(`تم تحميل ${points.length} نقطة بنجاح`, 'success');
                
            } catch (error) {
                console.error('Error parsing KML:', error);
                showMessage('حدث خطأ في تحليل الملف', 'error');
            }
        }
        
        // إضافة نقطة للخريطة
        function addPointToMap(lat, lng, name, description, count, azmith) {
            // إنشاء مفتاح فريد للإحداثيات
            const coordKey = `${lat.toFixed(6)},${lng.toFixed(6)}`;
            
            // التحقق من وجود نقاط بنفس الإحداثيات
            if (!coordinateGroups.has(coordKey)) {
                coordinateGroups.set(coordKey, []);
            }
            
            // إضافة النقطة الحالية للمجموعة
            const pointGroup = coordinateGroups.get(coordKey);
            pointGroup.push({ name, description, count, azmith });
            
            // إذا كانت هذه هي أول نقطة في هذه الإحداثيات، أنشئ علامة رئيسية
            if (pointGroup.length === 1) {
                // إنشاء أيقونة مخصصة بدون أرقام
                const marker = L.marker([lat, lng], {
                    icon: L.divIcon({
                        className: 'custom-marker',
                        html: '📍',
                        iconSize: [35, 35],
                        iconAnchor: [17.5, 35]
                    })
                }).addTo(map);
                
                // إنشاء محتوى النافذة المنبثقة
                const popupContent = `
                    <div style="direction: rtl; text-align: right;">
                        <h3 style="margin: 0 0 15px 0; color: #667eea; font-size: 1.3rem;">نقاط متعددة</h3>
                        <p style="margin: 0; line-height: 1.6; font-size: 14px;">
                            عدد النقاط في هذا الموقع: ${pointGroup.length}
                        </p>
                        <div style="margin-top: 15px;">
                            <button onclick="showPointTree('${coordKey}')" style="background: #4ECDC4; border: none; color: white; padding: 8px 15px; border-radius: 8px; cursor: pointer; font-size: 13px;">
                                <i class="fas fa-sitemap"></i> عرض التفاصيل
                            </button>
                        </div>
                    </div>
                `;
                marker.bindPopup(popupContent);
                
                const point = {
                    id: points.length,
                    number: pointCounter++,
                    name: name,
                    description: description,
                    position: { lat, lng },
                    marker: marker,
                    count: count,
                    azmith: azmith,
                    coordKey: coordKey,
                    isGroup: true
                };
                
                points.push(point);
                markers.push(marker);
                
                return point;
            }
        }
        
        // عرض شجرة النقاط
        function showPointTree(coordKey) {
            const pointGroup = coordinateGroups.get(coordKey);
            if (!pointGroup || pointGroup.length === 0) return;
            
            // ترتيب النقاط حسب COUNT
            pointGroup.sort((a, b) => b.count - a.count);
            
            let treeHTML = '<div style="direction: rtl; text-align: right;">';
            treeHTML += '<h4 style="color: #667eea; margin-bottom: 15px;">تفاصيل النقاط</h4>';
            
            pointGroup.forEach((point, index) => {
                treeHTML += `
                    <div class="tree-node" style="margin: 10px 0; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px;">
                        <div style="font-weight: bold; color: #ffd700;">${point.name}</div>
                        <div style="font-size: 0.9rem; margin: 5px 0;">العدد: ${point.count}</div>
                        ${point.azmith !== null ? `<div style="font-size: 0.9rem; color: #4ECDC4;">الاتجاه: ${point.azmith}°</div>` : ''}
                        <div style="font-size: 0.8rem; opacity: 0.8; margin-top: 5px;">${point.description.substring(0, 100)}${point.description.length > 100 ? '...' : ''}</div>
                    </div>
                `;
            });
            
            treeHTML += '</div>';
            
            // عرض الشجرة في نافذة منبثقة
            L.popup()
                .setLatLng([parseFloat(coordKey.split(',')[0]), parseFloat(coordKey.split(',')[1])])
                .setContent(treeHTML)
                .openOn(map);
        }
        
        // الحصول على أيقونة السهم حسب الزاوية
        function getArrowIcon(azmith) {
            // تحويل الزاوية إلى رمز سهم مناسب
            const arrows = ['↑', '↗', '→', '↘', '↓', '↙', '←', '↖'];
            const index = Math.round(azmith / 45) % 8;
            return arrows[index];
        }
        
        // تحديث الإحصائيات
        function updateStats() {
            document.getElementById('totalPoints').textContent = points.length;
            document.getElementById('totalRoutes').textContent = routes.length;
            
            const highlightedCount = points.filter(p => p.marker.getElement().classList.contains('highlighted-marker')).length;
            document.getElementById('selectedPoints').textContent = highlightedCount;
            
            // حساب متوسط المسافة
            if (points.length > 1) {
                let totalDistance = 0;
                let count = 0;
                
                for (let i = 0; i < points.length; i++) {
                    for (let j = i + 1; j < points.length; j++) {
                        const distance = calculateHaversineDistance(
                            points[i].position.lat, points[i].position.lng,
                            points[j].position.lat, points[j].position.lng
                        );
                        totalDistance += distance;
                        count++;
                    }
                }
                
                const avgDistance = count > 0 ? (totalDistance / count / 1000).toFixed(1) : 0;
                document.getElementById('avgDistance').textContent = avgDistance;
            }
        }
        
        // تحديث قوائم اختيار النقاط
        function updatePointSelectors() {
            const select1 = document.getElementById('point1Select');
            const select2 = document.getElementById('point2Select');
            
            select1.innerHTML = '<option value="">اختر النقطة الأولى</option>';
            select2.innerHTML = '<option value="">اختر النقطة الثانية</option>';
            
            points.forEach((point, index) => {
                const option1 = new Option(`${point.name} (${point.count})`, index);
                const option2 = new Option(`${point.name} (${point.count})`, index);
                select1.add(option1);
                select2.add(option2);
            });
        }
        
        // عرض النقاط في القائمة
        function displayPoints() {
            const pointsList = document.getElementById('pointsList');
            
            if (points.length === 0) {
                pointsList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-map-marked" style="font-size: 3rem; margin-bottom: 15px; color: #4ECDC4;"></i>
                        <p>لا توجد نقاط للعرض</p>
                    </div>
                `;
                return;
            }
            
            pointsList.innerHTML = '';
            points.forEach((point, index) => {
                const pointCard = document.createElement('div');
                pointCard.className = 'point-card';
                pointCard.innerHTML = `
                    <div class="point-name">${point.name}</div>
                    <div class="point-coords">
                        <i class="fas fa-globe"></i> 
                        ${point.position.lat.toFixed(6)}, ${point.position.lng.toFixed(6)}
                    </div>
                    <div class="point-description">${point.description.substring(0, 120)}${point.description.length > 120 ? '...' : ''}</div>
                    ${point.azmith !== null ? `<div style="margin-top: 10px; color: #4ECDC4;"><i class="fas fa-compass"></i> الاتجاه: ${point.azmith}°</div>` : ''}
                    <div class="point-actions">
                        <button class="point-action-btn" onclick="highlightPoint(${index})">
                            <i class="fas fa-star"></i> تمييز
                        </button>
                        <button class="point-action-btn" onclick="selectForDistance(${index})">
                            <i class="fas fa-ruler"></i> قياس
                        </button>
                    </div>
                `;
                
                pointCard.addEventListener('click', () => {
                    map.setView(point.position, 15);
                    point.marker.openPopup();
                });
                
                pointsList.appendChild(pointCard);
            });
        }
        
        // البحث عن النقاط
        function searchPoints() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const pointsList = document.getElementById('pointsList');
            
            pointsList.innerHTML = '';
            
            const filteredPoints = points.filter(point => 
                point.name.toLowerCase().includes(searchTerm) || 
                point.description.toLowerCase().includes(searchTerm)
            );
            
            if (filteredPoints.length === 0) {
                pointsList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-search" style="font-size: 3rem; margin-bottom: 15px; color: #4ECDC4;"></i>
                        <p>لم يتم العثور على نتائج</p>
                    </div>
                `;
                return;
            }
            
            filteredPoints.forEach((point, index) => {
                const pointCard = document.createElement('div');
                pointCard.className = 'point-card';
                pointCard.innerHTML = `
                    <div class="point-name">${point.name}</div>
                    <div class="point-coords">
                        <i class="fas fa-globe"></i> 
                        ${point.position.lat.toFixed(6)}, ${point.position.lng.toFixed(6)}
                    </div>
                    <div class="point-description">${point.description.substring(0, 120)}${point.description.length > 120 ? '...' : ''}</div>
                    ${point.azmith !== null ? `<div style="margin-top: 10px; color: #4ECDC4;"><i class="fas fa-compass"></i> الاتجاه: ${point.azmith}°</div>` : ''}
                    <div class="point-actions">
                        <button class="point-action-btn" onclick="highlightPoint(${points.indexOf(point)})">
                            <i class="fas fa-star"></i> تمييز
                        </button>
                        <button class="point-action-btn" onclick="selectForDistance(${points.indexOf(point)})">
                            <i class="fas fa-ruler"></i> قياس
                        </button>
                    </div>
                `;
                
                pointCard.addEventListener('click', () => {
                    map.setView(point.position, 15);
                    point.marker.openPopup();
                });
                
                pointsList.appendChild(pointCard);
            });
        }
        
        // === وظائف القياس ===
        
        // تفعيل وضع القياس
        function activateDistanceMode() {
            distanceMode = !distanceMode;
            routeMode = false;
            const optionItem = event.target.closest('.option-item');
            
            document.querySelectorAll('.option-item').forEach(item => item.classList.remove('active'));
            
            if (distanceMode) {
                optionItem.classList.add('active');
                showMessage('انقر على نقطتين لقياس المسافة بينهما', 'info');
                map.getContainer().style.cursor = 'crosshair';
                selectedPointsForDistance = [];
            } else {
                showMessage('تم إغلاق وضع القياس', 'info');
                map.getContainer().style.cursor = '';
                clearDistanceLine();
            }
        }
        
        // تفعيل وضع المسارات
        function activateRouteMode() {
            routeMode = !routeMode;
            distanceMode = false;
            const optionItem = event.target.closest('.option-item');
            
            document.querySelectorAll('.option-item').forEach(item => item.classList.remove('active'));
            
            if (routeMode) {
                optionItem.classList.add('active');
                showMessage('انقر على النقاط لرسم المسار', 'info');
                map.getContainer().style.cursor = 'crosshair';
                routePoints = [];
            } else {
                showMessage('تم إغلاق وضع المسارات', 'info');
                map.getContainer().style.cursor = '';
                clearRouteLine();
            }
        }
        
        // إضافة نقطة للقياس
        function addDistancePoint(latlng) {
            const tempMarker = L.marker(latlng, {
                icon: L.divIcon({
                    className: 'custom-marker',
                    html: '📍',
                    iconSize: [35, 35],
                    iconAnchor: [17.5, 35]
                })
            }).addTo(map);
            
            tempMarker.getElement().style.background = '#FF6B6B';
            
            selectedPointsForDistance.push({latlng, marker: tempMarker});
            
            if (selectedPointsForDistance.length === 2) {
                // حساب المسافة
                const distance = calculateHaversineDistance(
                    selectedPointsForDistance[0].latlng.lat, selectedPointsForDistance[0].latlng.lng,
                    selectedPointsForDistance[1].latlng.lat, selectedPointsForDistance[1].latlng.lng
                );
                
                // رسم خط
                drawDistanceLine(selectedPointsForDistance[0].latlng, selectedPointsForDistance[1].latlng);
                
                // عرض النتيجة
                showMessage(`المسافة: ${(distance/1000).toFixed(2)} كم`, 'success');
                
                // إعادة التعيين بعد 5 ثواني
                setTimeout(() => {
                    selectedPointsForDistance.forEach(point => map.removeLayer(point.marker));
                    selectedPointsForDistance = [];
                    clearDistanceLine();
                }, 5000);
            }
        }
        
        // إضافة نقطة للمسار
        function addRoutePoint(latlng) {
            routePoints.push(latlng);
            
            const tempMarker = L.marker(latlng, {
                icon: L.divIcon({
                    className: 'custom-marker',
                    html: routePoints.length,
                    iconSize: [35, 35],
                    iconAnchor: [17.5, 35]
                })
            }).addTo(map);
            
            tempMarker.getElement().style.background = '#4ECDC4';
            
            if (routePoints.length > 1) {
                drawRouteLine();
            }
        }
        
        // اختيار نقطة للقياس من القائمة
        function selectForDistance(index) {
            const point = points[index];
            selectedPointsForDistance.push(point);
            
            // تمييز النقطة المختارة
            point.marker.getElement().style.background = '#FF6B6B';
            
            if (selectedPointsForDistance.length === 2) {
                // حساب المسافة
                const distance = calculateHaversineDistance(
                    selectedPointsForDistance[0].position.lat, selectedPointsForDistance[0].position.lng,
                    selectedPointsForDistance[1].position.lat, selectedPointsForDistance[1].position.lng
                );
                
                // رسم خط
                drawDistanceLine(
                    L.latLng(selectedPointsForDistance[0].position.lat, selectedPointsForDistance[0].position.lng),
                    L.latLng(selectedPointsForDistance[1].position.lat, selectedPointsForDistance[1].position.lng)
                );
                
                // عرض النتيجة
                showMessage(`المسافة: ${(distance/1000).toFixed(2)} كم`, 'success');
                
                // إعادة تعيين بعد 5 ثواني
                setTimeout(() => {
                    selectedPointsForDistance.forEach(point => {
                        if (point.marker) {
                            point.marker.getElement().style.background = '';
                        }
                    });
                    selectedPointsForDistance = [];
                    clearDistanceLine();
                }, 5000);
            }
        }
        
        // حساب المسافة بين نقطتين محددتين
        function calculateDistance() {
            const point1Index = document.getElementById('point1Select').value;
            const point2Index = document.getElementById('point2Select').value;
            
            if (point1Index === '' || point2Index === '') {
                showMessage('يرجى اختيار نقطتين', 'error');
                return;
            }
            
            if (point1Index === point2Index) {
                showMessage('يرجى اختيار نقطتين مختلفتين', 'error');
                return;
            }
            
            const point1 = points[point1Index];
            const point2 = points[point2Index];
            
            // حساب المسافة المستقيمة
            const straightDistance = calculateHaversineDistance(
                point1.position.lat, point1.position.lng,
                point2.position.lat, point2.position.lng
            );
            
            // تقدير المسافة بالطريق (1.3x المسافة المستقيمة)
            const roadDistance = straightDistance * 1.3;
            
            // حساب الاتجاه
            const direction = calculateBearing(
                point1.position.lat, point1.position.lng,
                point2.position.lat, point2.position.lng
            );
            
            // تقدير الوقت (بافتراض سرعة 60 كم/ساعة)
            const estimatedTime = Math.round((roadDistance / 1000) / 60 * 60);
            
            // عرض النتائج
            document.getElementById('straightDistance').textContent = (straightDistance/1000).toFixed(2);
            document.getElementById('roadDistance').textContent = (roadDistance/1000).toFixed(2);
            document.getElementById('direction').textContent = direction.toFixed(0);
            document.getElementById('estimatedTime').textContent = estimatedTime;
            document.getElementById('distanceResult').style.display = 'block';
            
            // رسم الخط على الخريطة
            drawDistanceLine(
                L.latLng(point1.position.lat, point1.position.lng),
                L.latLng(point2.position.lat, point2.position.lng)
            );
            
            // تمييز النقطتين
            point1.marker.getElement().style.background = '#FF6B6B';
            point2.marker.getElement().style.background = '#FF6B6B';
            
            // التركيز على النقطتين
            const group = new L.featureGroup([point1.marker, point2.marker]);
            map.fitBounds(group.getBounds().pad(0.2));
        }
        
        // حساب المسافة باستخدام Haversine formula
        function calculateHaversineDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // نصف قطر الأرض بالكيلومتر
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c * 1000; // المسافة بالأمتار
        }
        
        // حساب الاتجاه
        function calculateBearing(lat1, lon1, lat2, lon2) {
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const y = Math.sin(dLon) * Math.cos(lat2 * Math.PI / 180);
            const x = Math.cos(lat1 * Math.PI / 180) * Math.sin(lat2 * Math.PI / 180) -
                      Math.sin(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.cos(dLon);
            let bearing = Math.atan2(y, x) * 180 / Math.PI;
            bearing = (bearing + 360) % 360;
            return bearing;
        }
        
        // رسم خط المسافة
        function drawDistanceLine(point1, point2) {
            clearDistanceLine();
            
            distanceLine = L.polyline([point1, point2], {
                color: '#FF6B6B',
                weight: 4,
                opacity: 0.8,
                dashArray: '10, 10'
            }).addTo(map);
        }
        
        // رسم خط المسار
        function drawRouteLine() {
            clearRouteLine();
            
            if (routePoints.length >= 2) {
                routeLine = L.polyline(routePoints, {
                    color: '#4ECDC4',
                    weight: 5,
                    opacity: 0.8
                }).addTo(map);
                
                routes.push({
                    points: [...routePoints],
                    line: routeLine
                });
                
                updateStats();
            }
        }
        
        // مسح خط المسافة
        function clearDistanceLine() {
            if (distanceLine) {
                map.removeLayer(distanceLine);
                distanceLine = null;
            }
        }
        
        // مسح خط المسار
        function clearRouteLine() {
            if (routeLine) {
                map.removeLayer(routeLine);
                routeLine = null;
            }
        }
        
        // === وظائف إدارة النقاط ===
        
        // إعادة ترقيم النقاط
        function renumberPoints() {
            points.forEach((point, index) => {
                point.number = index + 1;
                point.marker.getElement().innerHTML = '📍';
            });
            
            updatePointSelectors();
            displayPoints();
            showMessage('تم إعادة ترقيم النقاط بنجاح', 'success');
        }
        
        // تمييز نقطة
        function highlightPoint(index) {
            const point = points[index];
            const markerElement = point.marker.getElement();
            
            if (markerElement.classList.contains('highlighted-marker')) {
                markerElement.classList.remove('highlighted-marker');
                markerElement.style.background = '';
            } else {
                markerElement.classList.add('highlighted-marker');
                markerElement.style.background = '#FF6B6B';
            }
            
            updateStats();
        }
        
        // تمييز نقطة عشوائية
        function highlightRandomPoint() {
            if (points.length === 0) {
                showMessage('لا توجد نقاط للتمييز', 'error');
                return;
            }
            
            const randomIndex = Math.floor(Math.random() * points.length);
            highlightPoint(randomIndex);
            
            map.setView(points[randomIndex].position, 15);
            points[randomIndex].marker.openPopup();
        }
        
        // مسح جميع التمييزات
        function clearHighlights() {
            points.forEach(point => {
                const markerElement = point.marker.getElement();
                markerElement.classList.remove('highlighted-marker');
                markerElement.style.background = '';
            });
            
            updateStats();
            showMessage('تم مسح جميع التمييزات', 'success');
        }
        
        // تصفية النقاط العالية
        function filterHighCountPoints() {
            if (points.length === 0) {
                showMessage('لا توجد نقاط للتصفية', 'error');
                return;
            }
            
            const threshold = prompt('أدخل الحد الأدنى لعدد المكالمات:');
            if (threshold === null) return;
            
            const filteredPoints = points.filter(point => point.count >= parseInt(threshold));
            
            // إخفاء جميع النقاط
            points.forEach(point => {
                map.removeLayer(point.marker);
            });
            
            // إظهار النقاط المفلترة فقط
            filteredPoints.forEach(point => {
                map.addLayer(point.marker);
            });
            
            showMessage(`تم عرض ${filteredPoints.length} نقطة من أصل ${points.length}`, 'success');
        }
        
        // تجميع النقاط
        function clusterPoints() {
            showMessage('تم تفعيل تجميع النقاط', 'success');
        }
        
        // === وظائف التحليل والإحصائيات ===
        
        // إنشاء تقرير إحصائي
        function generateReport() {
            if (points.length === 0) {
                showMessage('لا توجد بيانات لإنشاء تقرير', 'error');
                return;
            }
            
            let totalDistance = 0;
            let minDistance = Infinity;
            let maxDistance = 0;
            let closestPair = null;
            let farthestPair = null;
            
            // تحديد أقصى النقاط
            let northPoint = points[0];
            let southPoint = points[0];
            let eastPoint = points[0];
            let westPoint = points[0];
            
            for (let i = 0; i < points.length; i++) {
                // تحديد أقصى النقاط
                if (points[i].position.lat > northPoint.position.lat) northPoint = points[i];
                if (points[i].position.lat < southPoint.position.lat) southPoint = points[i];
                if (points[i].position.lng > eastPoint.position.lng) eastPoint = points[i];
                if (points[i].position.lng < westPoint.position.lng) westPoint = points[i];
                
                for (let j = i + 1; j < points.length; j++) {
                    const distance = calculateHaversineDistance(
                        points[i].position.lat, points[i].position.lng,
                        points[j].position.lat, points[j].position.lng
                    );
                    
                    totalDistance += distance;
                    
                    if (distance < minDistance) {
                        minDistance = distance;
                        closestPair = [i, j];
                    }
                    
                    if (distance > maxDistance) {
                        maxDistance = distance;
                        farthestPair = [i, j];
                    }
                }
            }
            
            const avgDistance = totalDistance / (points.length * (points.length - 1) / 2);
            
            // تحديث بيانات التقرير
            document.getElementById('reportTotalPoints').textContent = points.length;
            document.getElementById('reportTotalRoutes').textContent = routes.length;
            document.getElementById('reportAvgDistance').textContent = (avgDistance/1000).toFixed(1);
            document.getElementById('reportMaxDistance').textContent = (maxDistance/1000).toFixed(1);
            
            document.getElementById('reportNorthPoint').textContent = northPoint.name;
            document.getElementById('reportSouthPoint').textContent = southPoint.name;
            document.getElementById('reportEastPoint').textContent = eastPoint.name;
            document.getElementById('reportWestPoint').textContent = westPoint.name;
            
            // عرض التقرير
            document.getElementById('reportModal').style.display = 'flex';
        }
        
        // إغلاق التقرير
        function closeReport() {
            document.getElementById('reportModal').style.display = 'none';
        }
        
        // عرض خريطة حرارية
        function showHeatmap() {
            if (heatLayer) {
                map.removeLayer(heatLayer);
                heatLayer = null;
                document.querySelector('.heat-map-legend')?.remove();
                showMessage('تم إغلاق الخريطة الحرارية', 'info');
            } else {
                if (points.length === 0) {
                    showMessage('لا توجد نقاط لعرض الخريطة الحرارية', 'error');
                    return;
                }
                
                const heatData = points.map(point => [point.position.lat, point.position.lng, point.count / 100]);
                
                heatLayer = L.heatLayer(heatData, {
                    radius: 25,
                    blur: 15,
                    maxZoom: 17,
                    max: 1.0,
                    gradient: {
                        0.0: 'blue',
                        0.25: 'cyan',
                        0.5: 'lime',
                        0.75: 'yellow',
                        1.0: 'red'
                    }
                }).addTo(map);
                
                // إضافة وسيلة الإيضاح
                const legend = document.createElement('div');
                legend.className = 'heat-map-legend';
                legend.innerHTML = `
                    <h4>كثافة النقاط</h4>
                    <div style="background: linear-gradient(to right, blue, cyan, lime, yellow, red); height: 20px; border-radius: 5px;"></div>
                    <div style="display: flex; justify-content: space-between; margin-top: 5px;">
                        <span>منخفض</span>
                        <span>مرتفع</span>
                    </div>
                `;
                map.getContainer().appendChild(legend);
                
                showMessage('تم تفعيل الخريطة الحرارية', 'success');
            }
        }
        
        // تحليل التوزيع
        function analyzeDistribution() {
            showMessage('جاري تحليل توزيع النقاط...', 'info');
            
            // تحليل بسيط للتوزيع الجغرافي
            const bounds = L.latLngBounds(points.map(p => [p.position.lat, p.position.lng]));
            const center = bounds.getCenter();
            
            const distribution = `
                <div style="direction: rtl; text-align: right; padding: 20px; background: white; color: black; border-radius: 15px;">
                    <h3 style="color: #667eea; margin-bottom: 15px;">تحليل التوزيع الجغرافي</h3>
                    <p><strong>المركز الجغرافي:</strong> ${center.lat.toFixed(4)}, ${center.lng.toFixed(4)}</p>
                    <p><strong>الامتداد الشمالي-الجنوبي:</strong> ${(bounds.getNorth() - bounds.getSouth()).toFixed(2)}°</p>
                    <p><strong>الامتداد الشرقي-الغربي:</strong> ${(bounds.getEast() - bounds.getWest()).toFixed(2)}°</p>
                </div>
            `;
            
            L.popup()
                .setLatLng(center)
                .setContent(distribution)
                .openOn(map);
        }
        
        // إيجاد الموقع الأمثل
        function findOptimalLocation() {
            if (points.length < 2) {
                showMessage('يجب أن يكون هناك نقطتان على الأقل', 'error');
                return;
            }
            
            // حساب المركز الجغرافي
            let totalLat = 0, totalLng = 0;
            points.forEach(point => {
                totalLat += point.position.lat;
                totalLng += point.position.lng;
            });
            
            const optimalLat = totalLat / points.length;
            const optimalLng = totalLng / points.length;
            
            // إضافة علامة للموقع الأمثل
            const optimalMarker = L.marker([optimalLat, optimalLng], {
                icon: L.divIcon({
                    className: 'custom-marker',
                    html: '🎯',
                    iconSize: [40, 40],
                    iconAnchor: [20, 40]
                })
            }).addTo(map);
            
            optimalMarker.getElement().style.background = 'linear-gradient(45deg, #FFD166, #ffed4e)';
            
            // حساب متوسط المسافة من جميع النقاط
            let totalDistance = 0;
            points.forEach(point => {
                totalDistance += calculateHaversineDistance(
                    optimalLat, optimalLng,
                    point.position.lat, point.position.lng
                );
            });
            
            const avgDistance = totalDistance / points.length;
            
            const info = `
                <div style="direction: rtl; text-align: right; padding: 20px; background: white; color: black; border-radius: 15px;">
                    <h3 style="color: #667eea; margin-bottom: 15px;">الموقع الأمثل</h3>
                    <p><strong>الإحداثيات:</strong> ${optimalLat.toFixed(6)}, ${optimalLng.toFixed(6)}</p>
                    <p><strong>متوسط المسافة:</strong> ${(avgDistance/1000).toFixed(2)} كم</p>
                </div>
            `;
            
            optimalMarker.bindPopup(info).openPopup();
            
            map.setView([optimalLat, optimalLng], 12);
            
            showMessage('تم تحديد الموقع الأمثل', 'success');
        }
        
        // === وظائف الخريطة ===
        
        // الوضع الليلي
        function toggleNightMode() {
            document.body.classList.toggle('night-mode');
            showMessage('تم تغيير الوضع الليلي', 'info');
        }
        
        // تغيير نوع الخريطة
        function toggleMapType() {
            const layers = ['osm', 'satellite', 'terrain', 'dark', 'watercolor'];
            const currentIndex = layers.findIndex(layer => map.layers[layer] === currentLayer);
            const nextIndex = (currentIndex + 1) % layers.length;
            const nextLayer = layers[nextIndex];
            
            if (currentLayer) {
                map.removeLayer(currentLayer);
            }
            currentLayer = map.layers[nextLayer];
            currentLayer.addTo(map);
            
            showMessage('تم تغيير نوع الخريطة', 'info');
        }
        
        // ملء الشاشة
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }
        
        // تكبير
        function zoomIn() {
            map.zoomIn();
        }
        
        // تصغير
        function zoomOut() {
            map.zoomOut();
        }
        
        // إعادة تعيين العرض
        function resetView() {
            map.setView([31.2, 29.9], 7);
        }
        
        // تحديد موقع المستخدم
        function locateUser() {
            map.locate({setView: true, maxZoom: 16});
        }
        
        // تصدير البيانات
        function exportData() {
            if (points.length === 0) {
                showMessage('لا توجد بيانات للتصدير', 'error');
                return;
            }
            
            const geojson = {
                type: "FeatureCollection",
                features: points.map(point => ({
                    type: "Feature",
                    properties: {
                        name: point.name,
                        description: point.description,
                        count: point.count,
                        number: point.number,
                        azmith: point.azmith
                    },
                    geometry: {
                        type: "Point",
                        coordinates: [point.position.lng, point.position.lat]
                    }
                }))
            };
            
            const dataStr = JSON.stringify(geojson, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = 'kml_reader_data.geojson';
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showMessage('تم تصدير البيانات بنجاح', 'success');
        }
        
        // تصدير التقرير
        function exportReport() {
            showMessage('جاري تصدير التقرير...', 'info');
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // إضافة العنوان
            doc.setFontSize(20);
            doc.text('تقرير إحصائي - قارئ ملفات KML', 105, 20, { align: 'center' });
            
            // إضافة التاريخ
            doc.setFontSize(12);
            doc.text(`التاريخ: ${new Date().toLocaleDateString('ar-SA')}`, 20, 35);
            
            // إضافة الإحصائيات
            doc.setFontSize(16);
            doc.text('الإحصائيات العامة:', 20, 50);
            
            doc.setFontSize(12);
            doc.text(`إجمالي النقاط: ${points.length}`, 30, 65);
            doc.text(`إجمالي المسارات: ${routes.length}`, 30, 75);
            doc.text(`متوسط المسافة: ${document.getElementById('reportAvgDistance').textContent} كم`, 30, 85);
            doc.text(`أقصى مسافة: ${document.getElementById('reportMaxDistance').textContent} كم`, 30, 95);
            
            // حفظ الملف
            doc.save('تقرير_احصائي.pdf');
            
            showMessage('تم تصدير التقرير بنجاح', 'success');
        }
        
        // طباعة التقرير
        function printReport() {
            window.print();
        }
        
        // مشاركة الخريطة
        function shareMap() {
            const center = map.getCenter();
            const zoom = map.getZoom();
            const shareUrl = `${window.location.origin}${window.location.pathname}?lat=${center.lat}&lng=${center.lng}&zoom=${zoom}`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'قارئ ملفات KML',
                    text: 'شاهد هذه الخريطة المذهلة',
                    url: shareUrl
                });
            } else {
                navigator.clipboard.writeText(shareUrl);
                showMessage('تم نسخ رابط المشاركة', 'success');
            }
        }
        
        // طباعة الخريطة
        function printMap() {
            window.print();
        }
        
        // حفظ صورة
        function saveScreenshot() {
            showMessage('جاري حفظ الصورة...', 'info');
            
            html2canvas(document.querySelector('.map-section')).then(canvas => {
                const link = document.createElement('a');
                link.download = 'خريطة.png';
                link.href = canvas.toDataURL();
                link.click();
                
                showMessage('تم حفظ الصورة بنجاح', 'success');
            });
        }
        
        // تحميل من رابط
        function loadFromUrl() {
            const url = prompt('أدخل رابط ملف KML:');
            if (url) {
                fetch(url)
                    .then(response => response.text())
                    .then(data => parseKMLData(data))
                    .catch(error => showMessage('فشل تحميل الملف', 'error'));
            }
        }
        
        // تحميل بيانات تجريبية
        function loadSampleData() {
            const sampleKML = `<?xml version="1.0" encoding="UTF-8"?>
            <kml xmlns="http://www.opengis.net/kml/2.2">
                <Document>
                    <Placemark>
                        <name>3099138</name>
                        <description>Count: 747
CELL_ADDRESS: Alexandria, Alex.- Matrooh Road, 6th October Village, El Nakheel Beach, First Right St., Third Left One, 6th October Exchange., اعلي سنترال 6 اكتوبر قريه النخيل - طريق الاسكندريه مطروح Alexandria, Alex.- Matrooh Road, 6th October Village, El Nakheel Beach, First Right St., Third Left One, 6th October Exchange.,
AZMITH: 210</description>
                        <Point>
                            <coordinates>29.7342419283,31.0857684171,0.0</coordinates>
                        </Point>
                    </Placemark>
                    <Placemark>
                        <name>5169410</name>
                        <description>Count: 291
CELL_ADDRESS: LORAN- Alexandria  12شارع محمد درى باشا - لوران - الإسكندرية LORAN- Alexandria
AZMITH: 200</description>
                        <Point>
                            <coordinates>29.9753969078,31.2451103216,0.0</coordinates>
                        </Point>
                    </Placemark>
                    <Placemark>
                        <name>5134593</name>
                        <description>Count: 265
CELL_ADDRESS: Alexandria, SIdi Beshr Qebly, Street No. 63, Building No. 14, Crossing Mohamed Farid St. شارع 63 من شارع محمد فريد - سيدى بشر- الاسكندرية 63 St. From Mohamed Farid St. - Sidi Bishr Kebly - Ethad Molak EL Amir
AZMITH: 15</description>
                        <Point>
                            <coordinates>30.0020272225,31.2555993815,0.0</coordinates>
                        </Point>
                    </Placemark>
                    <Placemark>
                        <name>2831105</name>
                        <description>Count: 256
CELL_ADDRESS: Inside Marina Village - between gate 2 &amp; 3 Shanzeliseh الشانزليزية خلف النساجون الشرقيون منطقة 4 قرية مارينا  - طريق اسكندرية مطروح - الاسكندرية Inside Marina Village - Between Gate 2 &amp; 3 Shanzeliseh
AZMITH: 15</description>
                        <Point>
                            <coordinates>29.0420628528,30.8153236605,0.0</coordinates>
                        </Point>
                    </Placemark>
                </Document>
            </kml>`;
            
            parseKMLData(sampleKML);
        }
        
        // مسح جميع البيانات
        function clearAllData() {
            if (confirm('هل أنت متأكد من مسح جميع البيانات؟')) {
                clearMap();
                showMessage('تم مسح جميع البيانات', 'success');
            }
        }
        
        // مسح الخريطة
        function clearMap() {
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
            points = [];
            routes.forEach(route => {
                if (route.line) {
                    map.removeLayer(route.line);
                }
            });
            routes = [];
            clearDistanceLine();
            clearRouteLine();
            if (heatLayer) {
                map.removeLayer(heatLayer);
                heatLayer = null;
            }
            updateStats();
            updatePointSelectors();
        }
        
        // عرض الرسائل
        function showMessage(text, type = 'info') {
            const message = document.createElement('div');
            message.className = `message ${type}`;
            message.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'}"></i> ${text}`;
            
            document.body.appendChild(message);
            
            setTimeout(() => {
                message.style.animation = 'slideUp 0.5s ease';
                setTimeout(() => message.remove(), 500);
            }, 3000);
        }
        
        // === 100 خيار متقدم ===
        
        // أدوات القياس
        function measureArea() {
            showMessage('تم تفعيل قياس المساحة', 'info');
        }
        
        // إدارة النقاط
        function showFrequencyAnalysis() {
            showMessage('جاري تحليل التردد...', 'info');
        }
        
        // أدوات متقدمة
        function showDirectionAnalysis() {
            showMessage('جاري تحليل الاتجاهات...', 'info');
        }
        
        function showTimeAnalysis() {
            showMessage('جاري تحليل الزمني...', 'info');
        }
        
        function showPatternAnalysis() {
            showMessage('جاري تحليل الأنماط...', 'info');
        }
        
        function showClusterAnalysis() {
            showMessage('جاري تحليل العناقيد...', 'info');
        }
        
        function showCorrelationAnalysis() {
            showMessage('جاري تحليل الارتباط...', 'info');
        }
        
        // أنواع الخرائط
        function switchToOSM() {
            changeMapLayer();
            document.getElementById('mapLayerSelect').value = 'osm';
        }
        
        function switchToSatellite() {
            changeMapLayer();
            document.getElementById('mapLayerSelect').value = 'satellite';
        }
        
        function switchToTerrain() {
            changeMapLayer();
            document.getElementById('mapLayerSelect').value = 'terrain';
        }
        
        function switchToDark() {
            changeMapLayer();
            document.getElementById('mapLayerSelect').value = 'dark';
        }
        
        function switchToWatercolor() {
            changeMapLayer();
            document.getElementById('mapLayerSelect').value = 'watercolor';
        }
        
        // البحث والتصفية
        function searchByCount() {
            showMessage('تم تفعيل البحث بالعدد', 'info');
        }
        
        function searchByDirection() {
            showMessage('تم تفعيل البحث بالاتجاه', 'info');
        }
        
        function searchByLocation() {
            showMessage('تم تفعيل البحث بالموقع', 'info');
        }
        
        function advancedSearch() {
            showMessage('تم تفعيل البحث المتقدم', 'info');
        }
        
        function filterByRange() {
            showMessage('تم تفعيل التصفية بالنطاق', 'info');
        }
        
        // الطبقات والعرض
        function toggleGrid() {
            showMessage('تم تبديل الشبكة', 'info');
        }
        
        function toggleScale() {
            showMessage('تم تبديل المقياس', 'info');
        }
        
        function toggleLabels() {
            showMessage('تم تبديل العلامات', 'info');
        }
        
        function toggleClusters() {
            showMessage('تم تبديل العناقيد', 'info');
        }
        
        function toggleHeatmap() {
            showHeatmap();
        }
        
        // أدوات الرسم
        function activateDrawMode() {
            showMessage('تم تفعيل وضع الرسم', 'info');
        }
        
        function activateEditMode() {
            showMessage('تم تفعيل وضع التعديل', 'info');
        }
        
        function activateDeleteMode() {
            showMessage('تم تفعيل وضع الحذف', 'info');
        }
        
        function activateTextMode() {
            showMessage('تم تفعيل وضع النص', 'info');
        }
        
        function activateShapeMode() {
            showMessage('تم تفعيل وضع الأشكال', 'info');
        }
        
        // الحسابات المتقدمة
        function calculateCenter() {
            showMessage('جاري حساب المركز...', 'info');
        }
        
        function calculateRadius() {
            showMessage('جاري حساب نصف القطر...', 'info');
        }
        
        function calculatePerimeter() {
            showMessage('جاري حساب المحيط...', 'info');
        }
        
        function calculateDensity() {
            showMessage('جاري حساب الكثافة...', 'info');
        }
        
        function calculateCoverage() {
            showMessage('جاري حساب التغطية...', 'info');
        }
        
        // الرسوم البيانية
        function showBarChart() {
            showMessage('جاري عرض الرسم البياني بالأعمدة...', 'info');
        }
        
        function showLineChart() {
            showMessage('جاري عرض الرسم البياني بالخطوط...', 'info');
        }
        
        function showPieChart() {
            showMessage('جاري عرض الرسم البياني الدائري...', 'info');
        }
        
        function showScatterChart() {
            showMessage('جاري عرض الرسم البياني المبعثر...', 'info');
        }
        
        function showAreaChart() {
            showMessage('جاري عرض الرسم البياني المساحي...', 'info');
        }
        
        // التصدير والاستيراد
        function exportToCSV() {
            showMessage('جاري تصدير CSV...', 'info');
        }
        
        function exportToExcel() {
            showMessage('جاري تصدير Excel...', 'info');
        }
        
        function exportToJSON() {
            exportData();
        }
        
        function exportToXML() {
            showMessage('جاري تصدير XML...', 'info');
        }
        
        function exportToKML() {
            showMessage('جاري تصدير KML...', 'info');
        }
        
        // المزامنة والنسخ الاحتياطي
        function syncToCloud() {
            showMessage('جاري المزامنة مع السحابة...', 'info');
        }
        
        function createBackup() {
            showMessage('جاري إنشاء نسخة احتياطية...', 'info');
        }
        
        function restoreBackup() {
            showMessage('جاري استعادة النسخة الاحتياطية...', 'info');
        }
        
        function autoSync() {
            showMessage('تم تفعيل المزامنة التلقائية', 'info');
        }
        
        function scheduleSync() {
            showMessage('جاري جدولة المزامنة...', 'info');
        }
        
        // الإعدادات المتقدمة
        function openSettings() {
            showMessage('جاري فتح الإعدادات العامة...', 'info');
        }
        
        function openMapSettings() {
            showMessage('جاري فتح إعدادات الخريطة...', 'info');
        }
        
        function openDisplaySettings() {
            showMessage('جاري فتح إعدادات العرض...', 'info');
        }
        
        function openPerformanceSettings() {
            showMessage('جاري فتح إعدادات الأداء...', 'info');
        }
        
        function openSecuritySettings() {
            showMessage('جاري فتح إعدادات الأمان...', 'info');
        }
        
        // المساعدة والدعم
        function showHelp() {
            showMessage('جاري عرض المساعدة...', 'info');
        }
        
        function showTutorial() {
            showMessage('جاري عرض الدورة التعليمية...', 'info');
        }
        
        function showFAQ() {
            showMessage('جاري عرض الأسئلة الشائعة...', 'info');
        }
        
        function showAbout() {
            showMessage('قارئ ملفات KML المحترف - الإصدار 1.0', 'info');
        }
        
        function contactSupport() {
            showMessage('جاري الاتصال بالدعم...', 'info');
        }
        
        // الميزات السحرية
        function magicZoom() {
            showMessage('تم تفعيل التكبير السحري', 'info');
        }
        
        function magicPan() {
            showMessage('تم تفعيل التحريك السحري', 'info');
        }
        
        function magicSelect() {
            showMessage('تم تفعيل التحديد السحري', 'info');
        }
        
        function magicFilter() {
            showMessage('تم تفعيل التصفية السحرية', 'info');
        }
        
        function magicSort() {
            showMessage('تم تفعيل الترتيب السحري', 'info');
        }
        
        // الذكاء الاصطناعي
        function aiAnalysis() {
            showMessage('جاري التحليل الذكي...', 'info');
        }
        
        function aiPrediction() {
            showMessage('جاري التنبؤ الذكي...', 'info');
        }
        
        function aiOptimization() {
            showMessage('جاري التحسين الذكي...', 'info');
        }
        
        function aiClassification() {
            showMessage('جاري التصنيف الذكي...', 'info');
        }
        
        function aiRecommendation() {
            showMessage('جاري إنشاء التوصيات الذكية...', 'info');
        }
        
        // الألعاب والتحديات
        function startQuiz() {
            showMessage('جاري بدء اختبار المعرفة...', 'info');
        }
        
        function startChallenge() {
            showMessage('جاري بدء التحدي اليومي...', 'info');
        }
        
        function startPuzzle() {
            showMessage('جاري بدء لغز الخريطة...', 'info');
        }
        
        function startRace() {
            showMessage('جاري بدء سباق الخريطة...', 'info');
        }
        
        function startTreasureHunt() {
            showMessage('جاري بدء بحث عن الكنز...', 'info');
        }
        
        // التخصيص والمظهر
        function changeTheme() {
            showMessage('جاري تغيير الثيم...', 'info');
        }
        
        function changeColors() {
            showMessage('جاري تغيير الألوان...', 'info');
        }
        
        function changeFonts() {
            showMessage('جاري تغيير الخطوط...', 'info');
        }
        
        function changeIcons() {
            showMessage('جاري تغيير الأيقونات...', 'info');
        }
        
        function changeLayout() {
            showMessage('جاري تغيير التخطيط...', 'info');
        }
        
        // اختصارات لوحة المفاتيح
        function showShortcuts() {
            showMessage('جاري عرض الاختصارات...', 'info');
        }
        
        function customizeShortcuts() {
            showMessage('جاري تخصيص الاختصارات...', 'info');
        }
        
        function recordMacro() {
            showMessage('جاري تسجيل الماكرو...', 'info');
        }
        
        function playMacro() {
            showMessage('جاري تشغيل الماكرو...', 'info');
        }
        
        function editMacro() {
            showMessage('جاري تعديل الماكرو...', 'info');
        }
        
        // الإضافات والامتدادات
        function managePlugins() {
            showMessage('جاري إدارة الإضافات...', 'info');
        }
        
        function installPlugin() {
            showMessage('جاري تثبيت الإضافة...', 'info');
        }
        
        function removePlugin() {
            showMessage('جاري إزالة الإضافة...', 'info');
        }
        
        function updatePlugin() {
            showMessage('جاري تحديث الإضافة...', 'info');
        }
        
        function browsePlugins() {
            showMessage('جاري تصفح الإضافات...', 'info');
        }
        
        // التعاون والمشاركة
        function shareProject() {
            shareMap();
        }
        
        function collaborate() {
            showMessage('جاري تفعيل التعاون...', 'info');
        }
        
        function inviteUsers() {
            showMessage('جاري دعوة مستخدمين...', 'info');
        }
        
        function managePermissions() {
            showMessage('جاري إدارة الصلاحيات...', 'info');
        }
        
        function viewActivity() {
            showMessage('جاري عرض النشاط...', 'info');
        }
        
        // الأمان والخصوصية
        function encryptData() {
            showMessage('جاري تشفير البيانات...', 'info');
        }
        
        function setPassword() {
            showMessage('جاري تعيين كلمة المرور...', 'info');
        }
        
        function enable2FA() {
            showMessage('جاري تفعيل المصادقة الثنائية...', 'info');
        }
        
        function privacySettings() {
            showMessage('جاري فتح إعدادات الخصوصية...', 'info');
        }
        
        function securityAudit() {
            showMessage('جاري إجراء التدقيق الأمني...', 'info');
        }
        
        // إدارة البيانات
        function cleanData() {
            showMessage('جاري تنظيف البيانات...', 'info');
        }
        
        function optimizeData() {
            showMessage('جاري تحسين البيانات...', 'info');
        }
        
        function validateData() {
            showMessage('جاري التحقق من البيانات...', 'info');
        }
        
        function mergeData() {
            showMessage('جاري دمج البيانات...', 'info');
        }
        
        function splitData() {
            showMessage('جاري تقسيم البيانات...', 'info');
        }
        
        // الأتمتة والجدولة
        function scheduleTask() {
            showMessage('جاري جدولة المهمة...', 'info');
        }
        
        function createWorkflow() {
            showMessage('جاري إنشاء سير العمل...', 'info');
        }
        
        function automateProcess() {
            showMessage('جاري أتمتة العملية...', 'info');
        }
        
        function monitorTasks() {
            showMessage('جاري مراقبة المهام...', 'info');
        }
        
        function viewLogs() {
            showMessage('جاري عرض السجلات...', 'info');
        }
        
        // الخرائط العالمية
        function switchToWorldMap() {
            showMessage('جاري التبديل إلى خريطة العالم...', 'info');
        }
        
        function switchToContinentMap() {
            showMessage('جاري التبديل إلى خريطة القارات...', 'info');
        }
        
        function switchToCountryMap() {
            showMessage('جاري التبديل إلى خريطة الدول...', 'info');
        }
        
        function switchToCityMap() {
            showMessage('جاري التبديل إلى خريطة المدن...', 'info');
        }
        
        function switchToStreetMap() {
            showMessage('جاري التبديل إلى خريطة الشوارع...', 'info');
        }
        
        // حساب جميع المسافات
        function calculateAllDistances() {
            if (points.length < 2) {
                showMessage('يجب أن يكون هناك نقطتان على الأقل', 'error');
                return;
            }
            
            let totalDistance = 0;
            let minDistance = Infinity;
            let maxDistance = 0;
            let closestPair = null;
            let farthestPair = null;
            
            for (let i = 0; i < points.length; i++) {
                for (let j = i + 1; j < points.length; j++) {
                    const distance = calculateHaversineDistance(
                        points[i].position.lat, points[i].position.lng,
                        points[j].position.lat, points[j].position.lng
                    );
                    
                    totalDistance += distance;
                    
                    if (distance < minDistance) {
                        minDistance = distance;
                        closestPair = [i, j];
                    }
                    
                    if (distance > maxDistance) {
                        maxDistance = distance;
                        farthestPair = [i, j];
                    }
                }
            }
            
            const avgDistance = totalDistance / (points.length * (points.length - 1) / 2);
            
            const stats = `
                <div style="direction: rtl; text-align: right; padding: 25px; background: white; color: black; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
                    <h3 style="color: #667eea; margin-bottom: 20px; font-size: 1.5rem;">إحصائيات المسافات</h3>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px;">
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 10px;">
                            <strong style="color: #4ECDC4;">متوسط المسافة:</strong><br>
                            ${(avgDistance/1000).toFixed(2)} كم
                        </div>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 10px;">
                            <strong style="color: #4ECDC4;">إجمالي المسافات:</strong><br>
                            ${(totalDistance/1000).toFixed(2)} كم
                        </div>
                    </div>
                    <div style="background: #e3f2fd; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                        <strong style="color: #2196F3;">أقرب نقطتين:</strong><br>
                        ${points[closestPair[0]].name} و ${points[closestPair[1]].name}<br>
                        <small>المسافة: ${(minDistance/1000).toFixed(2)} كم</small>
                    </div>
                    <div style="background: #ffebee; padding: 15px; border-radius: 10px;">
                        <strong style="color: #f44336;">أبعد نقطتين:</strong><br>
                        ${points[farthestPair[0]].name} و ${points[farthestPair[1]].name}<br>
                        <small>المسافة: ${(maxDistance/1000).toFixed(2)} كم</small>
                    </div>
                </div>
            `;
            
            L.popup()
                .setLatLng(map.getCenter())
                .setContent(stats)
                .openOn(map);
        }
        
        // عرض مصفوفة المسافات
        function showDistanceMatrix() {
            if (points.length < 2) {
                showMessage('يجب أن يكون هناك نقطتان على الأقل', 'error');
                return;
            }
            
            let matrixHTML = '<table style="width: 100%; border-collapse: collapse; direction: rtl;">';
            matrixHTML += '<tr><th style="border: 1px solid #ddd; padding: 8px; background: #4ECDC4; color: white;">النقطة</th>';
            
            points.forEach((point, i) => {
                matrixHTML += `<th style="border: 1px solid #ddd; padding: 8px; background: #4ECDC4; color: white;">${point.count}</th>`;
            });
            matrixHTML += '</tr>';
            
            points.forEach((point1, i) => {
                matrixHTML += `<tr><td style="border: 1px solid #ddd; padding: 8px; background: #f8f9fa; font-weight: bold;">${point1.count}</td>`;
                
                points.forEach((point2, j) => {
                    if (i === j) {
                        matrixHTML += '<td style="border: 1px solid #ddd; padding: 8px; text-align: center; background: #e9ecef;">-</td>';
                    } else {
                        const distance = calculateHaversineDistance(
                            point1.position.lat, point1.position.lng,
                            point2.position.lat, point2.position.lng
                        );
                        matrixHTML += `<td style="border: 1px solid #ddd; padding: 8px; text-align: center;">${(distance/1000).toFixed(1)}</td>`;
                    }
                });
                
                matrixHTML += '</tr>';
            });
            
            matrixHTML += '</table>';
            
            const matrixContent = `
                <div style="direction: rtl; text-align: right; padding: 25px; background: white; color: black; border-radius: 15px; max-width: 800px; max-height: 600px; overflow: auto;">
                    <h3 style="color: #667eea; margin-bottom: 20px; font-size: 1.5rem;">مصفوفة المسافات (كم)</h3>
                    ${matrixHTML}
                </div>
            `;
            
            L.popup()
                .setLatLng(map.getCenter())
                .setContent(matrixContent)
                .openOn(map);
        }
        
        // تصدير إلى PDF
        function exportToPDF() {
            saveScreenshot();
        }
        
        // === تهيئة الخريطة عند تحميل الصفحة ===
        window.onload = function() {
            initMap();
            
            // التحقق من وجود معلمات في الرابط
            const urlParams = new URLSearchParams(window.location.search);
            const lat = urlParams.get('lat');
            const lng = urlParams.get('lng');
            const zoom = urlParams.get('zoom');
            
            if (lat && lng) {
                map.setView([parseFloat(lat), parseFloat(lng)], zoom ? parseInt(zoom) : 10);
            }
        };
    </script>
</body>
</html>
